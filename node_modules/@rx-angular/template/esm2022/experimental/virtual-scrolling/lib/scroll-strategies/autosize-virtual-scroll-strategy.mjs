import { Directive, inject, Input, } from '@angular/core';
import { coalesceWith } from '@rx-angular/cdk/coalescing';
import { combineLatest, merge, pairwise, ReplaySubject, Subject, } from 'rxjs';
import { distinctUntilChanged, exhaustMap, filter, finalize, groupBy, map, mergeMap, startWith, switchMap, takeUntil, takeWhile, tap, } from 'rxjs/operators';
import { RxVirtualScrollStrategy, } from '../model';
import { calculateVisibleContainerSize, parseScrollTopBoundaries, toBoolean, unpatchedMicroTask, } from '../util';
import { RX_VIRTUAL_SCROLL_DEFAULT_OPTIONS } from '../virtual-scroll.config';
import { RxaResizeObserver } from './resize-observer';
import * as i0 from "@angular/core";
const defaultSizeExtract = (entry) => entry.borderBoxSize[0].blockSize;
/**
 * @Directive AutosizeVirtualScrollStrategy
 *
 * @description
 *
 * The `AutosizeVirtualScrollStrategy` provides a twitter-like virtual-scrolling
 * experience. It is able to render and position items based on their individual
 * size. It is comparable to \@angular/cdk/experimental `AutosizeVirtualScrollStrategy`, but
 * with a high performant layouting technique and more features.
 *
 * On top of this the `AutosizeVirtualScrollStrategy` is leveraging the native
 * `ResizeObserver` in order to detect size changes for each individual view
 * rendered to the DOM and properly re-position accordingly.
 *
 * In order to provide top-notch runtime performance the `AutosizeVirtualScrollStrategy`
 * builds up caches that prevent DOM interactions whenever possible. Once a view
 * was visited, its properties will be stored instead of re-read from the DOM again as
 * this can potentially lead to unwanted forced reflows.
 *
 * @docsCategory RxVirtualFor
 * @docsPage RxVirtualFor
 * @publicApi
 */
export class AutoSizeVirtualScrollStrategy extends RxVirtualScrollStrategy {
    defaults = inject(RX_VIRTUAL_SCROLL_DEFAULT_OPTIONS, {
        optional: true,
    });
    /**
     * @description
     * The amount of items to render upfront in scroll direction
     */
    runwayItems = this.defaults?.runwayItems ?? 10;
    /**
     * @description
     * The amount of items to render upfront in reverse scroll direction
     */
    runwayItemsOpposite = this.defaults?.runwayItemsOpposite ?? 2;
    /**
     * @description
     * The default size of the items being rendered. The autosized strategy will assume
     * this size for items it doesn't know yet. For the smoothest experience,
     * you provide the mean size of all items being rendered - if possible of course.
     *
     * As soon as rxVirtualFor is able to also render actual tombstone items, this
     * will be the size of a tombstone item being rendered before the actual item
     * is inserted into its position.
     */
    tombstoneSize = this.defaults?.itemSize ?? 50;
    /**
     * @description
     * The autosized strategy uses the native ResizeObserver in order to determine
     * if an item changed in size to afterwards properly position the views.
     * You can customize the config passed to the ResizeObserver as well as determine
     * which result property to use when determining the views size.
     */
    resizeObserverConfig;
    /**
     * @description
     * When enabled, the autosized scroll strategy attaches a `ResizeObserver`
     * to every view within the given renderedRange. If your views receive
     * dimension changes that are not caused by list updates, this is a way to
     * still track height changes. This also applies to resize events of the whole
     * document.
     */
    withResizeObserver = true;
    /**
     * @description
     * When enabled, the scroll strategy stops removing views from the viewport,
     * instead it only adds views. This setting can be changed on the fly. Views will be added in both directions
     * according to the user interactions.
     */
    appendOnly = false;
    /**
     * @description
     * When enabled, the autosized scroll strategy removes css styles that
     * prevent the scrollbar from being in sync with the input device.
     * Use with caution, as this can lead to extremely weird scroll behavior
     * on chromium based browsers when the rendered views differ
     * in dimensions too much or change dimensions heavily.
     */
    withSyncScrollbar = false;
    /**
     * @description
     * If this flag is true, the virtual scroll strategy maintains the scrolled item when new data
     * is prepended to the list. This is very useful when implementing a reversed infinite scroller, that prepends
     * data instead of appending it
     */
    keepScrolledIndexOnPrepend = false;
    /** @internal */
    viewport = null;
    /** @internal */
    viewRepeater = null;
    /** @internal */
    _contentSize$ = new ReplaySubject(1);
    /** @internal */
    contentSize$ = this._contentSize$.asObservable();
    /** @internal */
    _contentSize = 0;
    /** @internal */
    set contentSize(size) {
        this._contentSize = size;
        this._contentSize$.next(size);
    }
    get contentSize() {
        return this._contentSize;
    }
    /** @internal */
    _renderedRange$ = new Subject();
    /** @internal */
    renderedRange$ = this._renderedRange$.asObservable();
    /** @internal */
    _renderedRange = { start: 0, end: 0 };
    /** @internal */
    set renderedRange(range) {
        this._renderedRange = range;
        this._renderedRange$.next(range);
    }
    /** @internal */
    get renderedRange() {
        return this._renderedRange;
    }
    /** @internal */
    positionedRange = { start: 0, end: 0 };
    /** @internal */
    _scrolledIndex$ = new ReplaySubject(1);
    /** @internal */
    scrolledIndex$ = this._scrolledIndex$.pipe(distinctUntilChanged());
    /** @internal */
    _scrolledIndex = 0;
    /** @internal */
    get scrolledIndex() {
        return this._scrolledIndex;
    }
    /** @internal */
    set scrolledIndex(index) {
        this._scrolledIndex = index;
        this._scrolledIndex$.next(index);
    }
    /**
     * is set, when scrollToIndex is called
     * @internal
     * */
    _scrollToIndex = null;
    /** @internal */
    containerSize = 0;
    /** @internal */
    contentLength = 0;
    /** @internal */
    _virtualItems = [];
    /** @internal */
    scrollTop = 0;
    /** @internal */
    scrollTopWithOutOffset = 0;
    /** @internal */
    scrollTopAfterOffset = 0;
    /** @internal */
    viewportOffset = 0;
    /** @internal */
    direction = 'down';
    /** @internal */
    anchorScrollTop = 0;
    /** @internal */
    anchorItem = {
        index: 0,
        offset: 0,
    };
    /** @internal */
    lastScreenItem = {
        index: 0,
        offset: 0,
    };
    /** @internal */
    waitForScroll = false;
    /** @internal */
    isStable$ = new ReplaySubject(1);
    /** @internal */
    detached$ = new Subject();
    /** @internal */
    resizeObserver = inject(RxaResizeObserver, { self: true });
    /** @internal */
    recalculateRange$ = new Subject();
    /** @internal */
    until$() {
        return (o$) => o$.pipe(takeUntil(this.detached$));
    }
    /** @internal */
    get extractSize() {
        return this.resizeObserverConfig?.extractSize ?? defaultSizeExtract;
    }
    /** @internal */
    get isStable() {
        return this.isStable$.pipe(filter((w) => w));
    }
    /** @internal */
    ngOnChanges(changes) {
        if ((changes['runwayItemsOpposite'] &&
            !changes['runwayItemsOpposite'].firstChange) ||
            (changes['runwayItems'] && !changes['runwayItems'].firstChange)) {
            this.recalculateRange$.next();
        }
        if (changes['withSyncScrollbar']) {
            this.updateScrollElementClass();
        }
    }
    /** @internal */
    ngOnDestroy() {
        this.detach();
    }
    /** @internal */
    attach(viewport, viewRepeater) {
        this.viewport = viewport;
        this.viewRepeater = viewRepeater;
        this.updateScrollElementClass();
        this.maintainVirtualItems();
        this.calcRenderedRange();
        this.positionElements();
    }
    /** @internal */
    detach() {
        this.updateScrollElementClass(false);
        this.viewport = null;
        this.viewRepeater = null;
        this._virtualItems = [];
        this.resizeObserver.destroy();
        this.detached$.next();
    }
    scrollToIndex(index, behavior) {
        const _index = Math.min(Math.max(index, 0), Math.max(0, this.contentLength - 1));
        if (_index !== this.scrolledIndex) {
            const scrollTop = this.calcInitialPosition(_index);
            this._scrollToIndex = _index;
            this.scrollTo(scrollTop, behavior);
        }
    }
    scrollTo(scrollTo, behavior) {
        this.waitForScroll =
            scrollTo !== this.scrollTop && this.contentSize > this.containerSize;
        if (this.waitForScroll) {
            this.isStable$.next(false);
        }
        this.viewport.scrollTo(this.viewportOffset + scrollTo, behavior);
    }
    /**
     * starts the subscriptions that maintain the virtualItems array on changes
     * to the underlying dataset
     * @internal
     */
    maintainVirtualItems() {
        // reset virtual viewport when opposite orientation to the scroll direction
        // changes, as we have to expect dimension changes for all items when this
        // happens. This could also be configurable as it maybe costs performance
        this.viewport.containerRect$.pipe(map(({ width }) => width), distinctUntilChanged(), filter(() => this.renderedRange.end > 0 && this._virtualItems.length > 0), this.until$()).subscribe(() => {
            // reset because we have no idea how items will behave
            let i = 0;
            while (i < this.renderedRange.start) {
                this._virtualItems[i].cached = false;
                i++;
            }
            i = this.renderedRange.end;
            while (i < this.contentLength - 1) {
                this._virtualItems[i].cached = false;
                i++;
            }
        });
        // synchronises the values with the virtual viewport we've built up
        // it might get costy when having > 100k elements, it's still faster than
        // the IterableDiffer approach, especially on move operations
        const itemCache = new Map();
        const trackBy = this.viewRepeater._trackBy ?? ((i, item) => item);
        this.renderedRange$
            .pipe(pairwise(), this.until$())
            .subscribe(([oldRange, newRange]) => {
            let i = oldRange.start;
            if (i < this._virtualItems.length) {
                for (i; i < Math.min(this._virtualItems.length, oldRange.end); i++) {
                    if (i < newRange.start || i >= newRange.end) {
                        this._virtualItems[i].position = undefined;
                    }
                }
            }
        });
        this.viewRepeater.values$.pipe(this.until$(), tap((values) => {
            const dataArr = Array.isArray(values)
                ? values
                : values
                    ? Array.from(values)
                    : [];
            const existingIds = new Set();
            let size = 0;
            const dataLength = dataArr.length;
            const virtualItems = new Array(dataLength);
            let anchorItemIndex = this.anchorItem.index;
            const keepScrolledIndexOnPrepend = this.keepScrolledIndexOnPrepend &&
                dataArr.length > 0 &&
                itemCache.size > 0;
            for (let i = 0; i < dataLength; i++) {
                const item = dataArr[i];
                const id = trackBy(i, item);
                const cachedItem = itemCache.get(id);
                if (cachedItem === undefined) {
                    // add
                    virtualItems[i] = { size: 0 };
                    itemCache.set(id, { item: dataArr[i], index: i });
                    if (i <= anchorItemIndex) {
                        anchorItemIndex++;
                    }
                }
                else if (cachedItem.index !== i) {
                    // move
                    virtualItems[i] = this._virtualItems[cachedItem.index];
                    virtualItems[i].position = undefined;
                    itemCache.set(id, { item: dataArr[i], index: i });
                }
                else {
                    // update
                    // todo: properly determine update (Object.is?)
                    virtualItems[i] = this._virtualItems[i];
                    // if index is not part of rendered range, remove cache
                    if (!this.withResizeObserver ||
                        i < this.renderedRange.start ||
                        i >= this.renderedRange.end) {
                        virtualItems[i].cached = false;
                    }
                    itemCache.set(id, { item: dataArr[i], index: i });
                }
                existingIds.add(id);
                size += virtualItems[i].size || this.tombstoneSize;
            }
            this._virtualItems = virtualItems;
            // sync delete operations
            if (itemCache.size > dataLength) {
                itemCache.forEach((v, k) => {
                    if (!existingIds.has(k)) {
                        itemCache.delete(k);
                    }
                });
            }
            existingIds.clear();
            this.contentLength = dataLength;
            if (keepScrolledIndexOnPrepend &&
                this.anchorItem.index !== anchorItemIndex) {
                this.scrollToIndex(anchorItemIndex);
            }
            else if (dataLength === 0) {
                this.anchorItem = {
                    index: 0,
                    offset: 0,
                };
                this._renderedRange = {
                    start: 0,
                    end: 0,
                };
                this.scrollTo(0);
                this.scrollTop = this.anchorScrollTop = 0;
            }
            else if (dataLength < this._renderedRange.end) {
                this.anchorItem = this.calculateAnchoredItem({
                    index: dataLength,
                    offset: 0,
                }, -calculateVisibleContainerSize(this.containerSize, this.scrollTopWithOutOffset, this.scrollTopAfterOffset));
                this.calcAnchorScrollTop();
                this._renderedRange = {
                    start: Math.max(0, this.anchorItem.index - this.runwayItems),
                    end: dataLength,
                };
                this.scrollTo(size);
                this.scrollTop = this.anchorScrollTop;
            }
            this.contentSize = size;
        }), finalize(() => itemCache.clear())).subscribe();
    }
    /**
     * listen to triggers that should change the renderedRange
     * @internal
     */
    calcRenderedRange() {
        let removeScrollAnchorOnNextScroll = false;
        const onlyTriggerWhenStable = () => (o$) => o$.pipe(filter(() => this.renderedRange.end === 0 ||
            (this.scrollTop === this.anchorScrollTop &&
                this._scrollToIndex === null)));
        combineLatest([
            this.viewport.containerRect$.pipe(map(({ height }) => {
                this.containerSize = height;
                return height;
            }), distinctUntilChanged(), onlyTriggerWhenStable()),
            this.viewport.elementScrolled$.pipe(startWith(void 0), tap(() => {
                this.viewportOffset = this.viewport.measureOffset();
                const { scrollTop, scrollTopWithOutOffset, scrollTopAfterOffset } = parseScrollTopBoundaries(this.viewport.getScrollTop(), this.viewportOffset, this._contentSize, this.containerSize);
                this.direction =
                    scrollTopWithOutOffset > this.scrollTopWithOutOffset
                        ? 'down'
                        : 'up';
                this.scrollTopWithOutOffset = scrollTopWithOutOffset;
                this.scrollTopAfterOffset = scrollTopAfterOffset;
                this.scrollTop = scrollTop;
                if (removeScrollAnchorOnNextScroll) {
                    this._scrollToIndex = null;
                    removeScrollAnchorOnNextScroll = false;
                }
                else {
                    removeScrollAnchorOnNextScroll = this._scrollToIndex !== null;
                }
                this.waitForScroll = false;
            })),
            this._contentSize$.pipe(distinctUntilChanged(), onlyTriggerWhenStable()),
            this.recalculateRange$.pipe(onlyTriggerWhenStable(), startWith(void 0)),
        ])
            .pipe(
        // make sure to not over calculate things by coalescing all triggers to the next microtask
        coalesceWith(unpatchedMicroTask()), map(() => {
            const range = { start: 0, end: 0 };
            const delta = this.scrollTop - this.anchorScrollTop;
            if (this.scrollTop === 0) {
                this.anchorItem = { index: 0, offset: 0 };
            }
            else {
                this.anchorItem = this.calculateAnchoredItem(this.anchorItem, delta);
            }
            this.anchorScrollTop = this.scrollTop;
            this.scrolledIndex = this.anchorItem.index;
            this.lastScreenItem = this.calculateAnchoredItem(this.anchorItem, calculateVisibleContainerSize(this.containerSize, this.scrollTopWithOutOffset, this.scrollTopAfterOffset));
            if (this.direction === 'up') {
                range.start = Math.max(0, this.anchorItem.index - this.runwayItems);
                range.end = Math.min(this.contentLength, this.lastScreenItem.index + this.runwayItemsOpposite);
            }
            else {
                range.start = Math.max(0, this.anchorItem.index - this.runwayItemsOpposite);
                range.end = Math.min(this.contentLength, this.lastScreenItem.index + this.runwayItems);
            }
            if (this.appendOnly) {
                range.start = Math.min(this._renderedRange.start, range.start);
                range.end = Math.max(this._renderedRange.end, range.end);
            }
            return range;
        }))
            .pipe(this.until$())
            .subscribe((range) => {
            this.renderedRange = range;
            this.isStable$.next(!this.waitForScroll);
        });
    }
    /**
     * position elements after they are created/updated/moved or their dimensions
     * change from other sources
     * @internal
     */
    positionElements() {
        const viewsToObserve$ = new Subject();
        const positionByIterableChange$ = this.viewRepeater.renderingStart$.pipe(switchMap((batchedUpdates) => {
            // initialIndex tells us what will be the first index to be change detected
            // if it's not the first one, we maybe have to adjust the position
            // of all items in the viewport before this index
            const initialIndex = batchedUpdates.size
                ? batchedUpdates.values().next().value + this.renderedRange.start
                : this.renderedRange.start;
            let position = 0;
            let scrollToAnchorPosition = null;
            return this.viewRepeater.viewRendered$.pipe(tap(({ view, index: viewIndex, item }) => {
                const itemIndex = view.context.index;
                // this most of the time causes a forced reflow per rendered view.
                // it doesn't sound good, but it's still way more stable than
                // having one large reflow in a microtask after the actual
                // scheduler tick.
                // Right here, we can insert work into the task which is currently
                // executed as part of the concurrent scheduler tick.
                // causing the forced reflow here, also makes it count for the
                // schedulers frame budget. This way we will always run with the
                // configured FPS. The only case where this is not true is when rendering 1 single view
                // already explodes the budget
                const [, sizeDiff] = this.updateElementSize(view, itemIndex);
                const virtualItem = this._virtualItems[itemIndex];
                // before positioning the first view of this batch, calculate the
                // anchorScrollTop & initial position of the view
                if (itemIndex === initialIndex) {
                    this.calcAnchorScrollTop();
                    position = this.calcInitialPosition(itemIndex);
                    // if we receive a partial update and the current views position is
                    // new, we can safely assume that all positions from views before the current
                    // index are also off. We need to adjust them
                    if (initialIndex > this.renderedRange.start &&
                        virtualItem.position !== position) {
                        let beforePosition = position;
                        let i = initialIndex - 1;
                        while (i >= this.renderedRange.start) {
                            const view = this.getViewRef(i - this.renderedRange.start);
                            const virtualItem = this._virtualItems[i];
                            const element = this.getElement(view);
                            beforePosition -= virtualItem.size;
                            virtualItem.position = beforePosition;
                            this.positionElement(element, beforePosition);
                            i--;
                        }
                    }
                }
                else if (itemIndex < this.anchorItem.index && sizeDiff) {
                    this.anchorScrollTop += sizeDiff;
                }
                const size = virtualItem.size;
                // position current element if we need to
                if (virtualItem.position !== position) {
                    const element = this.getElement(view);
                    this.positionElement(element, position);
                    virtualItem.position = position;
                }
                if (this._scrollToIndex === itemIndex) {
                    scrollToAnchorPosition = position;
                }
                position += size;
                // immediately activate the ResizeObserver after initial positioning
                viewsToObserve$.next(view);
                this.viewRenderCallback.next({
                    index: itemIndex,
                    view,
                    item,
                });
                // after positioning the actual view, we also need to position all
                // views from the current index on until either the renderedRange.end
                // is hit or we hit an index that will anyway receive an update.
                // we can derive that information from the batchedUpdates index Set
                const { lastPositionedIndex: lastIndex, position: newPosition } = this.positionUnchangedViews({
                    viewIndex,
                    itemIndex,
                    batchedUpdates,
                    position,
                });
                position = newPosition;
                this.positionedRange.start = this.renderedRange.start;
                this.positionedRange.end = lastIndex + 1;
            }), coalesceWith(unpatchedMicroTask()), tap(() => {
                this.adjustContentSize(position);
                if (this._scrollToIndex === null) {
                    this.maybeAdjustScrollPosition();
                }
                else if (scrollToAnchorPosition != null) {
                    if (scrollToAnchorPosition !== this.anchorScrollTop) {
                        if (scrollToAnchorPosition >
                            this.contentSize - this.containerSize) {
                            // if the anchorItemPosition is larger than the maximum scrollPos,
                            // we want to scroll until the bottom.
                            // of course, we need to be sure all the items until the end are positioned
                            // until we are sure that we need to scroll to the bottom
                            if (this.renderedRange.end === this.positionedRange.end) {
                                this._scrollToIndex = null;
                                this.scrollTo(this.contentSize);
                            }
                        }
                        else {
                            this._scrollToIndex = null;
                            this.scrollTo(scrollToAnchorPosition);
                        }
                    }
                    else {
                        this._scrollToIndex = null;
                        this.maybeAdjustScrollPosition();
                    }
                }
            }));
        }));
        const positionByResizeObserver$ = viewsToObserve$.pipe(filter(() => this.withResizeObserver), groupBy((viewRef) => viewRef), mergeMap((o$) => o$.pipe(exhaustMap((viewRef) => this.observeViewSize$(viewRef)), tap(([index, viewIndex]) => {
            this.calcAnchorScrollTop();
            let position = this.calcInitialPosition(index);
            let viewIdx = viewIndex;
            if (this._virtualItems[index].position !== position) {
                // we want to reposition the whole viewport, when the current position has changed
                while (viewIdx > 0) {
                    viewIdx--;
                    position -=
                        this._virtualItems[this.getViewRef(viewIdx).context.index]
                            .size;
                }
            }
            else {
                // we only need to reposition everything from the next viewIndex on
                viewIdx++;
                position += this._virtualItems[index].size;
            }
            // position all views from the specified viewIndex
            while (viewIdx < this.viewRepeater.viewContainer.length) {
                const view = this.getViewRef(viewIdx);
                const itemIndex = view.context.index;
                const virtualItem = this._virtualItems[itemIndex];
                const element = this.getElement(view);
                this.updateElementSize(view, itemIndex);
                virtualItem.position = position;
                this.positionElement(element, position);
                position += virtualItem.size;
                viewIdx++;
            }
            this.maybeAdjustScrollPosition();
        }))));
        merge(positionByIterableChange$, positionByResizeObserver$)
            .pipe(this.until$())
            .subscribe();
    }
    /** @internal */
    adjustContentSize(position) {
        let newContentSize = position;
        for (let i = this.positionedRange.end; i < this._virtualItems.length; i++) {
            newContentSize += this.getItemSize(i);
        }
        this.contentSize = newContentSize;
    }
    /** @internal */
    observeViewSize$(viewRef) {
        const element = this.getElement(viewRef);
        return this.resizeObserver
            .observeElement(element, this.resizeObserverConfig?.options)
            .pipe(takeWhile((event) => event.target.isConnected &&
            !!this._virtualItems[viewRef.context.index]), map((event) => {
            const index = viewRef.context.index;
            const size = Math.round(this.extractSize(event));
            const diff = size - this._virtualItems[index].size;
            if (diff !== 0) {
                this._virtualItems[index].size = size;
                this._virtualItems[index].cached = true;
                this.contentSize += diff;
                return [index, this.viewRepeater.viewContainer.indexOf(viewRef)];
            }
            return null;
        }), filter((diff) => diff !== null &&
            diff[0] >= this.positionedRange.start &&
            diff[0] < this.positionedRange.end), takeUntil(merge(this.viewRepeater.viewRendered$, this.viewRepeater.renderingStart$).pipe(tap(() => {
            // we need to clean up the position property for views
            // that fall out of the renderedRange.
            const index = viewRef.context.index;
            if (this._virtualItems[index] &&
                (index < this.renderedRange.start ||
                    index >= this.renderedRange.end)) {
                this._virtualItems[index].position = undefined;
            }
        }), filter(() => this.viewRepeater.viewContainer.indexOf(viewRef) === -1))));
    }
    /**
     * @internal
     * heavily inspired by
     *   https://github.com/GoogleChromeLabs/ui-element-samples/blob/gh-pages/infinite-scroller/scripts/infinite-scroll.js
     */
    calculateAnchoredItem(initialAnchor, delta) {
        if (delta === 0)
            return initialAnchor;
        delta += initialAnchor.offset;
        let i = initialAnchor.index;
        const items = this._virtualItems;
        if (delta < 0) {
            while (delta < 0 && i > 0) {
                delta += this.getItemSize(i - 1);
                i--;
            }
        }
        else {
            while (delta > 0 && i < items.length && this.getItemSize(i) <= delta) {
                delta -= this.getItemSize(i);
                i++;
            }
        }
        return {
            index: Math.min(i, items.length),
            offset: delta,
        };
    }
    /** @internal */
    positionUnchangedViews({ viewIndex, itemIndex, batchedUpdates, position, }) {
        let _viewIndex = viewIndex + 1;
        let index = itemIndex + 1;
        let lastPositionedIndex = itemIndex;
        while (!batchedUpdates.has(_viewIndex) && index < this.renderedRange.end) {
            const virtualItem = this._virtualItems[index];
            if (position !== virtualItem.position) {
                const view = this.getViewRef(_viewIndex);
                const element = this.getElement(view);
                this.positionElement(element, position);
                virtualItem.position = position;
            }
            position += virtualItem.size;
            lastPositionedIndex = index;
            index++;
            _viewIndex++;
        }
        return { position, lastPositionedIndex };
    }
    /**
     * Adjust the scroll position when the anchorScrollTop differs from
     * the actual scrollTop.
     * Trigger a range recalculation if there is empty space
     *
     * @internal
     */
    maybeAdjustScrollPosition() {
        if (this.anchorScrollTop !== this.scrollTop) {
            this.scrollTo(this.anchorScrollTop);
        }
    }
    /** @internal */
    calcAnchorScrollTop() {
        this.anchorScrollTop = 0;
        for (let i = 0; i < this.anchorItem.index; i++) {
            this.anchorScrollTop += this.getItemSize(i);
        }
        this.anchorScrollTop += this.anchorItem.offset;
    }
    /** @internal */
    calcInitialPosition(start) {
        // Calculate position of starting node
        let pos = this.anchorScrollTop - this.anchorItem.offset;
        let i = this.anchorItem.index;
        while (i > start) {
            const itemSize = this.getItemSize(i - 1);
            pos -= itemSize;
            i--;
        }
        while (i < start) {
            const itemSize = this.getItemSize(i);
            pos += itemSize;
            i++;
        }
        return pos;
    }
    /** @internal */
    getViewRef(index) {
        return (this.viewRepeater.viewContainer.get(index));
    }
    /** @internal */
    updateElementSize(view, index) {
        const oldSize = this.getItemSize(index);
        const isCached = this._virtualItems[index].cached;
        const size = isCached
            ? oldSize
            : this.getElementSize(this.getElement(view));
        this._virtualItems[index].size = size;
        this._virtualItems[index].cached = true;
        return [size, size - oldSize];
    }
    /** @internal */
    getItemSize(index) {
        return this._virtualItems[index].size || this.tombstoneSize;
    }
    /** @internal */
    getElementSize(element) {
        return element.offsetHeight;
    }
    /** @internal */
    positionElement(element, scrollTop) {
        element.style.position = 'absolute';
        element.style.transform = `translateY(${scrollTop}px)`;
    }
    /** @internal */
    updateScrollElementClass(force = this.withSyncScrollbar) {
        const scrollElement = this.viewport?.getScrollElement?.();
        if (!!scrollElement &&
            scrollElement.classList.contains('rx-virtual-scroll-element')) {
            scrollElement.classList.toggle('rx-virtual-scroll-element--withSyncScrollbar', force);
        }
    }
    /** @nocollapse */ static ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "18.0.1", ngImport: i0, type: AutoSizeVirtualScrollStrategy, deps: null, target: i0.ɵɵFactoryTarget.Directive });
    /** @nocollapse */ static ɵdir = i0.ɵɵngDeclareDirective({ minVersion: "16.1.0", version: "18.0.1", type: AutoSizeVirtualScrollStrategy, isStandalone: true, selector: "rx-virtual-scroll-viewport[autosize]", inputs: { runwayItems: "runwayItems", runwayItemsOpposite: "runwayItemsOpposite", tombstoneSize: "tombstoneSize", resizeObserverConfig: "resizeObserverConfig", withResizeObserver: ["withResizeObserver", "withResizeObserver", toBoolean], appendOnly: ["appendOnly", "appendOnly", toBoolean], withSyncScrollbar: ["withSyncScrollbar", "withSyncScrollbar", toBoolean], keepScrolledIndexOnPrepend: ["keepScrolledIndexOnPrepend", "keepScrolledIndexOnPrepend", toBoolean] }, providers: [
            {
                provide: RxVirtualScrollStrategy,
                useExisting: AutoSizeVirtualScrollStrategy,
            },
            RxaResizeObserver,
        ], usesInheritance: true, usesOnChanges: true, ngImport: i0 });
}
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "18.0.1", ngImport: i0, type: AutoSizeVirtualScrollStrategy, decorators: [{
            type: Directive,
            args: [{
                    selector: 'rx-virtual-scroll-viewport[autosize]',
                    providers: [
                        {
                            provide: RxVirtualScrollStrategy,
                            useExisting: AutoSizeVirtualScrollStrategy,
                        },
                        RxaResizeObserver,
                    ],
                    standalone: true,
                }]
        }], propDecorators: { runwayItems: [{
                type: Input
            }], runwayItemsOpposite: [{
                type: Input
            }], tombstoneSize: [{
                type: Input
            }], resizeObserverConfig: [{
                type: Input
            }], withResizeObserver: [{
                type: Input,
                args: [{ transform: toBoolean }]
            }], appendOnly: [{
                type: Input,
                args: [{ transform: toBoolean }]
            }], withSyncScrollbar: [{
                type: Input,
                args: [{ transform: toBoolean }]
            }], keepScrolledIndexOnPrepend: [{
                type: Input,
                args: [{ transform: toBoolean }]
            }] } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXV0b3NpemUtdmlydHVhbC1zY3JvbGwtc3RyYXRlZ3kuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi8uLi8uLi9saWJzL3RlbXBsYXRlL2V4cGVyaW1lbnRhbC92aXJ0dWFsLXNjcm9sbGluZy9zcmMvbGliL3Njcm9sbC1zdHJhdGVnaWVzL2F1dG9zaXplLXZpcnR1YWwtc2Nyb2xsLXN0cmF0ZWd5LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFDTCxTQUFTLEVBRVQsTUFBTSxFQUNOLEtBQUssR0FLTixNQUFNLGVBQWUsQ0FBQztBQUN2QixPQUFPLEVBQUUsWUFBWSxFQUFFLE1BQU0sNEJBQTRCLENBQUM7QUFDMUQsT0FBTyxFQUNMLGFBQWEsRUFDYixLQUFLLEVBR0wsUUFBUSxFQUNSLGFBQWEsRUFDYixPQUFPLEdBQ1IsTUFBTSxNQUFNLENBQUM7QUFDZCxPQUFPLEVBQ0wsb0JBQW9CLEVBQ3BCLFVBQVUsRUFDVixNQUFNLEVBQ04sUUFBUSxFQUNSLE9BQU8sRUFDUCxHQUFHLEVBQ0gsUUFBUSxFQUNSLFNBQVMsRUFDVCxTQUFTLEVBQ1QsU0FBUyxFQUNULFNBQVMsRUFDVCxHQUFHLEdBQ0osTUFBTSxnQkFBZ0IsQ0FBQztBQUN4QixPQUFPLEVBR0wsdUJBQXVCLEdBR3hCLE1BQU0sVUFBVSxDQUFDO0FBQ2xCLE9BQU8sRUFDTCw2QkFBNkIsRUFDN0Isd0JBQXdCLEVBQ3hCLFNBQVMsRUFDVCxrQkFBa0IsR0FDbkIsTUFBTSxTQUFTLENBQUM7QUFDakIsT0FBTyxFQUFFLGlDQUFpQyxFQUFFLE1BQU0sMEJBQTBCLENBQUM7QUFDN0UsT0FBTyxFQUFFLGlCQUFpQixFQUFFLE1BQU0sbUJBQW1CLENBQUM7O0FBZXRELE1BQU0sa0JBQWtCLEdBQUcsQ0FBQyxLQUEwQixFQUFFLEVBQUUsQ0FDeEQsS0FBSyxDQUFDLGFBQWEsQ0FBQyxDQUFDLENBQUMsQ0FBQyxTQUFTLENBQUM7QUFFbkM7Ozs7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ZFZpZXdSZWYsXG4gIGluamVjdCxcbiAgSW5wdXQsXG4gIE5nSXRlcmFibGUsXG4gIE9uQ2hhbmdlcyxcbiAgT25EZXN0cm95LFxuICBTaW1wbGVDaGFuZ2VzLFxufSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IGNvYWxlc2NlV2l0aCB9IGZyb20gJ0ByeC1hbmd1bGFyL2Nkay9jb2FsZXNjaW5nJztcbmltcG9ydCB7XG4gIGNvbWJpbmVMYXRlc3QsXG4gIG1lcmdlLFxuICBNb25vVHlwZU9wZXJhdG9yRnVuY3Rpb24sXG4gIE9ic2VydmFibGUsXG4gIHBhaXJ3aXNlLFxuICBSZXBsYXlTdWJqZWN0LFxuICBTdWJqZWN0LFxufSBmcm9tICdyeGpzJztcbmltcG9ydCB7XG4gIGRpc3RpbmN0VW50aWxDaGFuZ2VkLFxuICBleGhhdXN0TWFwLFxuICBmaWx0ZXIsXG4gIGZpbmFsaXplLFxuICBncm91cEJ5LFxuICBtYXAsXG4gIG1lcmdlTWFwLFxuICBzdGFydFdpdGgsXG4gIHN3aXRjaE1hcCxcbiAgdGFrZVVudGlsLFxuICB0YWtlV2hpbGUsXG4gIHRhcCxcbn0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuaW1wb3J0IHtcbiAgTGlzdFJhbmdlLFxuICBSeFZpcnR1YWxGb3JWaWV3Q29udGV4dCxcbiAgUnhWaXJ0dWFsU2Nyb2xsU3RyYXRlZ3ksXG4gIFJ4VmlydHVhbFNjcm9sbFZpZXdwb3J0LFxuICBSeFZpcnR1YWxWaWV3UmVwZWF0ZXIsXG59IGZyb20gJy4uL21vZGVsJztcbmltcG9ydCB7XG4gIGNhbGN1bGF0ZVZpc2libGVDb250YWluZXJTaXplLFxuICBwYXJzZVNjcm9sbFRvcEJvdW5kYXJpZXMsXG4gIHRvQm9vbGVhbixcbiAgdW5wYXRjaGVkTWljcm9UYXNrLFxufSBmcm9tICcuLi91dGlsJztcbmltcG9ydCB7IFJYX1ZJUlRVQUxfU0NST0xMX0RFRkFVTFRfT1BUSU9OUyB9IGZyb20gJy4uL3ZpcnR1YWwtc2Nyb2xsLmNvbmZpZyc7XG5pbXBvcnQgeyBSeGFSZXNpemVPYnNlcnZlciB9IGZyb20gJy4vcmVzaXplLW9ic2VydmVyJztcblxuLyoqIEBpbnRlcm5hbCAqL1xudHlwZSBWaXJ0dWFsVmlld0l0ZW0gPSB7XG4gIHNpemU6IG51bWJlcjtcbiAgY2FjaGVkPzogYm9vbGVhbjtcbiAgcG9zaXRpb24/OiBudW1iZXI7XG59O1xuXG4vKiogQGludGVybmFsICovXG50eXBlIEFuY2hvckl0ZW0gPSB7XG4gIGluZGV4OiBudW1iZXI7XG4gIG9mZnNldDogbnVtYmVyO1xufTtcblxuY29uc3QgZGVmYXVsdFNpemVFeHRyYWN0ID0gKGVudHJ5OiBSZXNpemVPYnNlcnZlckVudHJ5KSA9PlxuICBlbnRyeS5ib3JkZXJCb3hTaXplWzBdLmJsb2NrU2l6ZTtcblxuLyoqXG4gKiBARGlyZWN0aXZlIEF1dG9zaXplVmlydHVhbFNjcm9sbFN0cmF0ZWd5XG4gKlxuICogQGRlc2NyaXB0aW9uXG4gKlxuICogVGhlIGBBdXRvc2l6ZVZpcnR1YWxTY3JvbGxTdHJhdGVneWAgcHJvdmlkZXMgYSB0d2l0dGVyLWxpa2UgdmlydHVhbC1zY3JvbGxpbmdcbiAqIGV4cGVyaWVuY2UuIEl0IGlzIGFibGUgdG8gcmVuZGVyIGFuZCBwb3NpdGlvbiBpdGVtcyBiYXNlZCBvbiB0aGVpciBpbmRpdmlkdWFsXG4gKiBzaXplLiBJdCBpcyBjb21wYXJhYmxlIHRvIFxcQGFuZ3VsYXIvY2RrL2V4cGVyaW1lbnRhbCBgQXV0b3NpemVWaXJ0dWFsU2Nyb2xsU3RyYXRlZ3lgLCBidXRcbiAqIHdpdGggYSBoaWdoIHBlcmZvcm1hbnQgbGF5b3V0aW5nIHRlY2huaXF1ZSBhbmQgbW9yZSBmZWF0dXJlcy5cbiAqXG4gKiBPbiB0b3Agb2YgdGhpcyB0aGUgYEF1dG9zaXplVmlydHVhbFNjcm9sbFN0cmF0ZWd5YCBpcyBsZXZlcmFnaW5nIHRoZSBuYXRpdmVcbiAqIGBSZXNpemVPYnNlcnZlcmAgaW4gb3JkZXIgdG8gZGV0ZWN0IHNpemUgY2hhbmdlcyBmb3IgZWFjaCBpbmRpdmlkdWFsIHZpZXdcbiAqIHJlbmRlcmVkIHRvIHRoZSBET00gYW5kIHByb3Blcmx5IHJlLXBvc2l0aW9uIGFjY29yZGluZ2x5LlxuICpcbiAqIEluIG9yZGVyIHRvIHByb3ZpZGUgdG9wLW5vdGNoIHJ1bnRpbWUgcGVyZm9ybWFuY2UgdGhlIGBBdXRvc2l6ZVZpcnR1YWxTY3JvbGxTdHJhdGVneWBcbiAqIGJ1aWxkcyB1cCBjYWNoZXMgdGhhdCBwcmV2ZW50IERPTSBpbnRlcmFjdGlvbnMgd2hlbmV2ZXIgcG9zc2libGUuIE9uY2UgYSB2aWV3XG4gKiB3YXMgdmlzaXRlZCwgaXRzIHByb3BlcnRpZXMgd2lsbCBiZSBzdG9yZWQgaW5zdGVhZCBvZiByZS1yZWFkIGZyb20gdGhlIERPTSBhZ2FpbiBhc1xuICogdGhpcyBjYW4gcG90ZW50aWFsbHkgbGVhZCB0byB1bndhbnRlZCBmb3JjZWQgcmVmbG93cy5cbiAqXG4gKiBAZG9jc0NhdGVnb3J5IFJ4VmlydHVhbEZvclxuICogQGRvY3NQYWdlIFJ4VmlydHVhbEZvclxuICogQHB1YmxpY0FwaVxuICovXG5ARGlyZWN0aXZlKHtcbiAgc2VsZWN0b3I6ICdyeC12aXJ0dWFsLXNjcm9sbC12aWV3cG9ydFthdXRvc2l6ZV0nLFxuICBwcm92aWRlcnM6IFtcbiAgICB7XG4gICAgICBwcm92aWRlOiBSeFZpcnR1YWxTY3JvbGxTdHJhdGVneSxcbiAgICAgIHVzZUV4aXN0aW5nOiBBdXRvU2l6ZVZpcnR1YWxTY3JvbGxTdHJhdGVneSxcbiAgICB9LFxuICAgIFJ4YVJlc2l6ZU9ic2VydmVyLFxuICBdLFxuICBzdGFuZGFsb25lOiB0cnVlLFxufSlcbmV4cG9ydCBjbGFzcyBBdXRvU2l6ZVZpcnR1YWxTY3JvbGxTdHJhdGVneTxcbiAgICBULFxuICAgIFUgZXh0ZW5kcyBOZ0l0ZXJhYmxlPFQ+ID0gTmdJdGVyYWJsZTxUPixcbiAgPlxuICBleHRlbmRzIFJ4VmlydHVhbFNjcm9sbFN0cmF0ZWd5PFQsIFU+XG4gIGltcGxlbWVudHMgT25DaGFuZ2VzLCBPbkRlc3Ryb3lcbntcbiAgcHJpdmF0ZSByZWFkb25seSBkZWZhdWx0cz8gPSBpbmplY3QoUlhfVklSVFVBTF9TQ1JPTExfREVGQVVMVF9PUFRJT05TLCB7XG4gICAgb3B0aW9uYWw6IHRydWUsXG4gIH0pO1xuXG4gIC8qKlxuICAgKiBAZGVzY3JpcHRpb25cbiAgICogVGhlIGFtb3VudCBvZiBpdGVtcyB0byByZW5kZXIgdXBmcm9udCBpbiBzY3JvbGwgZGlyZWN0aW9uXG4gICAqL1xuICBASW5wdXQoKSBydW53YXlJdGVtcyA9IHRoaXMuZGVmYXVsdHM/LnJ1bndheUl0ZW1zID8/IDEwO1xuXG4gIC8qKlxuICAgKiBAZGVzY3JpcHRpb25cbiAgICogVGhlIGFtb3VudCBvZiBpdGVtcyB0byByZW5kZXIgdXBmcm9udCBpbiByZXZlcnNlIHNjcm9sbCBkaXJlY3Rpb25cbiAgICovXG4gIEBJbnB1dCgpIHJ1bndheUl0ZW1zT3Bwb3NpdGUgPSB0aGlzLmRlZmF1bHRzPy5ydW53YXlJdGVtc09wcG9zaXRlID8/IDI7XG5cbiAgLyoqXG4gICAqIEBkZXNjcmlwdGlvblxuICAgKiBUaGUgZGVmYXVsdCBzaXplIG9mIHRoZSBpdGVtcyBiZWluZyByZW5kZXJlZC4gVGhlIGF1dG9zaXplZCBzdHJhdGVneSB3aWxsIGFzc3VtZVxuICAgKiB0aGlzIHNpemUgZm9yIGl0ZW1zIGl0IGRvZXNuJ3Qga25vdyB5ZXQuIEZvciB0aGUgc21vb3RoZXN0IGV4cGVyaWVuY2UsXG4gICAqIHlvdSBwcm92aWRlIHRoZSBtZWFuIHNpemUgb2YgYWxsIGl0ZW1zIGJlaW5nIHJlbmRlcmVkIC0gaWYgcG9zc2libGUgb2YgY291cnNlLlxuICAgKlxuICAgKiBBcyBzb29uIGFzIHJ4VmlydHVhbEZvciBpcyBhYmxlIHRvIGFsc28gcmVuZGVyIGFjdHVhbCB0b21ic3RvbmUgaXRlbXMsIHRoaXNcbiAgICogd2lsbCBiZSB0aGUgc2l6ZSBvZiBhIHRvbWJzdG9uZSBpdGVtIGJlaW5nIHJlbmRlcmVkIGJlZm9yZSB0aGUgYWN0dWFsIGl0ZW1cbiAgICogaXMgaW5zZXJ0ZWQgaW50byBpdHMgcG9zaXRpb24uXG4gICAqL1xuICBASW5wdXQoKSB0b21ic3RvbmVTaXplID0gdGhpcy5kZWZhdWx0cz8uaXRlbVNpemUgPz8gNTA7XG5cbiAgLyoqXG4gICAqIEBkZXNjcmlwdGlvblxuICAgKiBUaGUgYXV0b3NpemVkIHN0cmF0ZWd5IHVzZXMgdGhlIG5hdGl2ZSBSZXNpemVPYnNlcnZlciBpbiBvcmRlciB0byBkZXRlcm1pbmVcbiAgICogaWYgYW4gaXRlbSBjaGFuZ2VkIGluIHNpemUgdG8gYWZ0ZXJ3YXJkcyBwcm9wZXJseSBwb3NpdGlvbiB0aGUgdmlld3MuXG4gICAqIFlvdSBjYW4gY3VzdG9taXplIHRoZSBjb25maWcgcGFzc2VkIHRvIHRoZSBSZXNpemVPYnNlcnZlciBhcyB3ZWxsIGFzIGRldGVybWluZVxuICAgKiB3aGljaCByZXN1bHQgcHJvcGVydHkgdG8gdXNlIHdoZW4gZGV0ZXJtaW5pbmcgdGhlIHZpZXdzIHNpemUuXG4gICAqL1xuICBASW5wdXQoKSByZXNpemVPYnNlcnZlckNvbmZpZz86IHtcbiAgICBvcHRpb25zPzogUmVzaXplT2JzZXJ2ZXJPcHRpb25zO1xuICAgIGV4dHJhY3RTaXplPzogKGVudHJ5OiBSZXNpemVPYnNlcnZlckVudHJ5KSA9PiBudW1iZXI7XG4gIH07XG5cbiAgLyoqXG4gICAqIEBkZXNjcmlwdGlvblxuICAgKiBXaGVuIGVuYWJsZWQsIHRoZSBhdXRvc2l6ZWQgc2Nyb2xsIHN0cmF0ZWd5IGF0dGFjaGVzIGEgYFJlc2l6ZU9ic2VydmVyYFxuICAgKiB0byBldmVyeSB2aWV3IHdpdGhpbiB0aGUgZ2l2ZW4gcmVuZGVyZWRSYW5nZS4gSWYgeW91ciB2aWV3cyByZWNlaXZlXG4gICAqIGRpbWVuc2lvbiBjaGFuZ2VzIHRoYXQgYXJlIG5vdCBjYXVzZWQgYnkgbGlzdCB1cGRhdGVzLCB0aGlzIGlzIGEgd2F5IHRvXG4gICAqIHN0aWxsIHRyYWNrIGhlaWdodCBjaGFuZ2VzLiBUaGlzIGFsc28gYXBwbGllcyB0byByZXNpemUgZXZlbnRzIG9mIHRoZSB3aG9sZVxuICAgKiBkb2N1bWVudC5cbiAgICovXG4gIEBJbnB1dCh7IHRyYW5zZm9ybTogdG9Cb29sZWFuIH0pIHdpdGhSZXNpemVPYnNlcnZlciA9IHRydWU7XG5cbiAgLyoqXG4gICAqIEBkZXNjcmlwdGlvblxuICAgKiBXaGVuIGVuYWJsZWQsIHRoZSBzY3JvbGwgc3RyYXRlZ3kgc3RvcHMgcmVtb3Zpbmcgdmlld3MgZnJvbSB0aGUgdmlld3BvcnQsXG4gICAqIGluc3RlYWQgaXQgb25seSBhZGRzIHZpZXdzLiBUaGlzIHNldHRpbmcgY2FuIGJlIGNoYW5nZWQgb24gdGhlIGZseS4gVmlld3Mgd2lsbCBiZSBhZGRlZCBpbiBib3RoIGRpcmVjdGlvbnNcbiAgICogYWNjb3JkaW5nIHRvIHRoZSB1c2VyIGludGVyYWN0aW9ucy5cbiAgICovXG4gIEBJbnB1dCh7IHRyYW5zZm9ybTogdG9Cb29sZWFuIH0pIGFwcGVuZE9ubHkgPSBmYWxzZTtcblxuICAvKipcbiAgICogQGRlc2NyaXB0aW9uXG4gICAqIFdoZW4gZW5hYmxlZCwgdGhlIGF1dG9zaXplZCBzY3JvbGwgc3RyYXRlZ3kgcmVtb3ZlcyBjc3Mgc3R5bGVzIHRoYXRcbiAgICogcHJldmVudCB0aGUgc2Nyb2xsYmFyIGZyb20gYmVpbmcgaW4gc3luYyB3aXRoIHRoZSBpbnB1dCBkZXZpY2UuXG4gICAqIFVzZSB3aXRoIGNhdXRpb24sIGFzIHRoaXMgY2FuIGxlYWQgdG8gZXh0cmVtZWx5IHdlaXJkIHNjcm9sbCBiZWhhdmlvclxuICAgKiBvbiBjaHJvbWl1bSBiYXNlZCBicm93c2VycyB3aGVuIHRoZSByZW5kZXJlZCB2aWV3cyBkaWZmZXJcbiAgICogaW4gZGltZW5zaW9ucyB0b28gbXVjaCBvciBjaGFuZ2UgZGltZW5zaW9ucyBoZWF2aWx5LlxuICAgKi9cbiAgQElucHV0KHsgdHJhbnNmb3JtOiB0b0Jvb2xlYW4gfSkgd2l0aFN5bmNTY3JvbGxiYXIgPSBmYWxzZTtcblxuICAvKipcbiAgICogQGRlc2NyaXB0aW9uXG4gICAqIElmIHRoaXMgZmxhZyBpcyB0cnVlLCB0aGUgdmlydHVhbCBzY3JvbGwgc3RyYXRlZ3kgbWFpbnRhaW5zIHRoZSBzY3JvbGxlZCBpdGVtIHdoZW4gbmV3IGRhdGFcbiAgICogaXMgcHJlcGVuZGVkIHRvIHRoZSBsaXN0LiBUaGlzIGlzIHZlcnkgdXNlZnVsIHdoZW4gaW1wbGVtZW50aW5nIGEgcmV2ZXJzZWQgaW5maW5pdGUgc2Nyb2xsZXIsIHRoYXQgcHJlcGVuZHNcbiAgICogZGF0YSBpbnN0ZWFkIG9mIGFwcGVuZGluZyBpdFxuICAgKi9cbiAgQElucHV0KHsgdHJhbnNmb3JtOiB0b0Jvb2xlYW4gfSkga2VlcFNjcm9sbGVkSW5kZXhPblByZXBlbmQgPSBmYWxzZTtcblxuICAvKiogQGludGVybmFsICovXG4gIHByaXZhdGUgdmlld3BvcnQ6IFJ4VmlydHVhbFNjcm9sbFZpZXdwb3J0IHwgbnVsbCA9IG51bGw7XG4gIC8qKiBAaW50ZXJuYWwgKi9cbiAgcHJpdmF0ZSB2aWV3UmVwZWF0ZXI6IFJ4VmlydHVhbFZpZXdSZXBlYXRlcjxULCBVPiB8IG51bGwgPSBudWxsO1xuXG4gIC8qKiBAaW50ZXJuYWwgKi9cbiAgcHJpdmF0ZSByZWFkb25seSBfY29udGVudFNpemUkID0gbmV3IFJlcGxheVN1YmplY3Q8bnVtYmVyPigxKTtcbiAgLyoqIEBpbnRlcm5hbCAqL1xuICBvdmVycmlkZSByZWFkb25seSBjb250ZW50U2l6ZSQgPSB0aGlzLl9jb250ZW50U2l6ZSQuYXNPYnNlcnZhYmxlKCk7XG5cbiAgLyoqIEBpbnRlcm5hbCAqL1xuICBwcml2YXRlIF9jb250ZW50U2l6ZSA9IDA7XG4gIC8qKiBAaW50ZXJuYWwgKi9cbiAgcHJpdmF0ZSBzZXQgY29udGVudFNpemUoc2l6ZTogbnVtYmVyKSB7XG4gICAgdGhpcy5fY29udGVudFNpemUgPSBzaXplO1xuICAgIHRoaXMuX2NvbnRlbnRTaXplJC5uZXh0KHNpemUpO1xuICB9XG4gIHByaXZhdGUgZ2V0IGNvbnRlbnRTaXplKCk6IG51bWJlciB7XG4gICAgcmV0dXJuIHRoaXMuX2NvbnRlbnRTaXplO1xuICB9XG5cbiAgLyoqIEBpbnRlcm5hbCAqL1xuICBwcml2YXRlIHJlYWRvbmx5IF9yZW5kZXJlZFJhbmdlJCA9IG5ldyBTdWJqZWN0PExpc3RSYW5nZT4oKTtcbiAgLyoqIEBpbnRlcm5hbCAqL1xuICByZWFkb25seSByZW5kZXJlZFJhbmdlJCA9IHRoaXMuX3JlbmRlcmVkUmFuZ2UkLmFzT2JzZXJ2YWJsZSgpO1xuICAvKiogQGludGVybmFsICovXG4gIHByaXZhdGUgX3JlbmRlcmVkUmFuZ2U6IExpc3RSYW5nZSA9IHsgc3RhcnQ6IDAsIGVuZDogMCB9O1xuXG4gIC8qKiBAaW50ZXJuYWwgKi9cbiAgcHJpdmF0ZSBzZXQgcmVuZGVyZWRSYW5nZShyYW5nZTogTGlzdFJhbmdlKSB7XG4gICAgdGhpcy5fcmVuZGVyZWRSYW5nZSA9IHJhbmdlO1xuICAgIHRoaXMuX3JlbmRlcmVkUmFuZ2UkLm5leHQocmFuZ2UpO1xuICB9XG4gIC8qKiBAaW50ZXJuYWwgKi9cbiAgcHJpdmF0ZSBnZXQgcmVuZGVyZWRSYW5nZSgpOiBMaXN0UmFuZ2Uge1xuICAgIHJldHVybiB0aGlzLl9yZW5kZXJlZFJhbmdlO1xuICB9XG4gIC8qKiBAaW50ZXJuYWwgKi9cbiAgcHJpdmF0ZSBwb3NpdGlvbmVkUmFuZ2U6IExpc3RSYW5nZSA9IHsgc3RhcnQ6IDAsIGVuZDogMCB9O1xuXG4gIC8qKiBAaW50ZXJuYWwgKi9cbiAgcHJpdmF0ZSByZWFkb25seSBfc2Nyb2xsZWRJbmRleCQgPSBuZXcgUmVwbGF5U3ViamVjdDxudW1iZXI+KDEpO1xuICAvKiogQGludGVybmFsICovXG4gIHJlYWRvbmx5IHNjcm9sbGVkSW5kZXgkID0gdGhpcy5fc2Nyb2xsZWRJbmRleCQucGlwZShkaXN0aW5jdFVudGlsQ2hhbmdlZCgpKTtcbiAgLyoqIEBpbnRlcm5hbCAqL1xuICBwcml2YXRlIF9zY3JvbGxlZEluZGV4ID0gMDtcbiAgLyoqIEBpbnRlcm5hbCAqL1xuICBwcml2YXRlIGdldCBzY3JvbGxlZEluZGV4KCk6IG51bWJlciB7XG4gICAgcmV0dXJuIHRoaXMuX3Njcm9sbGVkSW5kZXg7XG4gIH1cbiAgLyoqIEBpbnRlcm5hbCAqL1xuICBwcml2YXRlIHNldCBzY3JvbGxlZEluZGV4KGluZGV4OiBudW1iZXIpIHtcbiAgICB0aGlzLl9zY3JvbGxlZEluZGV4ID0gaW5kZXg7XG4gICAgdGhpcy5fc2Nyb2xsZWRJbmRleCQubmV4dChpbmRleCk7XG4gIH1cblxuICAvKipcbiAgICogaXMgc2V0LCB3aGVuIHNjcm9sbFRvSW5kZXggaXMgY2FsbGVkXG4gICAqIEBpbnRlcm5hbFxuICAgKiAqL1xuICBwcml2YXRlIF9zY3JvbGxUb0luZGV4OiBudW1iZXIgfCBudWxsID0gbnVsbDtcblxuICAvKiogQGludGVybmFsICovXG4gIHByaXZhdGUgY29udGFpbmVyU2l6ZSA9IDA7XG4gIC8qKiBAaW50ZXJuYWwgKi9cbiAgcHJpdmF0ZSBjb250ZW50TGVuZ3RoID0gMDtcbiAgLyoqIEBpbnRlcm5hbCAqL1xuICBwcml2YXRlIF92aXJ0dWFsSXRlbXM6IFZpcnR1YWxWaWV3SXRlbVtdID0gW107XG4gIC8qKiBAaW50ZXJuYWwgKi9cbiAgcHJpdmF0ZSBzY3JvbGxUb3AgPSAwO1xuICAvKiogQGludGVybmFsICovXG4gIHByaXZhdGUgc2Nyb2xsVG9wV2l0aE91dE9mZnNldCA9IDA7XG4gIC8qKiBAaW50ZXJuYWwgKi9cbiAgcHJpdmF0ZSBzY3JvbGxUb3BBZnRlck9mZnNldCA9IDA7XG4gIC8qKiBAaW50ZXJuYWwgKi9cbiAgcHJpdmF0ZSB2aWV3cG9ydE9mZnNldCA9IDA7XG4gIC8qKiBAaW50ZXJuYWwgKi9cbiAgcHJpdmF0ZSBkaXJlY3Rpb246ICd1cCcgfCAnZG93bicgPSAnZG93bic7XG4gIC8qKiBAaW50ZXJuYWwgKi9cbiAgcHJpdmF0ZSBhbmNob3JTY3JvbGxUb3AgPSAwO1xuXG4gIC8qKiBAaW50ZXJuYWwgKi9cbiAgcHJpdmF0ZSBhbmNob3JJdGVtID0ge1xuICAgIGluZGV4OiAwLFxuICAgIG9mZnNldDogMCxcbiAgfTtcbiAgLyoqIEBpbnRlcm5hbCAqL1xuICBwcml2YXRlIGxhc3RTY3JlZW5JdGVtID0ge1xuICAgIGluZGV4OiAwLFxuICAgIG9mZnNldDogMCxcbiAgfTtcblxuICAvKiogQGludGVybmFsICovXG4gIHByaXZhdGUgd2FpdEZvclNjcm9sbCA9IGZhbHNlO1xuXG4gIC8qKiBAaW50ZXJuYWwgKi9cbiAgcHJpdmF0ZSBpc1N0YWJsZSQgPSBuZXcgUmVwbGF5U3ViamVjdDxib29sZWFuPigxKTtcblxuICAvKiogQGludGVybmFsICovXG4gIHByaXZhdGUgcmVhZG9ubHkgZGV0YWNoZWQkID0gbmV3IFN1YmplY3Q8dm9pZD4oKTtcblxuICAvKiogQGludGVybmFsICovXG4gIHByaXZhdGUgcmVzaXplT2JzZXJ2ZXIgPSBpbmplY3QoUnhhUmVzaXplT2JzZXJ2ZXIsIHsgc2VsZjogdHJ1ZSB9KTtcbiAgLyoqIEBpbnRlcm5hbCAqL1xuICBwcml2YXRlIHJlYWRvbmx5IHJlY2FsY3VsYXRlUmFuZ2UkID0gbmV3IFN1YmplY3Q8dm9pZD4oKTtcblxuICAvKiogQGludGVybmFsICovXG4gIHByaXZhdGUgdW50aWwkPEE+KCk6IE1vbm9UeXBlT3BlcmF0b3JGdW5jdGlvbjxBPiB7XG4gICAgcmV0dXJuIChvJCkgPT4gbyQucGlwZSh0YWtlVW50aWwodGhpcy5kZXRhY2hlZCQpKTtcbiAgfVxuXG4gIC8qKiBAaW50ZXJuYWwgKi9cbiAgcHJpdmF0ZSBnZXQgZXh0cmFjdFNpemUoKSB7XG4gICAgcmV0dXJuIHRoaXMucmVzaXplT2JzZXJ2ZXJDb25maWc/LmV4dHJhY3RTaXplID8/IGRlZmF1bHRTaXplRXh0cmFjdDtcbiAgfVxuXG4gIC8qKiBAaW50ZXJuYWwgKi9cbiAgb3ZlcnJpZGUgZ2V0IGlzU3RhYmxlKCk6IE9ic2VydmFibGU8Ym9vbGVhbj4ge1xuICAgIHJldHVybiB0aGlzLmlzU3RhYmxlJC5waXBlKGZpbHRlcigodykgPT4gdykpO1xuICB9XG5cbiAgLyoqIEBpbnRlcm5hbCAqL1xuICBuZ09uQ2hhbmdlcyhjaGFuZ2VzOiBTaW1wbGVDaGFuZ2VzKSB7XG4gICAgaWYgKFxuICAgICAgKGNoYW5nZXNbJ3J1bndheUl0ZW1zT3Bwb3NpdGUnXSAmJlxuICAgICAgICAhY2hhbmdlc1sncnVud2F5SXRlbXNPcHBvc2l0ZSddLmZpcnN0Q2hhbmdlKSB8fFxuICAgICAgKGNoYW5nZXNbJ3J1bndheUl0ZW1zJ10gJiYgIWNoYW5nZXNbJ3J1bndheUl0ZW1zJ10uZmlyc3RDaGFuZ2UpXG4gICAgKSB7XG4gICAgICB0aGlzLnJlY2FsY3VsYXRlUmFuZ2UkLm5leHQoKTtcbiAgICB9XG4gICAgaWYgKGNoYW5nZXNbJ3dpdGhTeW5jU2Nyb2xsYmFyJ10pIHtcbiAgICAgIHRoaXMudXBkYXRlU2Nyb2xsRWxlbWVudENsYXNzKCk7XG4gICAgfVxuICB9XG5cbiAgLyoqIEBpbnRlcm5hbCAqL1xuICBuZ09uRGVzdHJveSgpIHtcbiAgICB0aGlzLmRldGFjaCgpO1xuICB9XG5cbiAgLyoqIEBpbnRlcm5hbCAqL1xuICBhdHRhY2goXG4gICAgdmlld3BvcnQ6IFJ4VmlydHVhbFNjcm9sbFZpZXdwb3J0LFxuICAgIHZpZXdSZXBlYXRlcjogUnhWaXJ0dWFsVmlld1JlcGVhdGVyPFQsIFU+LFxuICApOiB2b2lkIHtcbiAgICB0aGlzLnZpZXdwb3J0ID0gdmlld3BvcnQ7XG4gICAgdGhpcy52aWV3UmVwZWF0ZXIgPSB2aWV3UmVwZWF0ZXI7XG4gICAgdGhpcy51cGRhdGVTY3JvbGxFbGVtZW50Q2xhc3MoKTtcbiAgICB0aGlzLm1haW50YWluVmlydHVhbEl0ZW1zKCk7XG4gICAgdGhpcy5jYWxjUmVuZGVyZWRSYW5nZSgpO1xuICAgIHRoaXMucG9zaXRpb25FbGVtZW50cygpO1xuICB9XG5cbiAgLyoqIEBpbnRlcm5hbCAqL1xuICBkZXRhY2goKTogdm9pZCB7XG4gICAgdGhpcy51cGRhdGVTY3JvbGxFbGVtZW50Q2xhc3MoZmFsc2UpO1xuICAgIHRoaXMudmlld3BvcnQgPSBudWxsO1xuICAgIHRoaXMudmlld1JlcGVhdGVyID0gbnVsbDtcbiAgICB0aGlzLl92aXJ0dWFsSXRlbXMgPSBbXTtcbiAgICB0aGlzLnJlc2l6ZU9ic2VydmVyLmRlc3Ryb3koKTtcbiAgICB0aGlzLmRldGFjaGVkJC5uZXh0KCk7XG4gIH1cblxuICBzY3JvbGxUb0luZGV4KGluZGV4OiBudW1iZXIsIGJlaGF2aW9yPzogU2Nyb2xsQmVoYXZpb3IpOiB2b2lkIHtcbiAgICBjb25zdCBfaW5kZXggPSBNYXRoLm1pbihcbiAgICAgIE1hdGgubWF4KGluZGV4LCAwKSxcbiAgICAgIE1hdGgubWF4KDAsIHRoaXMuY29udGVudExlbmd0aCAtIDEpLFxuICAgICk7XG4gICAgaWYgKF9pbmRleCAhPT0gdGhpcy5zY3JvbGxlZEluZGV4KSB7XG4gICAgICBjb25zdCBzY3JvbGxUb3AgPSB0aGlzLmNhbGNJbml0aWFsUG9zaXRpb24oX2luZGV4KTtcbiAgICAgIHRoaXMuX3Njcm9sbFRvSW5kZXggPSBfaW5kZXg7XG4gICAgICB0aGlzLnNjcm9sbFRvKHNjcm9sbFRvcCwgYmVoYXZpb3IpO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgc2Nyb2xsVG8oc2Nyb2xsVG86IG51bWJlciwgYmVoYXZpb3I/OiBTY3JvbGxCZWhhdmlvcik6IHZvaWQge1xuICAgIHRoaXMud2FpdEZvclNjcm9sbCA9XG4gICAgICBzY3JvbGxUbyAhPT0gdGhpcy5zY3JvbGxUb3AgJiYgdGhpcy5jb250ZW50U2l6ZSA+IHRoaXMuY29udGFpbmVyU2l6ZTtcbiAgICBpZiAodGhpcy53YWl0Rm9yU2Nyb2xsKSB7XG4gICAgICB0aGlzLmlzU3RhYmxlJC5uZXh0KGZhbHNlKTtcbiAgICB9XG4gICAgdGhpcy52aWV3cG9ydCEuc2Nyb2xsVG8odGhpcy52aWV3cG9ydE9mZnNldCArIHNjcm9sbFRvLCBiZWhhdmlvcik7XG4gIH1cblxuICAvKipcbiAgICogc3RhcnRzIHRoZSBzdWJzY3JpcHRpb25zIHRoYXQgbWFpbnRhaW4gdGhlIHZpcnR1YWxJdGVtcyBhcnJheSBvbiBjaGFuZ2VzXG4gICAqIHRvIHRoZSB1bmRlcmx5aW5nIGRhdGFzZXRcbiAgICogQGludGVybmFsXG4gICAqL1xuICBwcml2YXRlIG1haW50YWluVmlydHVhbEl0ZW1zKCk6IHZvaWQge1xuICAgIC8vIHJlc2V0IHZpcnR1YWwgdmlld3BvcnQgd2hlbiBvcHBvc2l0ZSBvcmllbnRhdGlvbiB0byB0aGUgc2Nyb2xsIGRpcmVjdGlvblxuICAgIC8vIGNoYW5nZXMsIGFzIHdlIGhhdmUgdG8gZXhwZWN0IGRpbWVuc2lvbiBjaGFuZ2VzIGZvciBhbGwgaXRlbXMgd2hlbiB0aGlzXG4gICAgLy8gaGFwcGVucy4gVGhpcyBjb3VsZCBhbHNvIGJlIGNvbmZpZ3VyYWJsZSBhcyBpdCBtYXliZSBjb3N0cyBwZXJmb3JtYW5jZVxuICAgIHRoaXMudmlld3BvcnQhLmNvbnRhaW5lclJlY3QkLnBpcGUoXG4gICAgICBtYXAoKHsgd2lkdGggfSkgPT4gd2lkdGgpLFxuICAgICAgZGlzdGluY3RVbnRpbENoYW5nZWQoKSxcbiAgICAgIGZpbHRlcigoKSA9PiB0aGlzLnJlbmRlcmVkUmFuZ2UuZW5kID4gMCAmJiB0aGlzLl92aXJ0dWFsSXRlbXMubGVuZ3RoID4gMCksXG4gICAgICB0aGlzLnVudGlsJCgpLFxuICAgICkuc3Vic2NyaWJlKCgpID0+IHtcbiAgICAgIC8vIHJlc2V0IGJlY2F1c2Ugd2UgaGF2ZSBubyBpZGVhIGhvdyBpdGVtcyB3aWxsIGJlaGF2ZVxuICAgICAgbGV0IGkgPSAwO1xuICAgICAgd2hpbGUgKGkgPCB0aGlzLnJlbmRlcmVkUmFuZ2Uuc3RhcnQpIHtcbiAgICAgICAgdGhpcy5fdmlydHVhbEl0ZW1zW2ldLmNhY2hlZCA9IGZhbHNlO1xuICAgICAgICBpKys7XG4gICAgICB9XG4gICAgICBpID0gdGhpcy5yZW5kZXJlZFJhbmdlLmVuZDtcbiAgICAgIHdoaWxlIChpIDwgdGhpcy5jb250ZW50TGVuZ3RoIC0gMSkge1xuICAgICAgICB0aGlzLl92aXJ0dWFsSXRlbXNbaV0uY2FjaGVkID0gZmFsc2U7XG4gICAgICAgIGkrKztcbiAgICAgIH1cbiAgICB9KTtcblxuICAgIC8vIHN5bmNocm9uaXNlcyB0aGUgdmFsdWVzIHdpdGggdGhlIHZpcnR1YWwgdmlld3BvcnQgd2UndmUgYnVpbHQgdXBcbiAgICAvLyBpdCBtaWdodCBnZXQgY29zdHkgd2hlbiBoYXZpbmcgPiAxMDBrIGVsZW1lbnRzLCBpdCdzIHN0aWxsIGZhc3RlciB0aGFuXG4gICAgLy8gdGhlIEl0ZXJhYmxlRGlmZmVyIGFwcHJvYWNoLCBlc3BlY2lhbGx5IG9uIG1vdmUgb3BlcmF0aW9uc1xuICAgIGNvbnN0IGl0ZW1DYWNoZSA9IG5ldyBNYXA8YW55LCB7IGl0ZW06IFQ7IGluZGV4OiBudW1iZXIgfT4oKTtcbiAgICBjb25zdCB0cmFja0J5ID0gdGhpcy52aWV3UmVwZWF0ZXIhLl90cmFja0J5ID8/ICgoaSwgaXRlbSkgPT4gaXRlbSk7XG4gICAgdGhpcy5yZW5kZXJlZFJhbmdlJFxuICAgICAgLnBpcGUocGFpcndpc2UoKSwgdGhpcy51bnRpbCQoKSlcbiAgICAgIC5zdWJzY3JpYmUoKFtvbGRSYW5nZSwgbmV3UmFuZ2VdKSA9PiB7XG4gICAgICAgIGxldCBpID0gb2xkUmFuZ2Uuc3RhcnQ7XG4gICAgICAgIGlmIChpIDwgdGhpcy5fdmlydHVhbEl0ZW1zLmxlbmd0aCkge1xuICAgICAgICAgIGZvciAoaTsgaSA8IE1hdGgubWluKHRoaXMuX3ZpcnR1YWxJdGVtcy5sZW5ndGgsIG9sZFJhbmdlLmVuZCk7IGkrKykge1xuICAgICAgICAgICAgaWYgKGkgPCBuZXdSYW5nZS5zdGFydCB8fCBpID49IG5ld1JhbmdlLmVuZCkge1xuICAgICAgICAgICAgICB0aGlzLl92aXJ0dWFsSXRlbXNbaV0ucG9zaXRpb24gPSB1bmRlZmluZWQ7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9KTtcbiAgICB0aGlzLnZpZXdSZXBlYXRlciEudmFsdWVzJC5waXBlKFxuICAgICAgdGhpcy51bnRpbCQoKSxcbiAgICAgIHRhcCgodmFsdWVzKSA9PiB7XG4gICAgICAgIGNvbnN0IGRhdGFBcnIgPSBBcnJheS5pc0FycmF5KHZhbHVlcylcbiAgICAgICAgICA/IHZhbHVlc1xuICAgICAgICAgIDogdmFsdWVzXG4gICAgICAgICAgICA/IEFycmF5LmZyb20odmFsdWVzKVxuICAgICAgICAgICAgOiBbXTtcbiAgICAgICAgY29uc3QgZXhpc3RpbmdJZHMgPSBuZXcgU2V0PGFueT4oKTtcbiAgICAgICAgbGV0IHNpemUgPSAwO1xuICAgICAgICBjb25zdCBkYXRhTGVuZ3RoID0gZGF0YUFyci5sZW5ndGg7XG4gICAgICAgIGNvbnN0IHZpcnR1YWxJdGVtcyA9IG5ldyBBcnJheTxWaXJ0dWFsVmlld0l0ZW0+KGRhdGFMZW5ndGgpO1xuICAgICAgICBsZXQgYW5jaG9ySXRlbUluZGV4ID0gdGhpcy5hbmNob3JJdGVtLmluZGV4O1xuICAgICAgICBjb25zdCBrZWVwU2Nyb2xsZWRJbmRleE9uUHJlcGVuZCA9XG4gICAgICAgICAgdGhpcy5rZWVwU2Nyb2xsZWRJbmRleE9uUHJlcGVuZCAmJlxuICAgICAgICAgIGRhdGFBcnIubGVuZ3RoID4gMCAmJlxuICAgICAgICAgIGl0ZW1DYWNoZS5zaXplID4gMDtcbiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBkYXRhTGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICBjb25zdCBpdGVtID0gZGF0YUFycltpXTtcbiAgICAgICAgICBjb25zdCBpZCA9IHRyYWNrQnkoaSwgaXRlbSk7XG4gICAgICAgICAgY29uc3QgY2FjaGVkSXRlbSA9IGl0ZW1DYWNoZS5nZXQoaWQpO1xuICAgICAgICAgIGlmIChjYWNoZWRJdGVtID09PSB1bmRlZmluZWQpIHtcbiAgICAgICAgICAgIC8vIGFkZFxuICAgICAgICAgICAgdmlydHVhbEl0ZW1zW2ldID0geyBzaXplOiAwIH07XG4gICAgICAgICAgICBpdGVtQ2FjaGUuc2V0KGlkLCB7IGl0ZW06IGRhdGFBcnJbaV0sIGluZGV4OiBpIH0pO1xuICAgICAgICAgICAgaWYgKGkgPD0gYW5jaG9ySXRlbUluZGV4KSB7XG4gICAgICAgICAgICAgIGFuY2hvckl0ZW1JbmRleCsrO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH0gZWxzZSBpZiAoY2FjaGVkSXRlbS5pbmRleCAhPT0gaSkge1xuICAgICAgICAgICAgLy8gbW92ZVxuICAgICAgICAgICAgdmlydHVhbEl0ZW1zW2ldID0gdGhpcy5fdmlydHVhbEl0ZW1zW2NhY2hlZEl0ZW0uaW5kZXhdO1xuICAgICAgICAgICAgdmlydHVhbEl0ZW1zW2ldLnBvc2l0aW9uID0gdW5kZWZpbmVkO1xuICAgICAgICAgICAgaXRlbUNhY2hlLnNldChpZCwgeyBpdGVtOiBkYXRhQXJyW2ldLCBpbmRleDogaSB9KTtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgLy8gdXBkYXRlXG4gICAgICAgICAgICAvLyB0b2RvOiBwcm9wZXJseSBkZXRlcm1pbmUgdXBkYXRlIChPYmplY3QuaXM/KVxuICAgICAgICAgICAgdmlydHVhbEl0ZW1zW2ldID0gdGhpcy5fdmlydHVhbEl0ZW1zW2ldO1xuICAgICAgICAgICAgLy8gaWYgaW5kZXggaXMgbm90IHBhcnQgb2YgcmVuZGVyZWQgcmFuZ2UsIHJlbW92ZSBjYWNoZVxuICAgICAgICAgICAgaWYgKFxuICAgICAgICAgICAgICAhdGhpcy53aXRoUmVzaXplT2JzZXJ2ZXIgfHxcbiAgICAgICAgICAgICAgaSA8IHRoaXMucmVuZGVyZWRSYW5nZS5zdGFydCB8fFxuICAgICAgICAgICAgICBpID49IHRoaXMucmVuZGVyZWRSYW5nZS5lbmRcbiAgICAgICAgICAgICkge1xuICAgICAgICAgICAgICB2aXJ0dWFsSXRlbXNbaV0uY2FjaGVkID0gZmFsc2U7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpdGVtQ2FjaGUuc2V0KGlkLCB7IGl0ZW06IGRhdGFBcnJbaV0sIGluZGV4OiBpIH0pO1xuICAgICAgICAgIH1cbiAgICAgICAgICBleGlzdGluZ0lkcy5hZGQoaWQpO1xuICAgICAgICAgIHNpemUgKz0gdmlydHVhbEl0ZW1zW2ldLnNpemUgfHwgdGhpcy50b21ic3RvbmVTaXplO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMuX3ZpcnR1YWxJdGVtcyA9IHZpcnR1YWxJdGVtcztcbiAgICAgICAgLy8gc3luYyBkZWxldGUgb3BlcmF0aW9uc1xuICAgICAgICBpZiAoaXRlbUNhY2hlLnNpemUgPiBkYXRhTGVuZ3RoKSB7XG4gICAgICAgICAgaXRlbUNhY2hlLmZvckVhY2goKHYsIGspID0+IHtcbiAgICAgICAgICAgIGlmICghZXhpc3RpbmdJZHMuaGFzKGspKSB7XG4gICAgICAgICAgICAgIGl0ZW1DYWNoZS5kZWxldGUoayk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICAgICAgZXhpc3RpbmdJZHMuY2xlYXIoKTtcbiAgICAgICAgdGhpcy5jb250ZW50TGVuZ3RoID0gZGF0YUxlbmd0aDtcbiAgICAgICAgaWYgKFxuICAgICAgICAgIGtlZXBTY3JvbGxlZEluZGV4T25QcmVwZW5kICYmXG4gICAgICAgICAgdGhpcy5hbmNob3JJdGVtLmluZGV4ICE9PSBhbmNob3JJdGVtSW5kZXhcbiAgICAgICAgKSB7XG4gICAgICAgICAgdGhpcy5zY3JvbGxUb0luZGV4KGFuY2hvckl0ZW1JbmRleCk7XG4gICAgICAgIH0gZWxzZSBpZiAoZGF0YUxlbmd0aCA9PT0gMCkge1xuICAgICAgICAgIHRoaXMuYW5jaG9ySXRlbSA9IHtcbiAgICAgICAgICAgIGluZGV4OiAwLFxuICAgICAgICAgICAgb2Zmc2V0OiAwLFxuICAgICAgICAgIH07XG4gICAgICAgICAgdGhpcy5fcmVuZGVyZWRSYW5nZSA9IHtcbiAgICAgICAgICAgIHN0YXJ0OiAwLFxuICAgICAgICAgICAgZW5kOiAwLFxuICAgICAgICAgIH07XG4gICAgICAgICAgdGhpcy5zY3JvbGxUbygwKTtcbiAgICAgICAgICB0aGlzLnNjcm9sbFRvcCA9IHRoaXMuYW5jaG9yU2Nyb2xsVG9wID0gMDtcbiAgICAgICAgfSBlbHNlIGlmIChkYXRhTGVuZ3RoIDwgdGhpcy5fcmVuZGVyZWRSYW5nZS5lbmQpIHtcbiAgICAgICAgICB0aGlzLmFuY2hvckl0ZW0gPSB0aGlzLmNhbGN1bGF0ZUFuY2hvcmVkSXRlbShcbiAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgaW5kZXg6IGRhdGFMZW5ndGgsXG4gICAgICAgICAgICAgIG9mZnNldDogMCxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAtY2FsY3VsYXRlVmlzaWJsZUNvbnRhaW5lclNpemUoXG4gICAgICAgICAgICAgIHRoaXMuY29udGFpbmVyU2l6ZSxcbiAgICAgICAgICAgICAgdGhpcy5zY3JvbGxUb3BXaXRoT3V0T2Zmc2V0LFxuICAgICAgICAgICAgICB0aGlzLnNjcm9sbFRvcEFmdGVyT2Zmc2V0LFxuICAgICAgICAgICAgKSxcbiAgICAgICAgICApO1xuICAgICAgICAgIHRoaXMuY2FsY0FuY2hvclNjcm9sbFRvcCgpO1xuICAgICAgICAgIHRoaXMuX3JlbmRlcmVkUmFuZ2UgPSB7XG4gICAgICAgICAgICBzdGFydDogTWF0aC5tYXgoMCwgdGhpcy5hbmNob3JJdGVtLmluZGV4IC0gdGhpcy5ydW53YXlJdGVtcyksXG4gICAgICAgICAgICBlbmQ6IGRhdGFMZW5ndGgsXG4gICAgICAgICAgfTtcbiAgICAgICAgICB0aGlzLnNjcm9sbFRvKHNpemUpO1xuICAgICAgICAgIHRoaXMuc2Nyb2xsVG9wID0gdGhpcy5hbmNob3JTY3JvbGxUb3A7XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5jb250ZW50U2l6ZSA9IHNpemU7XG4gICAgICB9KSxcbiAgICAgIGZpbmFsaXplKCgpID0+IGl0ZW1DYWNoZS5jbGVhcigpKSxcbiAgICApLnN1YnNjcmliZSgpO1xuICB9XG5cbiAgLyoqXG4gICAqIGxpc3RlbiB0byB0cmlnZ2VycyB0aGF0IHNob3VsZCBjaGFuZ2UgdGhlIHJlbmRlcmVkUmFuZ2VcbiAgICogQGludGVybmFsXG4gICAqL1xuICBwcml2YXRlIGNhbGNSZW5kZXJlZFJhbmdlKCk6IHZvaWQge1xuICAgIGxldCByZW1vdmVTY3JvbGxBbmNob3JPbk5leHRTY3JvbGwgPSBmYWxzZTtcbiAgICBjb25zdCBvbmx5VHJpZ2dlcldoZW5TdGFibGUgPVxuICAgICAgPEE+KCkgPT5cbiAgICAgIChvJDogT2JzZXJ2YWJsZTxBPikgPT5cbiAgICAgICAgbyQucGlwZShcbiAgICAgICAgICBmaWx0ZXIoXG4gICAgICAgICAgICAoKSA9PlxuICAgICAgICAgICAgICB0aGlzLnJlbmRlcmVkUmFuZ2UuZW5kID09PSAwIHx8XG4gICAgICAgICAgICAgICh0aGlzLnNjcm9sbFRvcCA9PT0gdGhpcy5hbmNob3JTY3JvbGxUb3AgJiZcbiAgICAgICAgICAgICAgICB0aGlzLl9zY3JvbGxUb0luZGV4ID09PSBudWxsKSxcbiAgICAgICAgICApLFxuICAgICAgICApO1xuICAgIGNvbWJpbmVMYXRlc3QoW1xuICAgICAgdGhpcy52aWV3cG9ydCEuY29udGFpbmVyUmVjdCQucGlwZShcbiAgICAgICAgbWFwKCh7IGhlaWdodCB9KSA9PiB7XG4gICAgICAgICAgdGhpcy5jb250YWluZXJTaXplID0gaGVpZ2h0O1xuICAgICAgICAgIHJldHVybiBoZWlnaHQ7XG4gICAgICAgIH0pLFxuICAgICAgICBkaXN0aW5jdFVudGlsQ2hhbmdlZCgpLFxuICAgICAgICBvbmx5VHJpZ2dlcldoZW5TdGFibGUoKSxcbiAgICAgICksXG4gICAgICB0aGlzLnZpZXdwb3J0IS5lbGVtZW50U2Nyb2xsZWQkLnBpcGUoXG4gICAgICAgIHN0YXJ0V2l0aCh2b2lkIDApLFxuICAgICAgICB0YXAoKCkgPT4ge1xuICAgICAgICAgIHRoaXMudmlld3BvcnRPZmZzZXQgPSB0aGlzLnZpZXdwb3J0IS5tZWFzdXJlT2Zmc2V0KCk7XG4gICAgICAgICAgY29uc3QgeyBzY3JvbGxUb3AsIHNjcm9sbFRvcFdpdGhPdXRPZmZzZXQsIHNjcm9sbFRvcEFmdGVyT2Zmc2V0IH0gPVxuICAgICAgICAgICAgcGFyc2VTY3JvbGxUb3BCb3VuZGFyaWVzKFxuICAgICAgICAgICAgICB0aGlzLnZpZXdwb3J0IS5nZXRTY3JvbGxUb3AoKSxcbiAgICAgICAgICAgICAgdGhpcy52aWV3cG9ydE9mZnNldCxcbiAgICAgICAgICAgICAgdGhpcy5fY29udGVudFNpemUsXG4gICAgICAgICAgICAgIHRoaXMuY29udGFpbmVyU2l6ZSxcbiAgICAgICAgICAgICk7XG4gICAgICAgICAgdGhpcy5kaXJlY3Rpb24gPVxuICAgICAgICAgICAgc2Nyb2xsVG9wV2l0aE91dE9mZnNldCA+IHRoaXMuc2Nyb2xsVG9wV2l0aE91dE9mZnNldFxuICAgICAgICAgICAgICA/ICdkb3duJ1xuICAgICAgICAgICAgICA6ICd1cCc7XG4gICAgICAgICAgdGhpcy5zY3JvbGxUb3BXaXRoT3V0T2Zmc2V0ID0gc2Nyb2xsVG9wV2l0aE91dE9mZnNldDtcbiAgICAgICAgICB0aGlzLnNjcm9sbFRvcEFmdGVyT2Zmc2V0ID0gc2Nyb2xsVG9wQWZ0ZXJPZmZzZXQ7XG4gICAgICAgICAgdGhpcy5zY3JvbGxUb3AgPSBzY3JvbGxUb3A7XG4gICAgICAgICAgaWYgKHJlbW92ZVNjcm9sbEFuY2hvck9uTmV4dFNjcm9sbCkge1xuICAgICAgICAgICAgdGhpcy5fc2Nyb2xsVG9JbmRleCA9IG51bGw7XG4gICAgICAgICAgICByZW1vdmVTY3JvbGxBbmNob3JPbk5leHRTY3JvbGwgPSBmYWxzZTtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgcmVtb3ZlU2Nyb2xsQW5jaG9yT25OZXh0U2Nyb2xsID0gdGhpcy5fc2Nyb2xsVG9JbmRleCAhPT0gbnVsbDtcbiAgICAgICAgICB9XG4gICAgICAgICAgdGhpcy53YWl0Rm9yU2Nyb2xsID0gZmFsc2U7XG4gICAgICAgIH0pLFxuICAgICAgKSxcbiAgICAgIHRoaXMuX2NvbnRlbnRTaXplJC5waXBlKGRpc3RpbmN0VW50aWxDaGFuZ2VkKCksIG9ubHlUcmlnZ2VyV2hlblN0YWJsZSgpKSxcbiAgICAgIHRoaXMucmVjYWxjdWxhdGVSYW5nZSQucGlwZShvbmx5VHJpZ2dlcldoZW5TdGFibGUoKSwgc3RhcnRXaXRoKHZvaWQgMCkpLFxuICAgIF0pXG4gICAgICAucGlwZShcbiAgICAgICAgLy8gbWFrZSBzdXJlIHRvIG5vdCBvdmVyIGNhbGN1bGF0ZSB0aGluZ3MgYnkgY29hbGVzY2luZyBhbGwgdHJpZ2dlcnMgdG8gdGhlIG5leHQgbWljcm90YXNrXG4gICAgICAgIGNvYWxlc2NlV2l0aCh1bnBhdGNoZWRNaWNyb1Rhc2soKSksXG4gICAgICAgIG1hcCgoKSA9PiB7XG4gICAgICAgICAgY29uc3QgcmFuZ2UgPSB7IHN0YXJ0OiAwLCBlbmQ6IDAgfTtcbiAgICAgICAgICBjb25zdCBkZWx0YSA9IHRoaXMuc2Nyb2xsVG9wIC0gdGhpcy5hbmNob3JTY3JvbGxUb3A7XG4gICAgICAgICAgaWYgKHRoaXMuc2Nyb2xsVG9wID09PSAwKSB7XG4gICAgICAgICAgICB0aGlzLmFuY2hvckl0ZW0gPSB7IGluZGV4OiAwLCBvZmZzZXQ6IDAgfTtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdGhpcy5hbmNob3JJdGVtID0gdGhpcy5jYWxjdWxhdGVBbmNob3JlZEl0ZW0oXG4gICAgICAgICAgICAgIHRoaXMuYW5jaG9ySXRlbSxcbiAgICAgICAgICAgICAgZGVsdGEsXG4gICAgICAgICAgICApO1xuICAgICAgICAgIH1cbiAgICAgICAgICB0aGlzLmFuY2hvclNjcm9sbFRvcCA9IHRoaXMuc2Nyb2xsVG9wO1xuICAgICAgICAgIHRoaXMuc2Nyb2xsZWRJbmRleCA9IHRoaXMuYW5jaG9ySXRlbS5pbmRleDtcbiAgICAgICAgICB0aGlzLmxhc3RTY3JlZW5JdGVtID0gdGhpcy5jYWxjdWxhdGVBbmNob3JlZEl0ZW0oXG4gICAgICAgICAgICB0aGlzLmFuY2hvckl0ZW0sXG4gICAgICAgICAgICBjYWxjdWxhdGVWaXNpYmxlQ29udGFpbmVyU2l6ZShcbiAgICAgICAgICAgICAgdGhpcy5jb250YWluZXJTaXplLFxuICAgICAgICAgICAgICB0aGlzLnNjcm9sbFRvcFdpdGhPdXRPZmZzZXQsXG4gICAgICAgICAgICAgIHRoaXMuc2Nyb2xsVG9wQWZ0ZXJPZmZzZXQsXG4gICAgICAgICAgICApLFxuICAgICAgICAgICk7XG4gICAgICAgICAgaWYgKHRoaXMuZGlyZWN0aW9uID09PSAndXAnKSB7XG4gICAgICAgICAgICByYW5nZS5zdGFydCA9IE1hdGgubWF4KDAsIHRoaXMuYW5jaG9ySXRlbS5pbmRleCAtIHRoaXMucnVud2F5SXRlbXMpO1xuICAgICAgICAgICAgcmFuZ2UuZW5kID0gTWF0aC5taW4oXG4gICAgICAgICAgICAgIHRoaXMuY29udGVudExlbmd0aCxcbiAgICAgICAgICAgICAgdGhpcy5sYXN0U2NyZWVuSXRlbS5pbmRleCArIHRoaXMucnVud2F5SXRlbXNPcHBvc2l0ZSxcbiAgICAgICAgICAgICk7XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHJhbmdlLnN0YXJ0ID0gTWF0aC5tYXgoXG4gICAgICAgICAgICAgIDAsXG4gICAgICAgICAgICAgIHRoaXMuYW5jaG9ySXRlbS5pbmRleCAtIHRoaXMucnVud2F5SXRlbXNPcHBvc2l0ZSxcbiAgICAgICAgICAgICk7XG4gICAgICAgICAgICByYW5nZS5lbmQgPSBNYXRoLm1pbihcbiAgICAgICAgICAgICAgdGhpcy5jb250ZW50TGVuZ3RoLFxuICAgICAgICAgICAgICB0aGlzLmxhc3RTY3JlZW5JdGVtLmluZGV4ICsgdGhpcy5ydW53YXlJdGVtcyxcbiAgICAgICAgICAgICk7XG4gICAgICAgICAgfVxuICAgICAgICAgIGlmICh0aGlzLmFwcGVuZE9ubHkpIHtcbiAgICAgICAgICAgIHJhbmdlLnN0YXJ0ID0gTWF0aC5taW4odGhpcy5fcmVuZGVyZWRSYW5nZS5zdGFydCwgcmFuZ2Uuc3RhcnQpO1xuICAgICAgICAgICAgcmFuZ2UuZW5kID0gTWF0aC5tYXgodGhpcy5fcmVuZGVyZWRSYW5nZS5lbmQsIHJhbmdlLmVuZCk7XG4gICAgICAgICAgfVxuICAgICAgICAgIHJldHVybiByYW5nZTtcbiAgICAgICAgfSksXG4gICAgICApXG4gICAgICAucGlwZSh0aGlzLnVudGlsJCgpKVxuICAgICAgLnN1YnNjcmliZSgocmFuZ2U6IExpc3RSYW5nZSkgPT4ge1xuICAgICAgICB0aGlzLnJlbmRlcmVkUmFuZ2UgPSByYW5nZTtcbiAgICAgICAgdGhpcy5pc1N0YWJsZSQubmV4dCghdGhpcy53YWl0Rm9yU2Nyb2xsKTtcbiAgICAgIH0pO1xuICB9XG5cbiAgLyoqXG4gICAqIHBvc2l0aW9uIGVsZW1lbnRzIGFmdGVyIHRoZXkgYXJlIGNyZWF0ZWQvdXBkYXRlZC9tb3ZlZCBvciB0aGVpciBkaW1lbnNpb25zXG4gICAqIGNoYW5nZSBmcm9tIG90aGVyIHNvdXJjZXNcbiAgICogQGludGVybmFsXG4gICAqL1xuICBwcml2YXRlIHBvc2l0aW9uRWxlbWVudHMoKTogdm9pZCB7XG4gICAgY29uc3Qgdmlld3NUb09ic2VydmUkID0gbmV3IFN1YmplY3Q8XG4gICAgICBFbWJlZGRlZFZpZXdSZWY8UnhWaXJ0dWFsRm9yVmlld0NvbnRleHQ8VCwgVT4+XG4gICAgPigpO1xuICAgIGNvbnN0IHBvc2l0aW9uQnlJdGVyYWJsZUNoYW5nZSQgPSB0aGlzLnZpZXdSZXBlYXRlciEucmVuZGVyaW5nU3RhcnQkLnBpcGUoXG4gICAgICBzd2l0Y2hNYXAoKGJhdGNoZWRVcGRhdGVzKSA9PiB7XG4gICAgICAgIC8vIGluaXRpYWxJbmRleCB0ZWxscyB1cyB3aGF0IHdpbGwgYmUgdGhlIGZpcnN0IGluZGV4IHRvIGJlIGNoYW5nZSBkZXRlY3RlZFxuICAgICAgICAvLyBpZiBpdCdzIG5vdCB0aGUgZmlyc3Qgb25lLCB3ZSBtYXliZSBoYXZlIHRvIGFkanVzdCB0aGUgcG9zaXRpb25cbiAgICAgICAgLy8gb2YgYWxsIGl0ZW1zIGluIHRoZSB2aWV3cG9ydCBiZWZvcmUgdGhpcyBpbmRleFxuICAgICAgICBjb25zdCBpbml0aWFsSW5kZXggPSBiYXRjaGVkVXBkYXRlcy5zaXplXG4gICAgICAgICAgPyBiYXRjaGVkVXBkYXRlcy52YWx1ZXMoKS5uZXh0KCkudmFsdWUgKyB0aGlzLnJlbmRlcmVkUmFuZ2Uuc3RhcnRcbiAgICAgICAgICA6IHRoaXMucmVuZGVyZWRSYW5nZS5zdGFydDtcbiAgICAgICAgbGV0IHBvc2l0aW9uID0gMDtcbiAgICAgICAgbGV0IHNjcm9sbFRvQW5jaG9yUG9zaXRpb246IG51bWJlciB8IG51bGwgPSBudWxsO1xuICAgICAgICByZXR1cm4gdGhpcy52aWV3UmVwZWF0ZXIhLnZpZXdSZW5kZXJlZCQucGlwZShcbiAgICAgICAgICB0YXAoKHsgdmlldywgaW5kZXg6IHZpZXdJbmRleCwgaXRlbSB9KSA9PiB7XG4gICAgICAgICAgICBjb25zdCBpdGVtSW5kZXggPSB2aWV3LmNvbnRleHQuaW5kZXg7XG4gICAgICAgICAgICAvLyB0aGlzIG1vc3Qgb2YgdGhlIHRpbWUgY2F1c2VzIGEgZm9yY2VkIHJlZmxvdyBwZXIgcmVuZGVyZWQgdmlldy5cbiAgICAgICAgICAgIC8vIGl0IGRvZXNuJ3Qgc291bmQgZ29vZCwgYnV0IGl0J3Mgc3RpbGwgd2F5IG1vcmUgc3RhYmxlIHRoYW5cbiAgICAgICAgICAgIC8vIGhhdmluZyBvbmUgbGFyZ2UgcmVmbG93IGluIGEgbWljcm90YXNrIGFmdGVyIHRoZSBhY3R1YWxcbiAgICAgICAgICAgIC8vIHNjaGVkdWxlciB0aWNrLlxuICAgICAgICAgICAgLy8gUmlnaHQgaGVyZSwgd2UgY2FuIGluc2VydCB3b3JrIGludG8gdGhlIHRhc2sgd2hpY2ggaXMgY3VycmVudGx5XG4gICAgICAgICAgICAvLyBleGVjdXRlZCBhcyBwYXJ0IG9mIHRoZSBjb25jdXJyZW50IHNjaGVkdWxlciB0aWNrLlxuICAgICAgICAgICAgLy8gY2F1c2luZyB0aGUgZm9yY2VkIHJlZmxvdyBoZXJlLCBhbHNvIG1ha2VzIGl0IGNvdW50IGZvciB0aGVcbiAgICAgICAgICAgIC8vIHNjaGVkdWxlcnMgZnJhbWUgYnVkZ2V0LiBUaGlzIHdheSB3ZSB3aWxsIGFsd2F5cyBydW4gd2l0aCB0aGVcbiAgICAgICAgICAgIC8vIGNvbmZpZ3VyZWQgRlBTLiBUaGUgb25seSBjYXNlIHdoZXJlIHRoaXMgaXMgbm90IHRydWUgaXMgd2hlbiByZW5kZXJpbmcgMSBzaW5nbGUgdmlld1xuICAgICAgICAgICAgLy8gYWxyZWFkeSBleHBsb2RlcyB0aGUgYnVkZ2V0XG4gICAgICAgICAgICBjb25zdCBbLCBzaXplRGlmZl0gPSB0aGlzLnVwZGF0ZUVsZW1lbnRTaXplKHZpZXcsIGl0ZW1JbmRleCk7XG4gICAgICAgICAgICBjb25zdCB2aXJ0dWFsSXRlbSA9IHRoaXMuX3ZpcnR1YWxJdGVtc1tpdGVtSW5kZXhdO1xuXG4gICAgICAgICAgICAvLyBiZWZvcmUgcG9zaXRpb25pbmcgdGhlIGZpcnN0IHZpZXcgb2YgdGhpcyBiYXRjaCwgY2FsY3VsYXRlIHRoZVxuICAgICAgICAgICAgLy8gYW5jaG9yU2Nyb2xsVG9wICYgaW5pdGlhbCBwb3NpdGlvbiBvZiB0aGUgdmlld1xuICAgICAgICAgICAgaWYgKGl0ZW1JbmRleCA9PT0gaW5pdGlhbEluZGV4KSB7XG4gICAgICAgICAgICAgIHRoaXMuY2FsY0FuY2hvclNjcm9sbFRvcCgpO1xuICAgICAgICAgICAgICBwb3NpdGlvbiA9IHRoaXMuY2FsY0luaXRpYWxQb3NpdGlvbihpdGVtSW5kZXgpO1xuXG4gICAgICAgICAgICAgIC8vIGlmIHdlIHJlY2VpdmUgYSBwYXJ0aWFsIHVwZGF0ZSBhbmQgdGhlIGN1cnJlbnQgdmlld3MgcG9zaXRpb24gaXNcbiAgICAgICAgICAgICAgLy8gbmV3LCB3ZSBjYW4gc2FmZWx5IGFzc3VtZSB0aGF0IGFsbCBwb3NpdGlvbnMgZnJvbSB2aWV3cyBiZWZvcmUgdGhlIGN1cnJlbnRcbiAgICAgICAgICAgICAgLy8gaW5kZXggYXJlIGFsc28gb2ZmLiBXZSBuZWVkIHRvIGFkanVzdCB0aGVtXG4gICAgICAgICAgICAgIGlmIChcbiAgICAgICAgICAgICAgICBpbml0aWFsSW5kZXggPiB0aGlzLnJlbmRlcmVkUmFuZ2Uuc3RhcnQgJiZcbiAgICAgICAgICAgICAgICB2aXJ0dWFsSXRlbS5wb3NpdGlvbiAhPT0gcG9zaXRpb25cbiAgICAgICAgICAgICAgKSB7XG4gICAgICAgICAgICAgICAgbGV0IGJlZm9yZVBvc2l0aW9uID0gcG9zaXRpb247XG4gICAgICAgICAgICAgICAgbGV0IGkgPSBpbml0aWFsSW5kZXggLSAxO1xuICAgICAgICAgICAgICAgIHdoaWxlIChpID49IHRoaXMucmVuZGVyZWRSYW5nZS5zdGFydCkge1xuICAgICAgICAgICAgICAgICAgY29uc3QgdmlldyA9IHRoaXMuZ2V0Vmlld1JlZihpIC0gdGhpcy5yZW5kZXJlZFJhbmdlLnN0YXJ0KTtcbiAgICAgICAgICAgICAgICAgIGNvbnN0IHZpcnR1YWxJdGVtID0gdGhpcy5fdmlydHVhbEl0ZW1zW2ldO1xuICAgICAgICAgICAgICAgICAgY29uc3QgZWxlbWVudCA9IHRoaXMuZ2V0RWxlbWVudCh2aWV3KTtcbiAgICAgICAgICAgICAgICAgIGJlZm9yZVBvc2l0aW9uIC09IHZpcnR1YWxJdGVtLnNpemU7XG4gICAgICAgICAgICAgICAgICB2aXJ0dWFsSXRlbS5wb3NpdGlvbiA9IGJlZm9yZVBvc2l0aW9uO1xuICAgICAgICAgICAgICAgICAgdGhpcy5wb3NpdGlvbkVsZW1lbnQoZWxlbWVudCwgYmVmb3JlUG9zaXRpb24pO1xuICAgICAgICAgICAgICAgICAgaS0tO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSBlbHNlIGlmIChpdGVtSW5kZXggPCB0aGlzLmFuY2hvckl0ZW0uaW5kZXggJiYgc2l6ZURpZmYpIHtcbiAgICAgICAgICAgICAgdGhpcy5hbmNob3JTY3JvbGxUb3AgKz0gc2l6ZURpZmY7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBjb25zdCBzaXplID0gdmlydHVhbEl0ZW0uc2l6ZTtcbiAgICAgICAgICAgIC8vIHBvc2l0aW9uIGN1cnJlbnQgZWxlbWVudCBpZiB3ZSBuZWVkIHRvXG4gICAgICAgICAgICBpZiAodmlydHVhbEl0ZW0ucG9zaXRpb24gIT09IHBvc2l0aW9uKSB7XG4gICAgICAgICAgICAgIGNvbnN0IGVsZW1lbnQgPSB0aGlzLmdldEVsZW1lbnQodmlldyk7XG4gICAgICAgICAgICAgIHRoaXMucG9zaXRpb25FbGVtZW50KGVsZW1lbnQsIHBvc2l0aW9uKTtcbiAgICAgICAgICAgICAgdmlydHVhbEl0ZW0ucG9zaXRpb24gPSBwb3NpdGlvbjtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmICh0aGlzLl9zY3JvbGxUb0luZGV4ID09PSBpdGVtSW5kZXgpIHtcbiAgICAgICAgICAgICAgc2Nyb2xsVG9BbmNob3JQb3NpdGlvbiA9IHBvc2l0aW9uO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcG9zaXRpb24gKz0gc2l6ZTtcbiAgICAgICAgICAgIC8vIGltbWVkaWF0ZWx5IGFjdGl2YXRlIHRoZSBSZXNpemVPYnNlcnZlciBhZnRlciBpbml0aWFsIHBvc2l0aW9uaW5nXG4gICAgICAgICAgICB2aWV3c1RvT2JzZXJ2ZSQubmV4dCh2aWV3KTtcbiAgICAgICAgICAgIHRoaXMudmlld1JlbmRlckNhbGxiYWNrLm5leHQoe1xuICAgICAgICAgICAgICBpbmRleDogaXRlbUluZGV4LFxuICAgICAgICAgICAgICB2aWV3LFxuICAgICAgICAgICAgICBpdGVtLFxuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAvLyBhZnRlciBwb3NpdGlvbmluZyB0aGUgYWN0dWFsIHZpZXcsIHdlIGFsc28gbmVlZCB0byBwb3NpdGlvbiBhbGxcbiAgICAgICAgICAgIC8vIHZpZXdzIGZyb20gdGhlIGN1cnJlbnQgaW5kZXggb24gdW50aWwgZWl0aGVyIHRoZSByZW5kZXJlZFJhbmdlLmVuZFxuICAgICAgICAgICAgLy8gaXMgaGl0IG9yIHdlIGhpdCBhbiBpbmRleCB0aGF0IHdpbGwgYW55d2F5IHJlY2VpdmUgYW4gdXBkYXRlLlxuICAgICAgICAgICAgLy8gd2UgY2FuIGRlcml2ZSB0aGF0IGluZm9ybWF0aW9uIGZyb20gdGhlIGJhdGNoZWRVcGRhdGVzIGluZGV4IFNldFxuICAgICAgICAgICAgY29uc3QgeyBsYXN0UG9zaXRpb25lZEluZGV4OiBsYXN0SW5kZXgsIHBvc2l0aW9uOiBuZXdQb3NpdGlvbiB9ID1cbiAgICAgICAgICAgICAgdGhpcy5wb3NpdGlvblVuY2hhbmdlZFZpZXdzKHtcbiAgICAgICAgICAgICAgICB2aWV3SW5kZXgsXG4gICAgICAgICAgICAgICAgaXRlbUluZGV4LFxuICAgICAgICAgICAgICAgIGJhdGNoZWRVcGRhdGVzLFxuICAgICAgICAgICAgICAgIHBvc2l0aW9uLFxuICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIHBvc2l0aW9uID0gbmV3UG9zaXRpb247XG4gICAgICAgICAgICB0aGlzLnBvc2l0aW9uZWRSYW5nZS5zdGFydCA9IHRoaXMucmVuZGVyZWRSYW5nZS5zdGFydDtcbiAgICAgICAgICAgIHRoaXMucG9zaXRpb25lZFJhbmdlLmVuZCA9IGxhc3RJbmRleCArIDE7XG4gICAgICAgICAgfSksXG4gICAgICAgICAgY29hbGVzY2VXaXRoKHVucGF0Y2hlZE1pY3JvVGFzaygpKSxcbiAgICAgICAgICB0YXAoKCkgPT4ge1xuICAgICAgICAgICAgdGhpcy5hZGp1c3RDb250ZW50U2l6ZShwb3NpdGlvbik7XG4gICAgICAgICAgICBpZiAodGhpcy5fc2Nyb2xsVG9JbmRleCA9PT0gbnVsbCkge1xuICAgICAgICAgICAgICB0aGlzLm1heWJlQWRqdXN0U2Nyb2xsUG9zaXRpb24oKTtcbiAgICAgICAgICAgIH0gZWxzZSBpZiAoc2Nyb2xsVG9BbmNob3JQb3NpdGlvbiAhPSBudWxsKSB7XG4gICAgICAgICAgICAgIGlmIChzY3JvbGxUb0FuY2hvclBvc2l0aW9uICE9PSB0aGlzLmFuY2hvclNjcm9sbFRvcCkge1xuICAgICAgICAgICAgICAgIGlmIChcbiAgICAgICAgICAgICAgICAgIHNjcm9sbFRvQW5jaG9yUG9zaXRpb24gPlxuICAgICAgICAgICAgICAgICAgdGhpcy5jb250ZW50U2l6ZSAtIHRoaXMuY29udGFpbmVyU2l6ZVxuICAgICAgICAgICAgICAgICkge1xuICAgICAgICAgICAgICAgICAgLy8gaWYgdGhlIGFuY2hvckl0ZW1Qb3NpdGlvbiBpcyBsYXJnZXIgdGhhbiB0aGUgbWF4aW11bSBzY3JvbGxQb3MsXG4gICAgICAgICAgICAgICAgICAvLyB3ZSB3YW50IHRvIHNjcm9sbCB1bnRpbCB0aGUgYm90dG9tLlxuICAgICAgICAgICAgICAgICAgLy8gb2YgY291cnNlLCB3ZSBuZWVkIHRvIGJlIHN1cmUgYWxsIHRoZSBpdGVtcyB1bnRpbCB0aGUgZW5kIGFyZSBwb3NpdGlvbmVkXG4gICAgICAgICAgICAgICAgICAvLyB1bnRpbCB3ZSBhcmUgc3VyZSB0aGF0IHdlIG5lZWQgdG8gc2Nyb2xsIHRvIHRoZSBib3R0b21cbiAgICAgICAgICAgICAgICAgIGlmICh0aGlzLnJlbmRlcmVkUmFuZ2UuZW5kID09PSB0aGlzLnBvc2l0aW9uZWRSYW5nZS5lbmQpIHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5fc2Nyb2xsVG9JbmRleCA9IG51bGw7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuc2Nyb2xsVG8odGhpcy5jb250ZW50U2l6ZSk7XG4gICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgIHRoaXMuX3Njcm9sbFRvSW5kZXggPSBudWxsO1xuICAgICAgICAgICAgICAgICAgdGhpcy5zY3JvbGxUbyhzY3JvbGxUb0FuY2hvclBvc2l0aW9uKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgdGhpcy5fc2Nyb2xsVG9JbmRleCA9IG51bGw7XG4gICAgICAgICAgICAgICAgdGhpcy5tYXliZUFkanVzdFNjcm9sbFBvc2l0aW9uKCk7XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9KSxcbiAgICAgICAgKTtcbiAgICAgIH0pLFxuICAgICk7XG4gICAgY29uc3QgcG9zaXRpb25CeVJlc2l6ZU9ic2VydmVyJCA9IHZpZXdzVG9PYnNlcnZlJC5waXBlKFxuICAgICAgZmlsdGVyKCgpID0+IHRoaXMud2l0aFJlc2l6ZU9ic2VydmVyKSxcbiAgICAgIGdyb3VwQnkoKHZpZXdSZWYpID0+IHZpZXdSZWYpLFxuICAgICAgbWVyZ2VNYXAoKG8kKSA9PlxuICAgICAgICBvJC5waXBlKFxuICAgICAgICAgIGV4aGF1c3RNYXAoKHZpZXdSZWYpID0+IHRoaXMub2JzZXJ2ZVZpZXdTaXplJCh2aWV3UmVmKSksXG4gICAgICAgICAgdGFwKChbaW5kZXgsIHZpZXdJbmRleF0pID0+IHtcbiAgICAgICAgICAgIHRoaXMuY2FsY0FuY2hvclNjcm9sbFRvcCgpO1xuICAgICAgICAgICAgbGV0IHBvc2l0aW9uID0gdGhpcy5jYWxjSW5pdGlhbFBvc2l0aW9uKGluZGV4KTtcbiAgICAgICAgICAgIGxldCB2aWV3SWR4ID0gdmlld0luZGV4O1xuICAgICAgICAgICAgaWYgKHRoaXMuX3ZpcnR1YWxJdGVtc1tpbmRleF0ucG9zaXRpb24gIT09IHBvc2l0aW9uKSB7XG4gICAgICAgICAgICAgIC8vIHdlIHdhbnQgdG8gcmVwb3NpdGlvbiB0aGUgd2hvbGUgdmlld3BvcnQsIHdoZW4gdGhlIGN1cnJlbnQgcG9zaXRpb24gaGFzIGNoYW5nZWRcbiAgICAgICAgICAgICAgd2hpbGUgKHZpZXdJZHggPiAwKSB7XG4gICAgICAgICAgICAgICAgdmlld0lkeC0tO1xuICAgICAgICAgICAgICAgIHBvc2l0aW9uIC09XG4gICAgICAgICAgICAgICAgICB0aGlzLl92aXJ0dWFsSXRlbXNbdGhpcy5nZXRWaWV3UmVmKHZpZXdJZHgpLmNvbnRleHQuaW5kZXhdXG4gICAgICAgICAgICAgICAgICAgIC5zaXplO1xuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAvLyB3ZSBvbmx5IG5lZWQgdG8gcmVwb3NpdGlvbiBldmVyeXRoaW5nIGZyb20gdGhlIG5leHQgdmlld0luZGV4IG9uXG4gICAgICAgICAgICAgIHZpZXdJZHgrKztcbiAgICAgICAgICAgICAgcG9zaXRpb24gKz0gdGhpcy5fdmlydHVhbEl0ZW1zW2luZGV4XS5zaXplO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgLy8gcG9zaXRpb24gYWxsIHZpZXdzIGZyb20gdGhlIHNwZWNpZmllZCB2aWV3SW5kZXhcbiAgICAgICAgICAgIHdoaWxlICh2aWV3SWR4IDwgdGhpcy52aWV3UmVwZWF0ZXIhLnZpZXdDb250YWluZXIubGVuZ3RoKSB7XG4gICAgICAgICAgICAgIGNvbnN0IHZpZXcgPSB0aGlzLmdldFZpZXdSZWYodmlld0lkeCk7XG4gICAgICAgICAgICAgIGNvbnN0IGl0ZW1JbmRleCA9IHZpZXcuY29udGV4dC5pbmRleDtcbiAgICAgICAgICAgICAgY29uc3QgdmlydHVhbEl0ZW0gPSB0aGlzLl92aXJ0dWFsSXRlbXNbaXRlbUluZGV4XTtcbiAgICAgICAgICAgICAgY29uc3QgZWxlbWVudCA9IHRoaXMuZ2V0RWxlbWVudCh2aWV3KTtcbiAgICAgICAgICAgICAgdGhpcy51cGRhdGVFbGVtZW50U2l6ZSh2aWV3LCBpdGVtSW5kZXgpO1xuICAgICAgICAgICAgICB2aXJ0dWFsSXRlbS5wb3NpdGlvbiA9IHBvc2l0aW9uO1xuICAgICAgICAgICAgICB0aGlzLnBvc2l0aW9uRWxlbWVudChlbGVtZW50LCBwb3NpdGlvbik7XG4gICAgICAgICAgICAgIHBvc2l0aW9uICs9IHZpcnR1YWxJdGVtLnNpemU7XG4gICAgICAgICAgICAgIHZpZXdJZHgrKztcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHRoaXMubWF5YmVBZGp1c3RTY3JvbGxQb3NpdGlvbigpO1xuICAgICAgICAgIH0pLFxuICAgICAgICApLFxuICAgICAgKSxcbiAgICApO1xuICAgIG1lcmdlKHBvc2l0aW9uQnlJdGVyYWJsZUNoYW5nZSQsIHBvc2l0aW9uQnlSZXNpemVPYnNlcnZlciQpXG4gICAgICAucGlwZSh0aGlzLnVudGlsJCgpKVxuICAgICAgLnN1YnNjcmliZSgpO1xuICB9XG5cbiAgLyoqIEBpbnRlcm5hbCAqL1xuICBwcml2YXRlIGFkanVzdENvbnRlbnRTaXplKHBvc2l0aW9uOiBudW1iZXIpIHtcbiAgICBsZXQgbmV3Q29udGVudFNpemUgPSBwb3NpdGlvbjtcbiAgICBmb3IgKGxldCBpID0gdGhpcy5wb3NpdGlvbmVkUmFuZ2UuZW5kOyBpIDwgdGhpcy5fdmlydHVhbEl0ZW1zLmxlbmd0aDsgaSsrKSB7XG4gICAgICBuZXdDb250ZW50U2l6ZSArPSB0aGlzLmdldEl0ZW1TaXplKGkpO1xuICAgIH1cbiAgICB0aGlzLmNvbnRlbnRTaXplID0gbmV3Q29udGVudFNpemU7XG4gIH1cblxuICAvKiogQGludGVybmFsICovXG4gIHByaXZhdGUgb2JzZXJ2ZVZpZXdTaXplJChcbiAgICB2aWV3UmVmOiBFbWJlZGRlZFZpZXdSZWY8UnhWaXJ0dWFsRm9yVmlld0NvbnRleHQ8VCwgVT4+LFxuICApIHtcbiAgICBjb25zdCBlbGVtZW50ID0gdGhpcy5nZXRFbGVtZW50KHZpZXdSZWYpO1xuICAgIHJldHVybiB0aGlzLnJlc2l6ZU9ic2VydmVyXG4gICAgICAub2JzZXJ2ZUVsZW1lbnQoZWxlbWVudCwgdGhpcy5yZXNpemVPYnNlcnZlckNvbmZpZz8ub3B0aW9ucylcbiAgICAgIC5waXBlKFxuICAgICAgICB0YWtlV2hpbGUoXG4gICAgICAgICAgKGV2ZW50KSA9PlxuICAgICAgICAgICAgZXZlbnQudGFyZ2V0LmlzQ29ubmVjdGVkICYmXG4gICAgICAgICAgICAhIXRoaXMuX3ZpcnR1YWxJdGVtc1t2aWV3UmVmLmNvbnRleHQuaW5kZXhdLFxuICAgICAgICApLFxuICAgICAgICBtYXAoKGV2ZW50KSA9PiB7XG4gICAgICAgICAgY29uc3QgaW5kZXggPSB2aWV3UmVmLmNvbnRleHQuaW5kZXg7XG4gICAgICAgICAgY29uc3Qgc2l6ZSA9IE1hdGgucm91bmQodGhpcy5leHRyYWN0U2l6ZShldmVudCkpO1xuICAgICAgICAgIGNvbnN0IGRpZmYgPSBzaXplIC0gdGhpcy5fdmlydHVhbEl0ZW1zW2luZGV4XS5zaXplO1xuICAgICAgICAgIGlmIChkaWZmICE9PSAwKSB7XG4gICAgICAgICAgICB0aGlzLl92aXJ0dWFsSXRlbXNbaW5kZXhdLnNpemUgPSBzaXplO1xuICAgICAgICAgICAgdGhpcy5fdmlydHVhbEl0ZW1zW2luZGV4XS5jYWNoZWQgPSB0cnVlO1xuICAgICAgICAgICAgdGhpcy5jb250ZW50U2l6ZSArPSBkaWZmO1xuICAgICAgICAgICAgcmV0dXJuIFtpbmRleCwgdGhpcy52aWV3UmVwZWF0ZXIhLnZpZXdDb250YWluZXIuaW5kZXhPZih2aWV3UmVmKV07XG4gICAgICAgICAgfVxuICAgICAgICAgIHJldHVybiBudWxsIGFzIHVua25vd24gYXMgW251bWJlciwgbnVtYmVyXTtcbiAgICAgICAgfSksXG4gICAgICAgIGZpbHRlcihcbiAgICAgICAgICAoZGlmZikgPT5cbiAgICAgICAgICAgIGRpZmYgIT09IG51bGwgJiZcbiAgICAgICAgICAgIGRpZmZbMF0gPj0gdGhpcy5wb3NpdGlvbmVkUmFuZ2Uuc3RhcnQgJiZcbiAgICAgICAgICAgIGRpZmZbMF0gPCB0aGlzLnBvc2l0aW9uZWRSYW5nZS5lbmQsXG4gICAgICAgICksXG4gICAgICAgIHRha2VVbnRpbChcbiAgICAgICAgICBtZXJnZShcbiAgICAgICAgICAgIHRoaXMudmlld1JlcGVhdGVyIS52aWV3UmVuZGVyZWQkLFxuICAgICAgICAgICAgdGhpcy52aWV3UmVwZWF0ZXIhLnJlbmRlcmluZ1N0YXJ0JCxcbiAgICAgICAgICApLnBpcGUoXG4gICAgICAgICAgICB0YXAoKCkgPT4ge1xuICAgICAgICAgICAgICAvLyB3ZSBuZWVkIHRvIGNsZWFuIHVwIHRoZSBwb3NpdGlvbiBwcm9wZXJ0eSBmb3Igdmlld3NcbiAgICAgICAgICAgICAgLy8gdGhhdCBmYWxsIG91dCBvZiB0aGUgcmVuZGVyZWRSYW5nZS5cbiAgICAgICAgICAgICAgY29uc3QgaW5kZXggPSB2aWV3UmVmLmNvbnRleHQuaW5kZXg7XG4gICAgICAgICAgICAgIGlmIChcbiAgICAgICAgICAgICAgICB0aGlzLl92aXJ0dWFsSXRlbXNbaW5kZXhdICYmXG4gICAgICAgICAgICAgICAgKGluZGV4IDwgdGhpcy5yZW5kZXJlZFJhbmdlLnN0YXJ0IHx8XG4gICAgICAgICAgICAgICAgICBpbmRleCA+PSB0aGlzLnJlbmRlcmVkUmFuZ2UuZW5kKVxuICAgICAgICAgICAgICApIHtcbiAgICAgICAgICAgICAgICB0aGlzLl92aXJ0dWFsSXRlbXNbaW5kZXhdLnBvc2l0aW9uID0gdW5kZWZpbmVkO1xuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KSxcbiAgICAgICAgICAgIGZpbHRlcihcbiAgICAgICAgICAgICAgKCkgPT4gdGhpcy52aWV3UmVwZWF0ZXIhLnZpZXdDb250YWluZXIuaW5kZXhPZih2aWV3UmVmKSA9PT0gLTEsXG4gICAgICAgICAgICApLFxuICAgICAgICAgICksXG4gICAgICAgICksXG4gICAgICApO1xuICB9XG5cbiAgLyoqXG4gICAqIEBpbnRlcm5hbFxuICAgKiBoZWF2aWx5IGluc3BpcmVkIGJ5XG4gICAqICAgaHR0cHM6Ly9naXRodWIuY29tL0dvb2dsZUNocm9tZUxhYnMvdWktZWxlbWVudC1zYW1wbGVzL2Jsb2IvZ2gtcGFnZXMvaW5maW5pdGUtc2Nyb2xsZXIvc2NyaXB0cy9pbmZpbml0ZS1zY3JvbGwuanNcbiAgICovXG4gIHByaXZhdGUgY2FsY3VsYXRlQW5jaG9yZWRJdGVtKFxuICAgIGluaXRpYWxBbmNob3I6IEFuY2hvckl0ZW0sXG4gICAgZGVsdGE6IG51bWJlcixcbiAgKTogQW5jaG9ySXRlbSB7XG4gICAgaWYgKGRlbHRhID09PSAwKSByZXR1cm4gaW5pdGlhbEFuY2hvcjtcbiAgICBkZWx0YSArPSBpbml0aWFsQW5jaG9yLm9mZnNldDtcbiAgICBsZXQgaSA9IGluaXRpYWxBbmNob3IuaW5kZXg7XG4gICAgY29uc3QgaXRlbXMgPSB0aGlzLl92aXJ0dWFsSXRlbXM7XG4gICAgaWYgKGRlbHRhIDwgMCkge1xuICAgICAgd2hpbGUgKGRlbHRhIDwgMCAmJiBpID4gMCkge1xuICAgICAgICBkZWx0YSArPSB0aGlzLmdldEl0ZW1TaXplKGkgLSAxKTtcbiAgICAgICAgaS0tO1xuICAgICAgfVxuICAgIH0gZWxzZSB7XG4gICAgICB3aGlsZSAoZGVsdGEgPiAwICYmIGkgPCBpdGVtcy5sZW5ndGggJiYgdGhpcy5nZXRJdGVtU2l6ZShpKSA8PSBkZWx0YSkge1xuICAgICAgICBkZWx0YSAtPSB0aGlzLmdldEl0ZW1TaXplKGkpO1xuICAgICAgICBpKys7XG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiB7XG4gICAgICBpbmRleDogTWF0aC5taW4oaSwgaXRlbXMubGVuZ3RoKSxcbiAgICAgIG9mZnNldDogZGVsdGEsXG4gICAgfTtcbiAgfVxuXG4gIC8qKiBAaW50ZXJuYWwgKi9cbiAgcHJpdmF0ZSBwb3NpdGlvblVuY2hhbmdlZFZpZXdzKHtcbiAgICB2aWV3SW5kZXgsXG4gICAgaXRlbUluZGV4LFxuICAgIGJhdGNoZWRVcGRhdGVzLFxuICAgIHBvc2l0aW9uLFxuICB9OiB7XG4gICAgdmlld0luZGV4OiBudW1iZXI7XG4gICAgaXRlbUluZGV4OiBudW1iZXI7XG4gICAgYmF0Y2hlZFVwZGF0ZXM6IFNldDxudW1iZXI+O1xuICAgIHBvc2l0aW9uOiBudW1iZXI7XG4gIH0pOiB7IHBvc2l0aW9uOiBudW1iZXI7IGxhc3RQb3NpdGlvbmVkSW5kZXg6IG51bWJlciB9IHtcbiAgICBsZXQgX3ZpZXdJbmRleCA9IHZpZXdJbmRleCArIDE7XG4gICAgbGV0IGluZGV4ID0gaXRlbUluZGV4ICsgMTtcbiAgICBsZXQgbGFzdFBvc2l0aW9uZWRJbmRleCA9IGl0ZW1JbmRleDtcbiAgICB3aGlsZSAoIWJhdGNoZWRVcGRhdGVzLmhhcyhfdmlld0luZGV4KSAmJiBpbmRleCA8IHRoaXMucmVuZGVyZWRSYW5nZS5lbmQpIHtcbiAgICAgIGNvbnN0IHZpcnR1YWxJdGVtID0gdGhpcy5fdmlydHVhbEl0ZW1zW2luZGV4XTtcbiAgICAgIGlmIChwb3NpdGlvbiAhPT0gdmlydHVhbEl0ZW0ucG9zaXRpb24pIHtcbiAgICAgICAgY29uc3QgdmlldyA9IHRoaXMuZ2V0Vmlld1JlZihfdmlld0luZGV4KTtcbiAgICAgICAgY29uc3QgZWxlbWVudCA9IHRoaXMuZ2V0RWxlbWVudCh2aWV3KTtcbiAgICAgICAgdGhpcy5wb3NpdGlvbkVsZW1lbnQoZWxlbWVudCwgcG9zaXRpb24pO1xuICAgICAgICB2aXJ0dWFsSXRlbS5wb3NpdGlvbiA9IHBvc2l0aW9uO1xuICAgICAgfVxuICAgICAgcG9zaXRpb24gKz0gdmlydHVhbEl0ZW0uc2l6ZTtcbiAgICAgIGxhc3RQb3NpdGlvbmVkSW5kZXggPSBpbmRleDtcbiAgICAgIGluZGV4Kys7XG4gICAgICBfdmlld0luZGV4Kys7XG4gICAgfVxuICAgIHJldHVybiB7IHBvc2l0aW9uLCBsYXN0UG9zaXRpb25lZEluZGV4IH07XG4gIH1cblxuICAvKipcbiAgICogQWRqdXN0IHRoZSBzY3JvbGwgcG9zaXRpb24gd2hlbiB0aGUgYW5jaG9yU2Nyb2xsVG9wIGRpZmZlcnMgZnJvbVxuICAgKiB0aGUgYWN0dWFsIHNjcm9sbFRvcC5cbiAgICogVHJpZ2dlciBhIHJhbmdlIHJlY2FsY3VsYXRpb24gaWYgdGhlcmUgaXMgZW1wdHkgc3BhY2VcbiAgICpcbiAgICogQGludGVybmFsXG4gICAqL1xuICBwcml2YXRlIG1heWJlQWRqdXN0U2Nyb2xsUG9zaXRpb24oKTogdm9pZCB7XG4gICAgaWYgKHRoaXMuYW5jaG9yU2Nyb2xsVG9wICE9PSB0aGlzLnNjcm9sbFRvcCkge1xuICAgICAgdGhpcy5zY3JvbGxUbyh0aGlzLmFuY2hvclNjcm9sbFRvcCk7XG4gICAgfVxuICB9XG5cbiAgLyoqIEBpbnRlcm5hbCAqL1xuICBwcml2YXRlIGNhbGNBbmNob3JTY3JvbGxUb3AoKTogdm9pZCB7XG4gICAgdGhpcy5hbmNob3JTY3JvbGxUb3AgPSAwO1xuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdGhpcy5hbmNob3JJdGVtLmluZGV4OyBpKyspIHtcbiAgICAgIHRoaXMuYW5jaG9yU2Nyb2xsVG9wICs9IHRoaXMuZ2V0SXRlbVNpemUoaSk7XG4gICAgfVxuICAgIHRoaXMuYW5jaG9yU2Nyb2xsVG9wICs9IHRoaXMuYW5jaG9ySXRlbS5vZmZzZXQ7XG4gIH1cblxuICAvKiogQGludGVybmFsICovXG4gIHByaXZhdGUgY2FsY0luaXRpYWxQb3NpdGlvbihzdGFydDogbnVtYmVyKTogbnVtYmVyIHtcbiAgICAvLyBDYWxjdWxhdGUgcG9zaXRpb24gb2Ygc3RhcnRpbmcgbm9kZVxuICAgIGxldCBwb3MgPSB0aGlzLmFuY2hvclNjcm9sbFRvcCAtIHRoaXMuYW5jaG9ySXRlbS5vZmZzZXQ7XG4gICAgbGV0IGkgPSB0aGlzLmFuY2hvckl0ZW0uaW5kZXg7XG4gICAgd2hpbGUgKGkgPiBzdGFydCkge1xuICAgICAgY29uc3QgaXRlbVNpemUgPSB0aGlzLmdldEl0ZW1TaXplKGkgLSAxKTtcbiAgICAgIHBvcyAtPSBpdGVtU2l6ZTtcbiAgICAgIGktLTtcbiAgICB9XG4gICAgd2hpbGUgKGkgPCBzdGFydCkge1xuICAgICAgY29uc3QgaXRlbVNpemUgPSB0aGlzLmdldEl0ZW1TaXplKGkpO1xuICAgICAgcG9zICs9IGl0ZW1TaXplO1xuICAgICAgaSsrO1xuICAgIH1cbiAgICByZXR1cm4gcG9zO1xuICB9XG5cbiAgLyoqIEBpbnRlcm5hbCAqL1xuICBwcml2YXRlIGdldFZpZXdSZWYoXG4gICAgaW5kZXg6IG51bWJlcixcbiAgKTogRW1iZWRkZWRWaWV3UmVmPFJ4VmlydHVhbEZvclZpZXdDb250ZXh0PFQsIFU+PiB7XG4gICAgcmV0dXJuIDxFbWJlZGRlZFZpZXdSZWY8UnhWaXJ0dWFsRm9yVmlld0NvbnRleHQ8VCwgVT4+PihcbiAgICAgIHRoaXMudmlld1JlcGVhdGVyIS52aWV3Q29udGFpbmVyLmdldChpbmRleCkhXG4gICAgKTtcbiAgfVxuXG4gIC8qKiBAaW50ZXJuYWwgKi9cbiAgcHJpdmF0ZSB1cGRhdGVFbGVtZW50U2l6ZShcbiAgICB2aWV3OiBFbWJlZGRlZFZpZXdSZWY8YW55PixcbiAgICBpbmRleDogbnVtYmVyLFxuICApOiBbbnVtYmVyLCBudW1iZXJdIHtcbiAgICBjb25zdCBvbGRTaXplID0gdGhpcy5nZXRJdGVtU2l6ZShpbmRleCk7XG4gICAgY29uc3QgaXNDYWNoZWQgPSB0aGlzLl92aXJ0dWFsSXRlbXNbaW5kZXhdLmNhY2hlZDtcbiAgICBjb25zdCBzaXplID0gaXNDYWNoZWRcbiAgICAgID8gb2xkU2l6ZVxuICAgICAgOiB0aGlzLmdldEVsZW1lbnRTaXplKHRoaXMuZ2V0RWxlbWVudCh2aWV3KSk7XG4gICAgdGhpcy5fdmlydHVhbEl0ZW1zW2luZGV4XS5zaXplID0gc2l6ZTtcbiAgICB0aGlzLl92aXJ0dWFsSXRlbXNbaW5kZXhdLmNhY2hlZCA9IHRydWU7XG4gICAgcmV0dXJuIFtzaXplLCBzaXplIC0gb2xkU2l6ZV07XG4gIH1cblxuICAvKiogQGludGVybmFsICovXG4gIHByaXZhdGUgZ2V0SXRlbVNpemUoaW5kZXg6IG51bWJlcik6IG51bWJlciB7XG4gICAgcmV0dXJuIHRoaXMuX3ZpcnR1YWxJdGVtc1tpbmRleF0uc2l6ZSB8fCB0aGlzLnRvbWJzdG9uZVNpemU7XG4gIH1cbiAgLyoqIEBpbnRlcm5hbCAqL1xuICBwcml2YXRlIGdldEVsZW1lbnRTaXplKGVsZW1lbnQ6IEhUTUxFbGVtZW50KTogbnVtYmVyIHtcbiAgICByZXR1cm4gZWxlbWVudC5vZmZzZXRIZWlnaHQ7XG4gIH1cbiAgLyoqIEBpbnRlcm5hbCAqL1xuICBwcml2YXRlIHBvc2l0aW9uRWxlbWVudChlbGVtZW50OiBIVE1MRWxlbWVudCwgc2Nyb2xsVG9wOiBudW1iZXIpOiB2b2lkIHtcbiAgICBlbGVtZW50LnN0eWxlLnBvc2l0aW9uID0gJ2Fic29sdXRlJztcbiAgICBlbGVtZW50LnN0eWxlLnRyYW5zZm9ybSA9IGB0cmFuc2xhdGVZKCR7c2Nyb2xsVG9wfXB4KWA7XG4gIH1cblxuICAvKiogQGludGVybmFsICovXG4gIHByaXZhdGUgdXBkYXRlU2Nyb2xsRWxlbWVudENsYXNzKGZvcmNlID0gdGhpcy53aXRoU3luY1Njcm9sbGJhcik6IHZvaWQge1xuICAgIGNvbnN0IHNjcm9sbEVsZW1lbnQgPSB0aGlzLnZpZXdwb3J0Py5nZXRTY3JvbGxFbGVtZW50Py4oKTtcbiAgICBpZiAoXG4gICAgICAhIXNjcm9sbEVsZW1lbnQgJiZcbiAgICAgIHNjcm9sbEVsZW1lbnQuY2xhc3NMaXN0LmNvbnRhaW5zKCdyeC12aXJ0dWFsLXNjcm9sbC1lbGVtZW50JylcbiAgICApIHtcbiAgICAgIHNjcm9sbEVsZW1lbnQuY2xhc3NMaXN0LnRvZ2dsZShcbiAgICAgICAgJ3J4LXZpcnR1YWwtc2Nyb2xsLWVsZW1lbnQtLXdpdGhTeW5jU2Nyb2xsYmFyJyxcbiAgICAgICAgZm9yY2UsXG4gICAgICApO1xuICAgIH1cbiAgfVxufVxuIl19