import { Directive, inject, Input, } from '@angular/core';
import { coalesceWith } from '@rx-angular/cdk/coalescing';
import { combineLatest, ReplaySubject, Subject, } from 'rxjs';
import { distinctUntilChanged, filter, map, shareReplay, startWith, switchMap, takeUntil, tap, } from 'rxjs/operators';
import { RxVirtualScrollStrategy, } from '../model';
import { calculateVisibleContainerSize, parseScrollTopBoundaries, toBoolean, unpatchedMicroTask, } from '../util';
import { DEFAULT_ITEM_SIZE, DEFAULT_RUNWAY_ITEMS, DEFAULT_RUNWAY_ITEMS_OPPOSITE, RX_VIRTUAL_SCROLL_DEFAULT_OPTIONS, } from '../virtual-scroll.config';
import * as i0 from "@angular/core";
const defaultItemSize = () => DEFAULT_ITEM_SIZE;
/**
 * @Directive DynamicSizeVirtualScrollStrategy
 *
 * @description
 *
 * The `DynamicSizeVirtualScrollStrategy` is very similar to the `AutosizeVirtualScrollStrategy`.
 * It positions items based on a function determining its size.
 *
 * @docsCategory RxVirtualFor
 * @docsPage RxVirtualFor
 * @publicApi
 */
export class DynamicSizeVirtualScrollStrategy extends RxVirtualScrollStrategy {
    defaults = inject(RX_VIRTUAL_SCROLL_DEFAULT_OPTIONS, {
        optional: true,
    });
    /**
     * @description
     * The amount of items to render upfront in scroll direction
     */
    runwayItems = this.defaults?.runwayItems ?? DEFAULT_RUNWAY_ITEMS;
    /**
     * @description
     * The amount of items to render upfront in reverse scroll direction
     */
    runwayItemsOpposite = this.defaults?.runwayItemsOpposite ?? DEFAULT_RUNWAY_ITEMS_OPPOSITE;
    /**
     * @description
     * When enabled, the scroll strategy stops removing views from the viewport,
     * instead it only adds views. This setting can be changed on the fly. Views will be added in both directions
     * according to the user interactions.
     */
    appendOnly = false;
    /**
     * @description
     * If this flag is true, the virtual scroll strategy maintains the scrolled item when new data
     * is prepended to the list. This is very useful when implementing a reversed infinite scroller, that prepends
     * data instead of appending it
     */
    keepScrolledIndexOnPrepend = false;
    /**
     * @description
     * Function returning the size of an item
     */
    set itemSize(fn) {
        if (fn) {
            this._itemSizeFn = fn;
        }
    }
    get itemSize() {
        return this._itemSizeFn;
    }
    _itemSizeFn = defaultItemSize;
    /** @internal */
    waitForScroll = false;
    /** @internal */
    isStable$ = new ReplaySubject(1);
    /** @internal */
    get isStable() {
        return this.isStable$.pipe(filter((w) => w));
    }
    /** @internal */
    viewport = null;
    /** @internal */
    viewRepeater = null;
    /** @internal */
    _contentSize$ = new ReplaySubject(1);
    /** @internal */
    contentSize$ = this._contentSize$.asObservable();
    /** @internal */
    _contentSize = 0;
    /** @internal */
    set contentSize(size) {
        this._contentSize = size;
        this._contentSize$.next(size);
    }
    get contentSize() {
        return this._contentSize;
    }
    /** @internal */
    _renderedRange$ = new ReplaySubject(1);
    /** @internal */
    renderedRange$ = this._renderedRange$.asObservable();
    /** @internal */
    _renderedRange = { start: 0, end: 0 };
    // range of items where size is known and doesn't need to be re-calculated
    /** @internal */
    set renderedRange(range) {
        this._renderedRange = range;
        this._renderedRange$.next(range);
    }
    /** @internal */
    get renderedRange() {
        return this._renderedRange;
    }
    /** @internal */
    _scrolledIndex$ = new ReplaySubject(1);
    /** @internal */
    scrolledIndex$ = this._scrolledIndex$.pipe(distinctUntilChanged());
    _scrolledIndex = 0;
    /** @internal */
    set scrolledIndex(index) {
        this._scrolledIndex = index;
        this._scrolledIndex$.next(index);
    }
    get scrolledIndex() {
        return this._scrolledIndex;
    }
    /** @internal */
    get contentLength() {
        return this._virtualItems.length;
    }
    /** @internal */
    containerSize = 0;
    /** @internal */
    _virtualItems = [];
    /** @internal */
    scrollTop = 0;
    /** @internal */
    scrollTopWithOutOffset = 0;
    /** @internal */
    scrollTopAfterOffset = 0;
    /** @internal */
    viewportOffset = 0;
    /** @internal */
    direction = 'down';
    /** @internal */
    anchorScrollTop = 0;
    /** @internal */
    anchorItem = {
        index: 0,
        offset: 0,
    };
    /** @internal */
    lastScreenItem = {
        index: 0,
        offset: 0,
    };
    /** @internal */
    detached$ = new Subject();
    /** @internal */
    recalculateRange$ = new Subject();
    /** @internal */
    until$() {
        return (o$) => o$.pipe(takeUntil(this.detached$));
    }
    /** @internal */
    ngOnChanges(changes) {
        if ((changes['runwayItemsOpposite'] &&
            !changes['runwayItemsOpposite'].firstChange) ||
            (changes['runwayItems'] && !changes['runwayItems'].firstChange)) {
            this.recalculateRange$.next();
        }
    }
    /** @internal */
    ngOnDestroy() {
        this.detach();
    }
    /** @internal */
    attach(viewport, viewRepeater) {
        this.viewport = viewport;
        this.viewRepeater = viewRepeater;
        this.maintainVirtualItems();
        this.calcRenderedRange();
        this.positionElements();
    }
    /** @internal */
    detach() {
        this.viewport = null;
        this.viewRepeater = null;
        this._virtualItems = [];
        this.detached$.next();
    }
    scrollToIndex(index, behavior) {
        const _index = Math.min(Math.max(index, 0), this.contentLength - 1);
        let scrollTo = 0;
        for (let i = 0; i < _index; i++) {
            scrollTo += this._virtualItems[i].size;
        }
        this.scrollTo(scrollTo, behavior);
    }
    scrollTo(scrollTo, behavior) {
        this.waitForScroll =
            scrollTo !== this.scrollTop && this.contentSize > this.containerSize;
        if (this.waitForScroll) {
            this.isStable$.next(false);
        }
        this.viewport.scrollTo(this.viewportOffset + scrollTo, behavior);
    }
    /** @internal */
    maintainVirtualItems() {
        const valueArray$ = this.viewRepeater.values$.pipe(map((values) => Array.isArray(values)
            ? values
            : values != null
                ? Array.from(values)
                : []), shareReplay({ bufferSize: 1, refCount: true }));
        valueArray$.pipe(this.until$()).subscribe((dataArr) => {
            const dataLength = dataArr.length;
            if (!dataLength) {
                this._virtualItems = [];
                this.contentSize = 0;
                this._renderedRange = {
                    start: 0,
                    end: 0,
                };
                this.anchorItem = {
                    index: 0,
                    offset: 0,
                };
                this.recalculateRange$.next();
            }
            else {
                let shouldRecalculateRange = false;
                let contentSize = 0;
                for (let i = 0; i < dataArr.length; i++) {
                    const oldSize = this._virtualItems[i]?.size;
                    const newSize = this.itemSize(dataArr[i]);
                    contentSize += newSize;
                    if (oldSize === undefined || oldSize !== newSize) {
                        this._virtualItems[i] = { size: newSize };
                        if (!shouldRecalculateRange &&
                            (!this.contentSize ||
                                (i >= this.renderedRange.start && i < this.renderedRange.end))) {
                            shouldRecalculateRange = true;
                        }
                    }
                }
                if (dataLength < this._renderedRange.end) {
                    this.anchorItem = this.calculateAnchoredItem({
                        index: dataLength,
                        offset: 0,
                    }, -calculateVisibleContainerSize(this.containerSize, this.scrollTopWithOutOffset, this.scrollTopAfterOffset));
                    this._renderedRange.start = Math.max(0, this.anchorItem.index - this.runwayItems);
                    this._renderedRange.end = dataLength;
                    this.calcAnchorScrollTop();
                    this.scrollTo(contentSize);
                    this.scrollTop = this.anchorScrollTop;
                }
                this.contentSize = contentSize;
                if (shouldRecalculateRange) {
                    this.recalculateRange$.next();
                }
            }
        });
        let valueCache = {};
        /*
         * when keepScrolledIndexOnPrepend is active, we need to listen to data changes and figure out what was appended
         * before the last scrolledToItem
         */
        valueArray$
            .pipe(
        // TODO: this might cause issues when turning on/off at runtime
        filter(() => this.keepScrolledIndexOnPrepend), this.until$())
            .subscribe((valueArray) => {
            const trackBy = this.viewRepeater._trackBy;
            let scrollTo = this.scrolledIndex;
            const dataLength = valueArray.length;
            const oldDataLength = Object.keys(valueCache).length;
            if (oldDataLength > 0) {
                let i = 0;
                // check for each item from the last known scrolledIndex if it's an insert
                for (i; i <= scrollTo && i < dataLength; i++) {
                    // item is not in the valueCache, so it was added
                    if (!valueCache[trackBy(i, valueArray[i])]) {
                        scrollTo++;
                    }
                }
            }
            valueCache = {};
            valueArray.forEach((v, i) => (valueCache[trackBy(i, v)] = v));
            if (scrollTo !== this.scrolledIndex) {
                this.scrollToIndex(scrollTo);
            }
        });
    }
    /** @internal */
    calcRenderedRange() {
        combineLatest([
            this.viewport.containerRect$.pipe(map(({ height }) => {
                this.containerSize = height;
                return height;
            }), distinctUntilChanged()),
            this.viewport.elementScrolled$.pipe(startWith(void 0), tap(() => {
                this.viewportOffset = this.viewport.measureOffset();
                const { scrollTop, scrollTopWithOutOffset, scrollTopAfterOffset } = parseScrollTopBoundaries(this.viewport.getScrollTop(), this.viewportOffset, this._contentSize, this.containerSize);
                this.direction =
                    scrollTopWithOutOffset > this.scrollTopWithOutOffset
                        ? 'down'
                        : 'up';
                this.scrollTopWithOutOffset = scrollTopWithOutOffset;
                this.scrollTopAfterOffset = scrollTopAfterOffset;
                this.scrollTop = scrollTop;
                this.waitForScroll = false;
            })),
            this._contentSize$.pipe(distinctUntilChanged()),
            this.recalculateRange$.pipe(startWith(void 0)),
        ])
            .pipe(
        // make sure to not over calculate things by coalescing all triggers to the next microtask
        coalesceWith(unpatchedMicroTask()), map(() => {
            const range = { start: 0, end: 0 };
            const length = this.contentLength;
            const delta = this.scrollTop - this.anchorScrollTop;
            if (this.scrollTop == 0) {
                this.anchorItem = { index: 0, offset: 0 };
            }
            else {
                this.anchorItem = this.calculateAnchoredItem(this.anchorItem, delta);
            }
            this.scrolledIndex = this.anchorItem.index;
            this.anchorScrollTop = this.scrollTop;
            this.lastScreenItem = this.calculateAnchoredItem(this.anchorItem, calculateVisibleContainerSize(this.containerSize, this.scrollTopWithOutOffset, this.scrollTopAfterOffset));
            if (this.direction === 'up') {
                range.start = Math.max(0, this.anchorItem.index - this.runwayItems);
                range.end = Math.min(length, this.lastScreenItem.index + this.runwayItemsOpposite);
            }
            else {
                range.start = Math.max(0, this.anchorItem.index - this.runwayItemsOpposite);
                range.end = Math.min(length, this.lastScreenItem.index + this.runwayItems);
            }
            if (this.appendOnly) {
                range.start = Math.min(this._renderedRange.start, range.start);
                range.end = Math.max(this._renderedRange.end, range.end);
            }
            return range;
        }))
            .pipe(this.until$())
            .subscribe((range) => {
            this.renderedRange = range;
            this.isStable$.next(!this.waitForScroll);
        });
    }
    /** @internal */
    positionElements() {
        this.viewRepeater.renderingStart$.pipe(switchMap((batchedUpdates) => {
            const renderedRange = this.renderedRange;
            const adjustIndexWith = renderedRange.start;
            const initialIndex = batchedUpdates.size
                ? batchedUpdates.values().next().value + this.renderedRange.start
                : this.renderedRange.start;
            let position = this.calcInitialPosition(initialIndex);
            return this.viewRepeater.viewRendered$.pipe(tap(({ view, index: viewIndex, item }) => {
                const index = viewIndex + adjustIndexWith;
                const size = this.getItemSize(index);
                this.positionElement(this.getElement(view), position);
                position += size;
                this.viewRenderCallback.next({
                    index,
                    view,
                    item,
                });
            }));
        }), this.until$()).subscribe();
    }
    /**
     * @internal
     * heavily inspired by
     *   https://github.com/GoogleChromeLabs/ui-element-samples/blob/gh-pages/infinite-scroller/scripts/infinite-scroll.js
     */
    calculateAnchoredItem(initialAnchor, delta) {
        if (delta == 0)
            return initialAnchor;
        delta += initialAnchor.offset;
        let i = initialAnchor.index;
        const items = this._virtualItems;
        if (delta < 0) {
            while (delta < 0 && i > 0) {
                delta += items[i - 1].size;
                i--;
            }
        }
        else {
            while (delta > 0 && i < items.length && items[i].size <= delta) {
                delta -= items[i].size;
                i++;
            }
        }
        return {
            index: Math.min(i, items.length),
            offset: delta,
        };
    }
    /** @internal */
    calcInitialPosition(start) {
        // Calculate position of starting node
        let pos = this.anchorScrollTop - this.anchorItem.offset;
        let i = this.anchorItem.index;
        while (i > start) {
            const itemSize = this.getItemSize(i - 1);
            pos -= itemSize;
            i--;
        }
        while (i < start) {
            const itemSize = this.getItemSize(i);
            pos += itemSize;
            i++;
        }
        return pos;
    }
    /** @internal */
    calcAnchorScrollTop() {
        this.anchorScrollTop = 0;
        for (let i = 0; i < this.anchorItem.index; i++) {
            this.anchorScrollTop += this.getItemSize(i);
        }
        this.anchorScrollTop += this.anchorItem.offset;
    }
    /** @internal */
    getItemSize(index) {
        return this._virtualItems[index].size;
    }
    /** @internal */
    positionElement(element, scrollTop) {
        element.style.position = 'absolute';
        element.style.transform = `translateY(${scrollTop}px)`;
    }
    /** @nocollapse */ static ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "18.0.1", ngImport: i0, type: DynamicSizeVirtualScrollStrategy, deps: null, target: i0.ɵɵFactoryTarget.Directive });
    /** @nocollapse */ static ɵdir = i0.ɵɵngDeclareDirective({ minVersion: "16.1.0", version: "18.0.1", type: DynamicSizeVirtualScrollStrategy, isStandalone: true, selector: "rx-virtual-scroll-viewport[dynamic]", inputs: { runwayItems: "runwayItems", runwayItemsOpposite: "runwayItemsOpposite", appendOnly: ["appendOnly", "appendOnly", toBoolean], keepScrolledIndexOnPrepend: ["keepScrolledIndexOnPrepend", "keepScrolledIndexOnPrepend", toBoolean], itemSize: ["dynamic", "itemSize"] }, providers: [
            {
                provide: RxVirtualScrollStrategy,
                useExisting: DynamicSizeVirtualScrollStrategy,
            },
        ], usesInheritance: true, usesOnChanges: true, ngImport: i0 });
}
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "18.0.1", ngImport: i0, type: DynamicSizeVirtualScrollStrategy, decorators: [{
            type: Directive,
            args: [{
                    selector: 'rx-virtual-scroll-viewport[dynamic]',
                    providers: [
                        {
                            provide: RxVirtualScrollStrategy,
                            useExisting: DynamicSizeVirtualScrollStrategy,
                        },
                    ],
                    standalone: true,
                }]
        }], propDecorators: { runwayItems: [{
                type: Input
            }], runwayItemsOpposite: [{
                type: Input
            }], appendOnly: [{
                type: Input,
                args: [{ transform: toBoolean }]
            }], keepScrolledIndexOnPrepend: [{
                type: Input,
                args: [{ transform: toBoolean }]
            }], itemSize: [{
                type: Input,
                args: ['dynamic']
            }] } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZHluYW1pYy1zaXplLXZpcnR1YWwtc2Nyb2xsLXN0cmF0ZWd5LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vLi4vLi4vbGlicy90ZW1wbGF0ZS9leHBlcmltZW50YWwvdmlydHVhbC1zY3JvbGxpbmcvc3JjL2xpYi9zY3JvbGwtc3RyYXRlZ2llcy9keW5hbWljLXNpemUtdmlydHVhbC1zY3JvbGwtc3RyYXRlZ3kudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUNMLFNBQVMsRUFDVCxNQUFNLEVBQ04sS0FBSyxHQUtOLE1BQU0sZUFBZSxDQUFDO0FBQ3ZCLE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSw0QkFBNEIsQ0FBQztBQUMxRCxPQUFPLEVBQ0wsYUFBYSxFQUdiLGFBQWEsRUFDYixPQUFPLEdBQ1IsTUFBTSxNQUFNLENBQUM7QUFDZCxPQUFPLEVBQ0wsb0JBQW9CLEVBQ3BCLE1BQU0sRUFDTixHQUFHLEVBQ0gsV0FBVyxFQUNYLFNBQVMsRUFDVCxTQUFTLEVBQ1QsU0FBUyxFQUNULEdBQUcsR0FDSixNQUFNLGdCQUFnQixDQUFDO0FBQ3hCLE9BQU8sRUFFTCx1QkFBdUIsR0FHeEIsTUFBTSxVQUFVLENBQUM7QUFDbEIsT0FBTyxFQUNMLDZCQUE2QixFQUM3Qix3QkFBd0IsRUFDeEIsU0FBUyxFQUNULGtCQUFrQixHQUNuQixNQUFNLFNBQVMsQ0FBQztBQUNqQixPQUFPLEVBQ0wsaUJBQWlCLEVBQ2pCLG9CQUFvQixFQUNwQiw2QkFBNkIsRUFDN0IsaUNBQWlDLEdBQ2xDLE1BQU0sMEJBQTBCLENBQUM7O0FBYWxDLE1BQU0sZUFBZSxHQUFHLEdBQUcsRUFBRSxDQUFDLGlCQUFpQixDQUFDO0FBRWhEOzs7Ozs7Ozs7OztHQVdHO0FBV0gsTUFBTSxPQUFPLGdDQUlYLFNBQVEsdUJBQTZCO0lBR3BCLFFBQVEsR0FBSSxNQUFNLENBQUMsaUNBQWlDLEVBQUU7UUFDckUsUUFBUSxFQUFFLElBQUk7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LElBQUksQ0FBQztJQUN4QyxDQUFDO0lBRUQsZ0JBQWdCO0lBQ1IsZUFBZSxDQUFDLE9BQW9CLEVBQUUsU0FBaUI7UUFDN0QsT0FBTyxDQUFDLEtBQUssQ0FBQyxRQUFRLEdBQUcsVUFBVSxDQUFDO1FBQ3BDLE9BQU8sQ0FBQyxLQUFLLENBQUMsU0FBUyxHQUFHLGNBQWMsU0FBUyxLQUFLLENBQUM7SUFDekQsQ0FBQzswSEF2ZlUsZ0NBQWdDOzhHQUFoQyxnQ0FBZ0Msa01BOEJ2QixTQUFTLDRGQVFULFNBQVMsbURBOUNsQjtZQUNUO2dCQUNFLE9BQU8sRUFBRSx1QkFBdUI7Z0JBQ2hDLFdBQVcsRUFBRSxnQ0FBZ0M7YUFDOUM7U0FDRjs7MkZBR1UsZ0NBQWdDO2tCQVY1QyxTQUFTO21CQUFDO29CQUNULFFBQVEsRUFBRSxxQ0FBcUM7b0JBQy9DLFNBQVMsRUFBRTt3QkFDVDs0QkFDRSxPQUFPLEVBQUUsdUJBQXVCOzRCQUNoQyxXQUFXLGtDQUFrQzt5QkFDOUM7cUJBQ0Y7b0JBQ0QsVUFBVSxFQUFFLElBQUk7aUJBQ2pCOzhCQWdCVSxXQUFXO3NCQUFuQixLQUFLO2dCQU1HLG1CQUFtQjtzQkFBM0IsS0FBSztnQkFTMkIsVUFBVTtzQkFBMUMsS0FBSzt1QkFBQyxFQUFFLFNBQVMsRUFBRSxTQUFTLEVBQUU7Z0JBUUUsMEJBQTBCO3NCQUExRCxLQUFLO3VCQUFDLEVBQUUsU0FBUyxFQUFFLFNBQVMsRUFBRTtnQkFPM0IsUUFBUTtzQkFEWCxLQUFLO3VCQUFDLFNBQVMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xuICBEaXJlY3RpdmUsXG4gIGluamVjdCxcbiAgSW5wdXQsXG4gIE5nSXRlcmFibGUsXG4gIE9uQ2hhbmdlcyxcbiAgT25EZXN0cm95LFxuICBTaW1wbGVDaGFuZ2VzLFxufSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IGNvYWxlc2NlV2l0aCB9IGZyb20gJ0ByeC1hbmd1bGFyL2Nkay9jb2FsZXNjaW5nJztcbmltcG9ydCB7XG4gIGNvbWJpbmVMYXRlc3QsXG4gIE1vbm9UeXBlT3BlcmF0b3JGdW5jdGlvbixcbiAgT2JzZXJ2YWJsZSxcbiAgUmVwbGF5U3ViamVjdCxcbiAgU3ViamVjdCxcbn0gZnJvbSAncnhqcyc7XG5pbXBvcnQge1xuICBkaXN0aW5jdFVudGlsQ2hhbmdlZCxcbiAgZmlsdGVyLFxuICBtYXAsXG4gIHNoYXJlUmVwbGF5LFxuICBzdGFydFdpdGgsXG4gIHN3aXRjaE1hcCxcbiAgdGFrZVVudGlsLFxuICB0YXAsXG59IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcbmltcG9ydCB7XG4gIExpc3RSYW5nZSxcbiAgUnhWaXJ0dWFsU2Nyb2xsU3RyYXRlZ3ksXG4gIFJ4VmlydHVhbFNjcm9sbFZpZXdwb3J0LFxuICBSeFZpcnR1YWxWaWV3UmVwZWF0ZXIsXG59IGZyb20gJy4uL21vZGVsJztcbmltcG9ydCB7XG4gIGNhbGN1bGF0ZVZpc2libGVDb250YWluZXJTaXplLFxuICBwYXJzZVNjcm9sbFRvcEJvdW5kYXJpZXMsXG4gIHRvQm9vbGVhbixcbiAgdW5wYXRjaGVkTWljcm9UYXNrLFxufSBmcm9tICcuLi91dGlsJztcbmltcG9ydCB7XG4gIERFRkFVTFRfSVRFTV9TSVpFLFxuICBERUZBVUxUX1JVTldBWV9JVEVNUyxcbiAgREVGQVVMVF9SVU5XQVlfSVRFTVNfT1BQT1NJVEUsXG4gIFJYX1ZJUlRVQUxfU0NST0xMX0RFRkFVTFRfT1BUSU9OUyxcbn0gZnJvbSAnLi4vdmlydHVhbC1zY3JvbGwuY29uZmlnJztcblxuLyoqIEBpbnRlcm5hbCAqL1xudHlwZSBWaXJ0dWFsVmlld0l0ZW0gPSB7XG4gIHNpemU6IG51bWJlcjtcbn07XG5cbi8qKiBAaW50ZXJuYWwgKi9cbnR5cGUgQW5jaG9ySXRlbSA9IHtcbiAgaW5kZXg6IG51bWJlcjtcbiAgb2Zmc2V0OiBudW1iZXI7XG59O1xuXG5jb25zdCBkZWZhdWx0SXRlbVNpemUgPSAoKSA9PiBERUZBVUxUX0lURU1fU0laRTtcblxuLyoqXG4gKiBARGlyZWN0aXZlIER5bmFtaWNTaXplVmlydHVhbFNjcm9sbFN0cmF0ZWd5XG4gKlxuICogQGRlc2NyaXB0aW9uXG4gKlxuICogVGhlIGBEeW5hbWljU2l6ZVZpcnR1YWxTY3JvbGxTdHJhdGVneWAgaXMgdmVyeSBzaW1pbGFyIHRvIHRoZSBgQXV0b3NpemVWaXJ0dWFsU2Nyb2xsU3RyYXRlZ3lgLlxuICogSXQgcG9zaXRpb25zIGl0ZW1zIGJhc2VkIG9uIGEgZnVuY3Rpb24gZGV0ZXJtaW5pbmcgaXRzIHNpemUuXG4gKlxuICogQGRvY3NDYXRlZ29yeSBSeFZpcnR1YWxGb3JcbiAqIEBkb2NzUGFnZSBSeFZpcnR1YWxGb3JcbiAqIEBwdWJsaWNBcGlcbiAqL1xuQERpcmVjdGl2ZSh7XG4gIHNlbGVjdG9yOiAncngtdmlydHVhbC1zY3JvbGwtdmlld3BvcnRbZHluYW1pY10nLFxuICBwcm92aWRlcnM6IFtcbiAgICB7XG4gICAgICBwcm92aWRlOiBSeFZpcnR1YWxTY3JvbGxTdHJhdGVneSxcbiAgICAgIHVzZUV4aXN0aW5nOiBEeW5hbWljU2l6ZVZpcnR1YWxTY3JvbGxTdHJhdGVneSxcbiAgICB9LFxuICBdLFxuICBzdGFuZGFsb25lOiB0cnVlLFxufSlcbmV4cG9ydCBjbGFzcyBEeW5hbWljU2l6ZVZpcnR1YWxTY3JvbGxTdHJhdGVneTxcbiAgICBULFxuICAgIFUgZXh0ZW5kcyBOZ0l0ZXJhYmxlPFQ+ID0gTmdJdGVyYWJsZTxUPixcbiAgPlxuICBleHRlbmRzIFJ4VmlydHVhbFNjcm9sbFN0cmF0ZWd5PFQsIFU+XG4gIGltcGxlbWVudHMgT25DaGFuZ2VzLCBPbkRlc3Ryb3lcbntcbiAgcHJpdmF0ZSByZWFkb25seSBkZWZhdWx0cz8gPSBpbmplY3QoUlhfVklSVFVBTF9TQ1JPTExfREVGQVVMVF9PUFRJT05TLCB7XG4gICAgb3B0aW9uYWw6IHRydWUsXG4gIH0pO1xuXG4gIC8qKlxuICAgKiBAZGVzY3JpcHRpb25cbiAgICogVGhlIGFtb3VudCBvZiBpdGVtcyB0byByZW5kZXIgdXBmcm9udCBpbiBzY3JvbGwgZGlyZWN0aW9uXG4gICAqL1xuICBASW5wdXQoKSBydW53YXlJdGVtcyA9IHRoaXMuZGVmYXVsdHM/LnJ1bndheUl0ZW1zID8/IERFRkFVTFRfUlVOV0FZX0lURU1TO1xuXG4gIC8qKlxuICAgKiBAZGVzY3JpcHRpb25cbiAgICogVGhlIGFtb3VudCBvZiBpdGVtcyB0byByZW5kZXIgdXBmcm9udCBpbiByZXZlcnNlIHNjcm9sbCBkaXJlY3Rpb25cbiAgICovXG4gIEBJbnB1dCgpIHJ1bndheUl0ZW1zT3Bwb3NpdGUgPVxuICAgIHRoaXMuZGVmYXVsdHM/LnJ1bndheUl0ZW1zT3Bwb3NpdGUgPz8gREVGQVVMVF9SVU5XQVlfSVRFTVNfT1BQT1NJVEU7XG5cbiAgLyoqXG4gICAqIEBkZXNjcmlwdGlvblxuICAgKiBXaGVuIGVuYWJsZWQsIHRoZSBzY3JvbGwgc3RyYXRlZ3kgc3RvcHMgcmVtb3Zpbmcgdmlld3MgZnJvbSB0aGUgdmlld3BvcnQsXG4gICAqIGluc3RlYWQgaXQgb25seSBhZGRzIHZpZXdzLiBUaGlzIHNldHRpbmcgY2FuIGJlIGNoYW5nZWQgb24gdGhlIGZseS4gVmlld3Mgd2lsbCBiZSBhZGRlZCBpbiBib3RoIGRpcmVjdGlvbnNcbiAgICogYWNjb3JkaW5nIHRvIHRoZSB1c2VyIGludGVyYWN0aW9ucy5cbiAgICovXG4gIEBJbnB1dCh7IHRyYW5zZm9ybTogdG9Cb29sZWFuIH0pIGFwcGVuZE9ubHkgPSBmYWxzZTtcblxuICAvKipcbiAgICogQGRlc2NyaXB0aW9uXG4gICAqIElmIHRoaXMgZmxhZyBpcyB0cnVlLCB0aGUgdmlydHVhbCBzY3JvbGwgc3RyYXRlZ3kgbWFpbnRhaW5zIHRoZSBzY3JvbGxlZCBpdGVtIHdoZW4gbmV3IGRhdGFcbiAgICogaXMgcHJlcGVuZGVkIHRvIHRoZSBsaXN0LiBUaGlzIGlzIHZlcnkgdXNlZnVsIHdoZW4gaW1wbGVtZW50aW5nIGEgcmV2ZXJzZWQgaW5maW5pdGUgc2Nyb2xsZXIsIHRoYXQgcHJlcGVuZHNcbiAgICogZGF0YSBpbnN0ZWFkIG9mIGFwcGVuZGluZyBpdFxuICAgKi9cbiAgQElucHV0KHsgdHJhbnNmb3JtOiB0b0Jvb2xlYW4gfSkga2VlcFNjcm9sbGVkSW5kZXhPblByZXBlbmQgPSBmYWxzZTtcblxuICAvKipcbiAgICogQGRlc2NyaXB0aW9uXG4gICAqIEZ1bmN0aW9uIHJldHVybmluZyB0aGUgc2l6ZSBvZiBhbiBpdGVtXG4gICAqL1xuICBASW5wdXQoJ2R5bmFtaWMnKVxuICBzZXQgaXRlbVNpemUoZm46IChpdGVtOiBUKSA9PiBudW1iZXIpIHtcbiAgICBpZiAoZm4pIHtcbiAgICAgIHRoaXMuX2l0ZW1TaXplRm4gPSBmbjtcbiAgICB9XG4gIH1cbiAgZ2V0IGl0ZW1TaXplKCkge1xuICAgIHJldHVybiB0aGlzLl9pdGVtU2l6ZUZuO1xuICB9XG4gIHByaXZhdGUgX2l0ZW1TaXplRm46IChpdGVtOiBUKSA9PiBudW1iZXIgPSBkZWZhdWx0SXRlbVNpemU7XG5cbiAgLyoqIEBpbnRlcm5hbCAqL1xuICBwcml2YXRlIHdhaXRGb3JTY3JvbGwgPSBmYWxzZTtcblxuICAvKiogQGludGVybmFsICovXG4gIHByaXZhdGUgaXNTdGFibGUkID0gbmV3IFJlcGxheVN1YmplY3Q8Ym9vbGVhbj4oMSk7XG5cbiAgLyoqIEBpbnRlcm5hbCAqL1xuICBvdmVycmlkZSBnZXQgaXNTdGFibGUoKTogT2JzZXJ2YWJsZTxib29sZWFuPiB7XG4gICAgcmV0dXJuIHRoaXMuaXNTdGFibGUkLnBpcGUoZmlsdGVyKCh3KSA9PiB3KSk7XG4gIH1cblxuICAvKiogQGludGVybmFsICovXG4gIHByaXZhdGUgdmlld3BvcnQ6IFJ4VmlydHVhbFNjcm9sbFZpZXdwb3J0IHwgbnVsbCA9IG51bGw7XG4gIC8qKiBAaW50ZXJuYWwgKi9cbiAgcHJpdmF0ZSB2aWV3UmVwZWF0ZXI6IFJ4VmlydHVhbFZpZXdSZXBlYXRlcjxULCBVPiB8IG51bGwgPSBudWxsO1xuXG4gIC8qKiBAaW50ZXJuYWwgKi9cbiAgcHJpdmF0ZSByZWFkb25seSBfY29udGVudFNpemUkID0gbmV3IFJlcGxheVN1YmplY3Q8bnVtYmVyPigxKTtcbiAgLyoqIEBpbnRlcm5hbCAqL1xuICByZWFkb25seSBjb250ZW50U2l6ZSQgPSB0aGlzLl9jb250ZW50U2l6ZSQuYXNPYnNlcnZhYmxlKCk7XG5cbiAgLyoqIEBpbnRlcm5hbCAqL1xuICBwcml2YXRlIF9jb250ZW50U2l6ZSA9IDA7XG4gIC8qKiBAaW50ZXJuYWwgKi9cbiAgcHJpdmF0ZSBzZXQgY29udGVudFNpemUoc2l6ZTogbnVtYmVyKSB7XG4gICAgdGhpcy5fY29udGVudFNpemUgPSBzaXplO1xuICAgIHRoaXMuX2NvbnRlbnRTaXplJC5uZXh0KHNpemUpO1xuICB9XG5cbiAgcHJpdmF0ZSBnZXQgY29udGVudFNpemUoKTogbnVtYmVyIHtcbiAgICByZXR1cm4gdGhpcy5fY29udGVudFNpemU7XG4gIH1cblxuICAvKiogQGludGVybmFsICovXG4gIHByaXZhdGUgcmVhZG9ubHkgX3JlbmRlcmVkUmFuZ2UkID0gbmV3IFJlcGxheVN1YmplY3Q8TGlzdFJhbmdlPigxKTtcbiAgLyoqIEBpbnRlcm5hbCAqL1xuICByZWFkb25seSByZW5kZXJlZFJhbmdlJCA9IHRoaXMuX3JlbmRlcmVkUmFuZ2UkLmFzT2JzZXJ2YWJsZSgpO1xuICAvKiogQGludGVybmFsICovXG4gIHByaXZhdGUgX3JlbmRlcmVkUmFuZ2U6IExpc3RSYW5nZSA9IHsgc3RhcnQ6IDAsIGVuZDogMCB9O1xuICAvLyByYW5nZSBvZiBpdGVtcyB3aGVyZSBzaXplIGlzIGtub3duIGFuZCBkb2Vzbid0IG5lZWQgdG8gYmUgcmUtY2FsY3VsYXRlZFxuXG4gIC8qKiBAaW50ZXJuYWwgKi9cbiAgcHJpdmF0ZSBzZXQgcmVuZGVyZWRSYW5nZShyYW5nZTogTGlzdFJhbmdlKSB7XG4gICAgdGhpcy5fcmVuZGVyZWRSYW5nZSA9IHJhbmdlO1xuICAgIHRoaXMuX3JlbmRlcmVkUmFuZ2UkLm5leHQocmFuZ2UpO1xuICB9XG4gIC8qKiBAaW50ZXJuYWwgKi9cbiAgcHJpdmF0ZSBnZXQgcmVuZGVyZWRSYW5nZSgpOiBMaXN0UmFuZ2Uge1xuICAgIHJldHVybiB0aGlzLl9yZW5kZXJlZFJhbmdlO1xuICB9XG4gIC8qKiBAaW50ZXJuYWwgKi9cbiAgcHJpdmF0ZSByZWFkb25seSBfc2Nyb2xsZWRJbmRleCQgPSBuZXcgUmVwbGF5U3ViamVjdDxudW1iZXI+KDEpO1xuICAvKiogQGludGVybmFsICovXG4gIHJlYWRvbmx5IHNjcm9sbGVkSW5kZXgkID0gdGhpcy5fc2Nyb2xsZWRJbmRleCQucGlwZShkaXN0aW5jdFVudGlsQ2hhbmdlZCgpKTtcbiAgcHJpdmF0ZSBfc2Nyb2xsZWRJbmRleCA9IDA7XG4gIC8qKiBAaW50ZXJuYWwgKi9cbiAgcHJpdmF0ZSBzZXQgc2Nyb2xsZWRJbmRleChpbmRleDogbnVtYmVyKSB7XG4gICAgdGhpcy5fc2Nyb2xsZWRJbmRleCA9IGluZGV4O1xuICAgIHRoaXMuX3Njcm9sbGVkSW5kZXgkLm5leHQoaW5kZXgpO1xuICB9XG4gIHByaXZhdGUgZ2V0IHNjcm9sbGVkSW5kZXgoKSB7XG4gICAgcmV0dXJuIHRoaXMuX3Njcm9sbGVkSW5kZXg7XG4gIH1cbiAgLyoqIEBpbnRlcm5hbCAqL1xuICBwcml2YXRlIGdldCBjb250ZW50TGVuZ3RoKCk6IG51bWJlciB7XG4gICAgcmV0dXJuIHRoaXMuX3ZpcnR1YWxJdGVtcy5sZW5ndGg7XG4gIH1cbiAgLyoqIEBpbnRlcm5hbCAqL1xuICBwcml2YXRlIGNvbnRhaW5lclNpemUgPSAwO1xuICAvKiogQGludGVybmFsICovXG4gIHByaXZhdGUgX3ZpcnR1YWxJdGVtczogVmlydHVhbFZpZXdJdGVtW10gPSBbXTtcbiAgLyoqIEBpbnRlcm5hbCAqL1xuICBwcml2YXRlIHNjcm9sbFRvcCA9IDA7XG4gIC8qKiBAaW50ZXJuYWwgKi9cbiAgcHJpdmF0ZSBzY3JvbGxUb3BXaXRoT3V0T2Zmc2V0ID0gMDtcbiAgLyoqIEBpbnRlcm5hbCAqL1xuICBwcml2YXRlIHNjcm9sbFRvcEFmdGVyT2Zmc2V0ID0gMDtcbiAgLyoqIEBpbnRlcm5hbCAqL1xuICBwcml2YXRlIHZpZXdwb3J0T2Zmc2V0ID0gMDtcbiAgLyoqIEBpbnRlcm5hbCAqL1xuICBwcml2YXRlIGRpcmVjdGlvbjogJ3VwJyB8ICdkb3duJyA9ICdkb3duJztcbiAgLyoqIEBpbnRlcm5hbCAqL1xuICBwcml2YXRlIGFuY2hvclNjcm9sbFRvcCA9IDA7XG4gIC8qKiBAaW50ZXJuYWwgKi9cbiAgcHJpdmF0ZSBhbmNob3JJdGVtID0ge1xuICAgIGluZGV4OiAwLFxuICAgIG9mZnNldDogMCxcbiAgfTtcbiAgLyoqIEBpbnRlcm5hbCAqL1xuICBwcml2YXRlIGxhc3RTY3JlZW5JdGVtID0ge1xuICAgIGluZGV4OiAwLFxuICAgIG9mZnNldDogMCxcbiAgfTtcblxuICAvKiogQGludGVybmFsICovXG4gIHByaXZhdGUgcmVhZG9ubHkgZGV0YWNoZWQkID0gbmV3IFN1YmplY3Q8dm9pZD4oKTtcbiAgLyoqIEBpbnRlcm5hbCAqL1xuICBwcml2YXRlIHJlYWRvbmx5IHJlY2FsY3VsYXRlUmFuZ2UkID0gbmV3IFN1YmplY3Q8dm9pZD4oKTtcbiAgLyoqIEBpbnRlcm5hbCAqL1xuICBwcml2YXRlIHVudGlsJDxBPigpOiBNb25vVHlwZU9wZXJhdG9yRnVuY3Rpb248QT4ge1xuICAgIHJldHVybiAobyQpID0+IG8kLnBpcGUodGFrZVVudGlsKHRoaXMuZGV0YWNoZWQkKSk7XG4gIH1cblxuICAvKiogQGludGVybmFsICovXG4gIG5nT25DaGFuZ2VzKGNoYW5nZXM6IFNpbXBsZUNoYW5nZXMpIHtcbiAgICBpZiAoXG4gICAgICAoY2hhbmdlc1sncnVud2F5SXRlbXNPcHBvc2l0ZSddICYmXG4gICAgICAgICFjaGFuZ2VzWydydW53YXlJdGVtc09wcG9zaXRlJ10uZmlyc3RDaGFuZ2UpIHx8XG4gICAgICAoY2hhbmdlc1sncnVud2F5SXRlbXMnXSAmJiAhY2hhbmdlc1sncnVud2F5SXRlbXMnXS5maXJzdENoYW5nZSlcbiAgICApIHtcbiAgICAgIHRoaXMucmVjYWxjdWxhdGVSYW5nZSQubmV4dCgpO1xuICAgIH1cbiAgfVxuXG4gIC8qKiBAaW50ZXJuYWwgKi9cbiAgbmdPbkRlc3Ryb3koKSB7XG4gICAgdGhpcy5kZXRhY2goKTtcbiAgfVxuXG4gIC8qKiBAaW50ZXJuYWwgKi9cbiAgYXR0YWNoKFxuICAgIHZpZXdwb3J0OiBSeFZpcnR1YWxTY3JvbGxWaWV3cG9ydCxcbiAgICB2aWV3UmVwZWF0ZXI6IFJ4VmlydHVhbFZpZXdSZXBlYXRlcjxULCBVPixcbiAgKTogdm9pZCB7XG4gICAgdGhpcy52aWV3cG9ydCA9IHZpZXdwb3J0O1xuICAgIHRoaXMudmlld1JlcGVhdGVyID0gdmlld1JlcGVhdGVyO1xuICAgIHRoaXMubWFpbnRhaW5WaXJ0dWFsSXRlbXMoKTtcbiAgICB0aGlzLmNhbGNSZW5kZXJlZFJhbmdlKCk7XG4gICAgdGhpcy5wb3NpdGlvbkVsZW1lbnRzKCk7XG4gIH1cblxuICAvKiogQGludGVybmFsICovXG4gIGRldGFjaCgpOiB2b2lkIHtcbiAgICB0aGlzLnZpZXdwb3J0ID0gbnVsbDtcbiAgICB0aGlzLnZpZXdSZXBlYXRlciA9IG51bGw7XG4gICAgdGhpcy5fdmlydHVhbEl0ZW1zID0gW107XG4gICAgdGhpcy5kZXRhY2hlZCQubmV4dCgpO1xuICB9XG5cbiAgc2Nyb2xsVG9JbmRleChpbmRleDogbnVtYmVyLCBiZWhhdmlvcj86IFNjcm9sbEJlaGF2aW9yKTogdm9pZCB7XG4gICAgY29uc3QgX2luZGV4ID0gTWF0aC5taW4oTWF0aC5tYXgoaW5kZXgsIDApLCB0aGlzLmNvbnRlbnRMZW5ndGggLSAxKTtcbiAgICBsZXQgc2Nyb2xsVG8gPSAwO1xuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgX2luZGV4OyBpKyspIHtcbiAgICAgIHNjcm9sbFRvICs9IHRoaXMuX3ZpcnR1YWxJdGVtc1tpXS5zaXplO1xuICAgIH1cbiAgICB0aGlzLnNjcm9sbFRvKHNjcm9sbFRvLCBiZWhhdmlvcik7XG4gIH1cblxuICBwcml2YXRlIHNjcm9sbFRvKHNjcm9sbFRvOiBudW1iZXIsIGJlaGF2aW9yPzogU2Nyb2xsQmVoYXZpb3IpOiB2b2lkIHtcbiAgICB0aGlzLndhaXRGb3JTY3JvbGwgPVxuICAgICAgc2Nyb2xsVG8gIT09IHRoaXMuc2Nyb2xsVG9wICYmIHRoaXMuY29udGVudFNpemUgPiB0aGlzLmNvbnRhaW5lclNpemU7XG4gICAgaWYgKHRoaXMud2FpdEZvclNjcm9sbCkge1xuICAgICAgdGhpcy5pc1N0YWJsZSQubmV4dChmYWxzZSk7XG4gICAgfVxuICAgIHRoaXMudmlld3BvcnQhLnNjcm9sbFRvKHRoaXMudmlld3BvcnRPZmZzZXQgKyBzY3JvbGxUbywgYmVoYXZpb3IpO1xuICB9XG5cbiAgLyoqIEBpbnRlcm5hbCAqL1xuICBwcml2YXRlIG1haW50YWluVmlydHVhbEl0ZW1zKCk6IHZvaWQge1xuICAgIGNvbnN0IHZhbHVlQXJyYXkkID0gdGhpcy52aWV3UmVwZWF0ZXIhLnZhbHVlcyQucGlwZShcbiAgICAgIG1hcCgodmFsdWVzKSA9PlxuICAgICAgICBBcnJheS5pc0FycmF5KHZhbHVlcylcbiAgICAgICAgICA/IHZhbHVlc1xuICAgICAgICAgIDogdmFsdWVzICE9IG51bGxcbiAgICAgICAgICAgID8gQXJyYXkuZnJvbSh2YWx1ZXMpXG4gICAgICAgICAgICA6IFtdLFxuICAgICAgKSxcbiAgICAgIHNoYXJlUmVwbGF5KHsgYnVmZmVyU2l6ZTogMSwgcmVmQ291bnQ6IHRydWUgfSksXG4gICAgKTtcblxuICAgIHZhbHVlQXJyYXkkLnBpcGUodGhpcy51bnRpbCQoKSkuc3Vic2NyaWJlKChkYXRhQXJyKSA9PiB7XG4gICAgICBjb25zdCBkYXRhTGVuZ3RoID0gZGF0YUFyci5sZW5ndGg7XG4gICAgICBpZiAoIWRhdGFMZW5ndGgpIHtcbiAgICAgICAgdGhpcy5fdmlydHVhbEl0ZW1zID0gW107XG4gICAgICAgIHRoaXMuY29udGVudFNpemUgPSAwO1xuICAgICAgICB0aGlzLl9yZW5kZXJlZFJhbmdlID0ge1xuICAgICAgICAgIHN0YXJ0OiAwLFxuICAgICAgICAgIGVuZDogMCxcbiAgICAgICAgfTtcbiAgICAgICAgdGhpcy5hbmNob3JJdGVtID0ge1xuICAgICAgICAgIGluZGV4OiAwLFxuICAgICAgICAgIG9mZnNldDogMCxcbiAgICAgICAgfTtcbiAgICAgICAgdGhpcy5yZWNhbGN1bGF0ZVJhbmdlJC5uZXh0KCk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBsZXQgc2hvdWxkUmVjYWxjdWxhdGVSYW5nZSA9IGZhbHNlO1xuICAgICAgICBsZXQgY29udGVudFNpemUgPSAwO1xuICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGRhdGFBcnIubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICBjb25zdCBvbGRTaXplID0gdGhpcy5fdmlydHVhbEl0ZW1zW2ldPy5zaXplO1xuICAgICAgICAgIGNvbnN0IG5ld1NpemUgPSB0aGlzLml0ZW1TaXplKGRhdGFBcnJbaV0pO1xuICAgICAgICAgIGNvbnRlbnRTaXplICs9IG5ld1NpemU7XG4gICAgICAgICAgaWYgKG9sZFNpemUgPT09IHVuZGVmaW5lZCB8fCBvbGRTaXplICE9PSBuZXdTaXplKSB7XG4gICAgICAgICAgICB0aGlzLl92aXJ0dWFsSXRlbXNbaV0gPSB7IHNpemU6IG5ld1NpemUgfTtcbiAgICAgICAgICAgIGlmIChcbiAgICAgICAgICAgICAgIXNob3VsZFJlY2FsY3VsYXRlUmFuZ2UgJiZcbiAgICAgICAgICAgICAgKCF0aGlzLmNvbnRlbnRTaXplIHx8XG4gICAgICAgICAgICAgICAgKGkgPj0gdGhpcy5yZW5kZXJlZFJhbmdlLnN0YXJ0ICYmIGkgPCB0aGlzLnJlbmRlcmVkUmFuZ2UuZW5kKSlcbiAgICAgICAgICAgICkge1xuICAgICAgICAgICAgICBzaG91bGRSZWNhbGN1bGF0ZVJhbmdlID0gdHJ1ZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgaWYgKGRhdGFMZW5ndGggPCB0aGlzLl9yZW5kZXJlZFJhbmdlLmVuZCkge1xuICAgICAgICAgIHRoaXMuYW5jaG9ySXRlbSA9IHRoaXMuY2FsY3VsYXRlQW5jaG9yZWRJdGVtKFxuICAgICAgICAgICAge1xuICAgICAgICAgICAgICBpbmRleDogZGF0YUxlbmd0aCxcbiAgICAgICAgICAgICAgb2Zmc2V0OiAwLFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIC1jYWxjdWxhdGVWaXNpYmxlQ29udGFpbmVyU2l6ZShcbiAgICAgICAgICAgICAgdGhpcy5jb250YWluZXJTaXplLFxuICAgICAgICAgICAgICB0aGlzLnNjcm9sbFRvcFdpdGhPdXRPZmZzZXQsXG4gICAgICAgICAgICAgIHRoaXMuc2Nyb2xsVG9wQWZ0ZXJPZmZzZXQsXG4gICAgICAgICAgICApLFxuICAgICAgICAgICk7XG4gICAgICAgICAgdGhpcy5fcmVuZGVyZWRSYW5nZS5zdGFydCA9IE1hdGgubWF4KFxuICAgICAgICAgICAgMCxcbiAgICAgICAgICAgIHRoaXMuYW5jaG9ySXRlbS5pbmRleCAtIHRoaXMucnVud2F5SXRlbXMsXG4gICAgICAgICAgKTtcbiAgICAgICAgICB0aGlzLl9yZW5kZXJlZFJhbmdlLmVuZCA9IGRhdGFMZW5ndGg7XG4gICAgICAgICAgdGhpcy5jYWxjQW5jaG9yU2Nyb2xsVG9wKCk7XG4gICAgICAgICAgdGhpcy5zY3JvbGxUbyhjb250ZW50U2l6ZSk7XG4gICAgICAgICAgdGhpcy5zY3JvbGxUb3AgPSB0aGlzLmFuY2hvclNjcm9sbFRvcDtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLmNvbnRlbnRTaXplID0gY29udGVudFNpemU7XG4gICAgICAgIGlmIChzaG91bGRSZWNhbGN1bGF0ZVJhbmdlKSB7XG4gICAgICAgICAgdGhpcy5yZWNhbGN1bGF0ZVJhbmdlJC5uZXh0KCk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9KTtcblxuICAgIGxldCB2YWx1ZUNhY2hlOiBSZWNvcmQ8YW55LCBUPiA9IHt9O1xuICAgIC8qXG4gICAgICogd2hlbiBrZWVwU2Nyb2xsZWRJbmRleE9uUHJlcGVuZCBpcyBhY3RpdmUsIHdlIG5lZWQgdG8gbGlzdGVuIHRvIGRhdGEgY2hhbmdlcyBhbmQgZmlndXJlIG91dCB3aGF0IHdhcyBhcHBlbmRlZFxuICAgICAqIGJlZm9yZSB0aGUgbGFzdCBzY3JvbGxlZFRvSXRlbVxuICAgICAqL1xuICAgIHZhbHVlQXJyYXkkXG4gICAgICAucGlwZShcbiAgICAgICAgLy8gVE9ETzogdGhpcyBtaWdodCBjYXVzZSBpc3N1ZXMgd2hlbiB0dXJuaW5nIG9uL29mZiBhdCBydW50aW1lXG4gICAgICAgIGZpbHRlcigoKSA9PiB0aGlzLmtlZXBTY3JvbGxlZEluZGV4T25QcmVwZW5kKSxcbiAgICAgICAgdGhpcy51bnRpbCQoKSxcbiAgICAgIClcbiAgICAgIC5zdWJzY3JpYmUoKHZhbHVlQXJyYXkpID0+IHtcbiAgICAgICAgY29uc3QgdHJhY2tCeSA9IHRoaXMudmlld1JlcGVhdGVyIS5fdHJhY2tCeTtcbiAgICAgICAgbGV0IHNjcm9sbFRvID0gdGhpcy5zY3JvbGxlZEluZGV4O1xuICAgICAgICBjb25zdCBkYXRhTGVuZ3RoID0gdmFsdWVBcnJheS5sZW5ndGg7XG4gICAgICAgIGNvbnN0IG9sZERhdGFMZW5ndGggPSBPYmplY3Qua2V5cyh2YWx1ZUNhY2hlKS5sZW5ndGg7XG5cbiAgICAgICAgaWYgKG9sZERhdGFMZW5ndGggPiAwKSB7XG4gICAgICAgICAgbGV0IGkgPSAwO1xuICAgICAgICAgIC8vIGNoZWNrIGZvciBlYWNoIGl0ZW0gZnJvbSB0aGUgbGFzdCBrbm93biBzY3JvbGxlZEluZGV4IGlmIGl0J3MgYW4gaW5zZXJ0XG4gICAgICAgICAgZm9yIChpOyBpIDw9IHNjcm9sbFRvICYmIGkgPCBkYXRhTGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgIC8vIGl0ZW0gaXMgbm90IGluIHRoZSB2YWx1ZUNhY2hlLCBzbyBpdCB3YXMgYWRkZWRcbiAgICAgICAgICAgIGlmICghdmFsdWVDYWNoZVt0cmFja0J5KGksIHZhbHVlQXJyYXlbaV0pXSkge1xuICAgICAgICAgICAgICBzY3JvbGxUbysrO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICB2YWx1ZUNhY2hlID0ge307XG4gICAgICAgIHZhbHVlQXJyYXkuZm9yRWFjaCgodiwgaSkgPT4gKHZhbHVlQ2FjaGVbdHJhY2tCeShpLCB2KV0gPSB2KSk7XG4gICAgICAgIGlmIChzY3JvbGxUbyAhPT0gdGhpcy5zY3JvbGxlZEluZGV4KSB7XG4gICAgICAgICAgdGhpcy5zY3JvbGxUb0luZGV4KHNjcm9sbFRvKTtcbiAgICAgICAgfVxuICAgICAgfSk7XG4gIH1cblxuICAvKiogQGludGVybmFsICovXG4gIHByaXZhdGUgY2FsY1JlbmRlcmVkUmFuZ2UoKTogdm9pZCB7XG4gICAgY29tYmluZUxhdGVzdChbXG4gICAgICB0aGlzLnZpZXdwb3J0IS5jb250YWluZXJSZWN0JC5waXBlKFxuICAgICAgICBtYXAoKHsgaGVpZ2h0IH0pID0+IHtcbiAgICAgICAgICB0aGlzLmNvbnRhaW5lclNpemUgPSBoZWlnaHQ7XG4gICAgICAgICAgcmV0dXJuIGhlaWdodDtcbiAgICAgICAgfSksXG4gICAgICAgIGRpc3RpbmN0VW50aWxDaGFuZ2VkKCksXG4gICAgICApLFxuICAgICAgdGhpcy52aWV3cG9ydCEuZWxlbWVudFNjcm9sbGVkJC5waXBlKFxuICAgICAgICBzdGFydFdpdGgodm9pZCAwKSxcbiAgICAgICAgdGFwKCgpID0+IHtcbiAgICAgICAgICB0aGlzLnZpZXdwb3J0T2Zmc2V0ID0gdGhpcy52aWV3cG9ydCEubWVhc3VyZU9mZnNldCgpO1xuICAgICAgICAgIGNvbnN0IHsgc2Nyb2xsVG9wLCBzY3JvbGxUb3BXaXRoT3V0T2Zmc2V0LCBzY3JvbGxUb3BBZnRlck9mZnNldCB9ID1cbiAgICAgICAgICAgIHBhcnNlU2Nyb2xsVG9wQm91bmRhcmllcyhcbiAgICAgICAgICAgICAgdGhpcy52aWV3cG9ydCEuZ2V0U2Nyb2xsVG9wKCksXG4gICAgICAgICAgICAgIHRoaXMudmlld3BvcnRPZmZzZXQsXG4gICAgICAgICAgICAgIHRoaXMuX2NvbnRlbnRTaXplLFxuICAgICAgICAgICAgICB0aGlzLmNvbnRhaW5lclNpemUsXG4gICAgICAgICAgICApO1xuICAgICAgICAgIHRoaXMuZGlyZWN0aW9uID1cbiAgICAgICAgICAgIHNjcm9sbFRvcFdpdGhPdXRPZmZzZXQgPiB0aGlzLnNjcm9sbFRvcFdpdGhPdXRPZmZzZXRcbiAgICAgICAgICAgICAgPyAnZG93bidcbiAgICAgICAgICAgICAgOiAndXAnO1xuICAgICAgICAgIHRoaXMuc2Nyb2xsVG9wV2l0aE91dE9mZnNldCA9IHNjcm9sbFRvcFdpdGhPdXRPZmZzZXQ7XG4gICAgICAgICAgdGhpcy5zY3JvbGxUb3BBZnRlck9mZnNldCA9IHNjcm9sbFRvcEFmdGVyT2Zmc2V0O1xuICAgICAgICAgIHRoaXMuc2Nyb2xsVG9wID0gc2Nyb2xsVG9wO1xuICAgICAgICAgIHRoaXMud2FpdEZvclNjcm9sbCA9IGZhbHNlO1xuICAgICAgICB9KSxcbiAgICAgICksXG4gICAgICB0aGlzLl9jb250ZW50U2l6ZSQucGlwZShkaXN0aW5jdFVudGlsQ2hhbmdlZCgpKSxcbiAgICAgIHRoaXMucmVjYWxjdWxhdGVSYW5nZSQucGlwZShzdGFydFdpdGgodm9pZCAwKSksXG4gICAgXSlcbiAgICAgIC5waXBlKFxuICAgICAgICAvLyBtYWtlIHN1cmUgdG8gbm90IG92ZXIgY2FsY3VsYXRlIHRoaW5ncyBieSBjb2FsZXNjaW5nIGFsbCB0cmlnZ2VycyB0byB0aGUgbmV4dCBtaWNyb3Rhc2tcbiAgICAgICAgY29hbGVzY2VXaXRoKHVucGF0Y2hlZE1pY3JvVGFzaygpKSxcbiAgICAgICAgbWFwKCgpID0+IHtcbiAgICAgICAgICBjb25zdCByYW5nZSA9IHsgc3RhcnQ6IDAsIGVuZDogMCB9O1xuICAgICAgICAgIGNvbnN0IGxlbmd0aCA9IHRoaXMuY29udGVudExlbmd0aDtcbiAgICAgICAgICBjb25zdCBkZWx0YSA9IHRoaXMuc2Nyb2xsVG9wIC0gdGhpcy5hbmNob3JTY3JvbGxUb3A7XG4gICAgICAgICAgaWYgKHRoaXMuc2Nyb2xsVG9wID09IDApIHtcbiAgICAgICAgICAgIHRoaXMuYW5jaG9ySXRlbSA9IHsgaW5kZXg6IDAsIG9mZnNldDogMCB9O1xuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB0aGlzLmFuY2hvckl0ZW0gPSB0aGlzLmNhbGN1bGF0ZUFuY2hvcmVkSXRlbShcbiAgICAgICAgICAgICAgdGhpcy5hbmNob3JJdGVtLFxuICAgICAgICAgICAgICBkZWx0YSxcbiAgICAgICAgICAgICk7XG4gICAgICAgICAgfVxuICAgICAgICAgIHRoaXMuc2Nyb2xsZWRJbmRleCA9IHRoaXMuYW5jaG9ySXRlbS5pbmRleDtcbiAgICAgICAgICB0aGlzLmFuY2hvclNjcm9sbFRvcCA9IHRoaXMuc2Nyb2xsVG9wO1xuICAgICAgICAgIHRoaXMubGFzdFNjcmVlbkl0ZW0gPSB0aGlzLmNhbGN1bGF0ZUFuY2hvcmVkSXRlbShcbiAgICAgICAgICAgIHRoaXMuYW5jaG9ySXRlbSxcbiAgICAgICAgICAgIGNhbGN1bGF0ZVZpc2libGVDb250YWluZXJTaXplKFxuICAgICAgICAgICAgICB0aGlzLmNvbnRhaW5lclNpemUsXG4gICAgICAgICAgICAgIHRoaXMuc2Nyb2xsVG9wV2l0aE91dE9mZnNldCxcbiAgICAgICAgICAgICAgdGhpcy5zY3JvbGxUb3BBZnRlck9mZnNldCxcbiAgICAgICAgICAgICksXG4gICAgICAgICAgKTtcbiAgICAgICAgICBpZiAodGhpcy5kaXJlY3Rpb24gPT09ICd1cCcpIHtcbiAgICAgICAgICAgIHJhbmdlLnN0YXJ0ID0gTWF0aC5tYXgoMCwgdGhpcy5hbmNob3JJdGVtLmluZGV4IC0gdGhpcy5ydW53YXlJdGVtcyk7XG4gICAgICAgICAgICByYW5nZS5lbmQgPSBNYXRoLm1pbihcbiAgICAgICAgICAgICAgbGVuZ3RoLFxuICAgICAgICAgICAgICB0aGlzLmxhc3RTY3JlZW5JdGVtLmluZGV4ICsgdGhpcy5ydW53YXlJdGVtc09wcG9zaXRlLFxuICAgICAgICAgICAgKTtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgcmFuZ2Uuc3RhcnQgPSBNYXRoLm1heChcbiAgICAgICAgICAgICAgMCxcbiAgICAgICAgICAgICAgdGhpcy5hbmNob3JJdGVtLmluZGV4IC0gdGhpcy5ydW53YXlJdGVtc09wcG9zaXRlLFxuICAgICAgICAgICAgKTtcbiAgICAgICAgICAgIHJhbmdlLmVuZCA9IE1hdGgubWluKFxuICAgICAgICAgICAgICBsZW5ndGgsXG4gICAgICAgICAgICAgIHRoaXMubGFzdFNjcmVlbkl0ZW0uaW5kZXggKyB0aGlzLnJ1bndheUl0ZW1zLFxuICAgICAgICAgICAgKTtcbiAgICAgICAgICB9XG4gICAgICAgICAgaWYgKHRoaXMuYXBwZW5kT25seSkge1xuICAgICAgICAgICAgcmFuZ2Uuc3RhcnQgPSBNYXRoLm1pbih0aGlzLl9yZW5kZXJlZFJhbmdlLnN0YXJ0LCByYW5nZS5zdGFydCk7XG4gICAgICAgICAgICByYW5nZS5lbmQgPSBNYXRoLm1heCh0aGlzLl9yZW5kZXJlZFJhbmdlLmVuZCwgcmFuZ2UuZW5kKTtcbiAgICAgICAgICB9XG4gICAgICAgICAgcmV0dXJuIHJhbmdlO1xuICAgICAgICB9KSxcbiAgICAgIClcbiAgICAgIC5waXBlKHRoaXMudW50aWwkKCkpXG4gICAgICAuc3Vic2NyaWJlKChyYW5nZTogTGlzdFJhbmdlKSA9PiB7XG4gICAgICAgIHRoaXMucmVuZGVyZWRSYW5nZSA9IHJhbmdlO1xuICAgICAgICB0aGlzLmlzU3RhYmxlJC5uZXh0KCF0aGlzLndhaXRGb3JTY3JvbGwpO1xuICAgICAgfSk7XG4gIH1cblxuICAvKiogQGludGVybmFsICovXG4gIHByaXZhdGUgcG9zaXRpb25FbGVtZW50cygpOiB2b2lkIHtcbiAgICB0aGlzLnZpZXdSZXBlYXRlciEucmVuZGVyaW5nU3RhcnQkLnBpcGUoXG4gICAgICBzd2l0Y2hNYXAoKGJhdGNoZWRVcGRhdGVzKSA9PiB7XG4gICAgICAgIGNvbnN0IHJlbmRlcmVkUmFuZ2UgPSB0aGlzLnJlbmRlcmVkUmFuZ2U7XG4gICAgICAgIGNvbnN0IGFkanVzdEluZGV4V2l0aCA9IHJlbmRlcmVkUmFuZ2Uuc3RhcnQ7XG4gICAgICAgIGNvbnN0IGluaXRpYWxJbmRleCA9IGJhdGNoZWRVcGRhdGVzLnNpemVcbiAgICAgICAgICA/IGJhdGNoZWRVcGRhdGVzLnZhbHVlcygpLm5leHQoKS52YWx1ZSArIHRoaXMucmVuZGVyZWRSYW5nZS5zdGFydFxuICAgICAgICAgIDogdGhpcy5yZW5kZXJlZFJhbmdlLnN0YXJ0O1xuICAgICAgICBsZXQgcG9zaXRpb24gPSB0aGlzLmNhbGNJbml0aWFsUG9zaXRpb24oaW5pdGlhbEluZGV4KTtcbiAgICAgICAgcmV0dXJuIHRoaXMudmlld1JlcGVhdGVyIS52aWV3UmVuZGVyZWQkLnBpcGUoXG4gICAgICAgICAgdGFwKCh7IHZpZXcsIGluZGV4OiB2aWV3SW5kZXgsIGl0ZW0gfSkgPT4ge1xuICAgICAgICAgICAgY29uc3QgaW5kZXggPSB2aWV3SW5kZXggKyBhZGp1c3RJbmRleFdpdGg7XG4gICAgICAgICAgICBjb25zdCBzaXplID0gdGhpcy5nZXRJdGVtU2l6ZShpbmRleCk7XG4gICAgICAgICAgICB0aGlzLnBvc2l0aW9uRWxlbWVudCh0aGlzLmdldEVsZW1lbnQodmlldyksIHBvc2l0aW9uKTtcbiAgICAgICAgICAgIHBvc2l0aW9uICs9IHNpemU7XG4gICAgICAgICAgICB0aGlzLnZpZXdSZW5kZXJDYWxsYmFjay5uZXh0KHtcbiAgICAgICAgICAgICAgaW5kZXgsXG4gICAgICAgICAgICAgIHZpZXcsXG4gICAgICAgICAgICAgIGl0ZW0sXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICB9KSxcbiAgICAgICAgKTtcbiAgICAgIH0pLFxuICAgICAgdGhpcy51bnRpbCQoKSxcbiAgICApLnN1YnNjcmliZSgpO1xuICB9XG5cbiAgLyoqXG4gICAqIEBpbnRlcm5hbFxuICAgKiBoZWF2aWx5IGluc3BpcmVkIGJ5XG4gICAqICAgaHR0cHM6Ly9naXRodWIuY29tL0dvb2dsZUNocm9tZUxhYnMvdWktZWxlbWVudC1zYW1wbGVzL2Jsb2IvZ2gtcGFnZXMvaW5maW5pdGUtc2Nyb2xsZXIvc2NyaXB0cy9pbmZpbml0ZS1zY3JvbGwuanNcbiAgICovXG4gIHByaXZhdGUgY2FsY3VsYXRlQW5jaG9yZWRJdGVtKFxuICAgIGluaXRpYWxBbmNob3I6IEFuY2hvckl0ZW0sXG4gICAgZGVsdGE6IG51bWJlcixcbiAgKTogQW5jaG9ySXRlbSB7XG4gICAgaWYgKGRlbHRhID09IDApIHJldHVybiBpbml0aWFsQW5jaG9yO1xuICAgIGRlbHRhICs9IGluaXRpYWxBbmNob3Iub2Zmc2V0O1xuICAgIGxldCBpID0gaW5pdGlhbEFuY2hvci5pbmRleDtcbiAgICBjb25zdCBpdGVtcyA9IHRoaXMuX3ZpcnR1YWxJdGVtcztcbiAgICBpZiAoZGVsdGEgPCAwKSB7XG4gICAgICB3aGlsZSAoZGVsdGEgPCAwICYmIGkgPiAwKSB7XG4gICAgICAgIGRlbHRhICs9IGl0ZW1zW2kgLSAxXS5zaXplO1xuICAgICAgICBpLS07XG4gICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgIHdoaWxlIChkZWx0YSA+IDAgJiYgaSA8IGl0ZW1zLmxlbmd0aCAmJiBpdGVtc1tpXS5zaXplIDw9IGRlbHRhKSB7XG4gICAgICAgIGRlbHRhIC09IGl0ZW1zW2ldLnNpemU7XG4gICAgICAgIGkrKztcbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIHtcbiAgICAgIGluZGV4OiBNYXRoLm1pbihpLCBpdGVtcy5sZW5ndGgpLFxuICAgICAgb2Zmc2V0OiBkZWx0YSxcbiAgICB9O1xuICB9XG5cbiAgLyoqIEBpbnRlcm5hbCAqL1xuICBwcml2YXRlIGNhbGNJbml0aWFsUG9zaXRpb24oc3RhcnQ6IG51bWJlcik6IG51bWJlciB7XG4gICAgLy8gQ2FsY3VsYXRlIHBvc2l0aW9uIG9mIHN0YXJ0aW5nIG5vZGVcbiAgICBsZXQgcG9zID0gdGhpcy5hbmNob3JTY3JvbGxUb3AgLSB0aGlzLmFuY2hvckl0ZW0ub2Zmc2V0O1xuICAgIGxldCBpID0gdGhpcy5hbmNob3JJdGVtLmluZGV4O1xuICAgIHdoaWxlIChpID4gc3RhcnQpIHtcbiAgICAgIGNvbnN0IGl0ZW1TaXplID0gdGhpcy5nZXRJdGVtU2l6ZShpIC0gMSk7XG4gICAgICBwb3MgLT0gaXRlbVNpemU7XG4gICAgICBpLS07XG4gICAgfVxuICAgIHdoaWxlIChpIDwgc3RhcnQpIHtcbiAgICAgIGNvbnN0IGl0ZW1TaXplID0gdGhpcy5nZXRJdGVtU2l6ZShpKTtcbiAgICAgIHBvcyArPSBpdGVtU2l6ZTtcbiAgICAgIGkrKztcbiAgICB9XG4gICAgcmV0dXJuIHBvcztcbiAgfVxuXG4gIC8qKiBAaW50ZXJuYWwgKi9cbiAgcHJpdmF0ZSBjYWxjQW5jaG9yU2Nyb2xsVG9wKCk6IHZvaWQge1xuICAgIHRoaXMuYW5jaG9yU2Nyb2xsVG9wID0gMDtcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHRoaXMuYW5jaG9ySXRlbS5pbmRleDsgaSsrKSB7XG4gICAgICB0aGlzLmFuY2hvclNjcm9sbFRvcCArPSB0aGlzLmdldEl0ZW1TaXplKGkpO1xuICAgIH1cbiAgICB0aGlzLmFuY2hvclNjcm9sbFRvcCArPSB0aGlzLmFuY2hvckl0ZW0ub2Zmc2V0O1xuICB9XG5cbiAgLyoqIEBpbnRlcm5hbCAqL1xuICBwcml2YXRlIGdldEl0ZW1TaXplKGluZGV4OiBudW1iZXIpOiBudW1iZXIge1xuICAgIHJldHVybiB0aGlzLl92aXJ0dWFsSXRlbXNbaW5kZXhdLnNpemU7XG4gIH1cblxuICAvKiogQGludGVybmFsICovXG4gIHByaXZhdGUgcG9zaXRpb25FbGVtZW50KGVsZW1lbnQ6IEhUTUxFbGVtZW50LCBzY3JvbGxUb3A6IG51bWJlcik6IHZvaWQge1xuICAgIGVsZW1lbnQuc3R5bGUucG9zaXRpb24gPSAnYWJzb2x1dGUnO1xuICAgIGVsZW1lbnQuc3R5bGUudHJhbnNmb3JtID0gYHRyYW5zbGF0ZVkoJHtzY3JvbGxUb3B9cHgpYDtcbiAgfVxufVxuIl19