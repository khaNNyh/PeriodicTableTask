import { map } from 'rxjs/operators';
import { isOperateFnArrayGuard, isStringAndFunctionTupleGuard, isStringArrayFunctionAndOptionalObjectTupleGuard, isStringArrayGuard, } from '../utils/guards';
import { pipeFromArray } from '../utils/pipe-from-array';
import { selectSlice } from './selectSlice';
import { stateful } from './stateful';
/**
 * @internal
 */
export function select(...opOrMapFn) {
    return (state$) => {
        if (!opOrMapFn || opOrMapFn.length === 0) {
            return state$.pipe(stateful());
        }
        else if (isStringAndFunctionTupleGuard(opOrMapFn)) {
            return state$.pipe(stateful(map((s) => opOrMapFn[1](s[opOrMapFn[0]]))));
        }
        else if (isStringArrayFunctionAndOptionalObjectTupleGuard(opOrMapFn)) {
            const selectedState$ = state$.pipe(selectSlice(opOrMapFn[0], opOrMapFn[2]));
            return typeof opOrMapFn[1] === 'undefined'
                ? selectedState$
                : selectedState$.pipe(stateful(map(opOrMapFn[1])));
        }
        else if (isStringArrayGuard(opOrMapFn)) {
            return state$.pipe(stateful(map((state) => opOrMapFn.reduce((acc, key) => acc?.[key], state))));
        }
        else if (isOperateFnArrayGuard(opOrMapFn)) {
            return state$.pipe(stateful(pipeFromArray(opOrMapFn)));
        }
        else {
            throw new Error('wrong params passed to select');
        }
    };
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2VsZWN0LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vLi4vbGlicy9zdGF0ZS9zZWxlY3Rpb25zL3NyYy9saWIvb3BlcmF0b3JzL3NlbGVjdC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFDQSxPQUFPLEVBQUUsR0FBRyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFFckMsT0FBTyxFQUNMLHFCQUFxQixFQUNyQiw2QkFBNkIsRUFDN0IsZ0RBQWdELEVBQ2hELGtCQUFrQixHQUNuQixNQUFNLGlCQUFpQixDQUFDO0FBQ3pCLE9BQU8sRUFBRSxhQUFhLEVBQUUsTUFBTSwwQkFBMEIsQ0FBQztBQUN6RCxPQUFPLEVBQUUsV0FBVyxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQzVDLE9BQU8sRUFBRSxRQUFRLEVBQUUsTUFBTSxZQUFZLENBQUM7QUE4THRDOztHQUVHO0FBQ0gsTUFBTSxVQUFVLE1BQU0sQ0FDcEIsR0FBRyxTQVFFO0lBRUwsT0FBTyxDQUFDLE1BQXFCLEVBQUUsRUFBRTtRQUMvQixJQUFJLENBQUMsU0FBUyxJQUFJLFNBQVMsQ0FBQyxNQUFNLEtBQUssQ0FBQyxFQUFFLENBQUM7WUFDekMsT0FBTyxNQUFNLENBQUMsSUFBSSxDQUFDLFFBQVEsRUFBRSxDQUFDLENBQUM7UUFDakMsQ0FBQzthQUFNLElBQUksNkJBQTZCLENBQUMsU0FBUyxDQUFDLEVBQUUsQ0FBQztZQUNwRCxPQUFPLE1BQU0sQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsRUFBRSxFQUFFLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQzFFLENBQUM7YUFBTSxJQUFJLGdEQUFnRCxDQUFDLFNBQVMsQ0FBQyxFQUFFLENBQUM7WUFDdkUsTUFBTSxjQUFjLEdBQ2xCLE1BQU0sQ0FBQyxJQUFJLENBQ1QsV0FBVyxDQUNULFNBQVMsQ0FBQyxDQUFDLENBQWdCLEVBQzNCLFNBQVMsQ0FBQyxDQUFDLENBQXVELENBQ25FLENBQ0YsQ0FBQztZQUNKLE9BQU8sT0FBTyxTQUFTLENBQUMsQ0FBQyxDQUFDLEtBQUssV0FBVztnQkFDeEMsQ0FBQyxDQUFDLGNBQWM7Z0JBQ2hCLENBQUMsQ0FBQyxjQUFjLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQ3ZELENBQUM7YUFBTSxJQUFJLGtCQUFrQixDQUFDLFNBQVMsQ0FBQyxFQUFFLENBQUM7WUFDekMsT0FBTyxNQUFNLENBQUMsSUFBSSxDQUNoQixRQUFRLENBQ04sR0FBRyxDQUFDLENBQUMsS0FBSyxFQUFFLEVBQUUsQ0FBQyxTQUFTLENBQUMsTUFBTSxDQUFDLENBQUMsR0FBRyxFQUFFLEdBQUcsRUFBRSxFQUFFLENBQUMsR0FBRyxFQUFFLENBQUMsR0FBRyxDQUFDLEVBQUUsS0FBSyxDQUFDLENBQUMsQ0FDbEUsQ0FDRixDQUFDO1FBQ0osQ0FBQzthQUFNLElBQUkscUJBQXFCLENBQUMsU0FBUyxDQUFDLEVBQUUsQ0FBQztZQUM1QyxPQUFPLE1BQU0sQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLGFBQWEsQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDekQsQ0FBQzthQUFNLENBQUM7WUFDTixNQUFNLElBQUksS0FBSyxDQUFDLCtCQUErQixDQUFDLENBQUM7UUFDbkQsQ0FBQztJQUNILENBQUMsQ0FBQztBQUNKLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBNb25vVHlwZU9wZXJhdG9yRnVuY3Rpb24sIE9ic2VydmFibGUsIE9wZXJhdG9yRnVuY3Rpb24gfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IG1hcCB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcbmltcG9ydCB7IEtleUNvbXBhcmVNYXAsIFBpY2tTbGljZSB9IGZyb20gJy4uL2ludGVyZmFjZXMnO1xuaW1wb3J0IHtcbiAgaXNPcGVyYXRlRm5BcnJheUd1YXJkLFxuICBpc1N0cmluZ0FuZEZ1bmN0aW9uVHVwbGVHdWFyZCxcbiAgaXNTdHJpbmdBcnJheUZ1bmN0aW9uQW5kT3B0aW9uYWxPYmplY3RUdXBsZUd1YXJkLFxuICBpc1N0cmluZ0FycmF5R3VhcmQsXG59IGZyb20gJy4uL3V0aWxzL2d1YXJkcyc7XG5pbXBvcnQgeyBwaXBlRnJvbUFycmF5IH0gZnJvbSAnLi4vdXRpbHMvcGlwZS1mcm9tLWFycmF5JztcbmltcG9ydCB7IHNlbGVjdFNsaWNlIH0gZnJvbSAnLi9zZWxlY3RTbGljZSc7XG5pbXBvcnQgeyBzdGF0ZWZ1bCB9IGZyb20gJy4vc3RhdGVmdWwnO1xuXG4vKipcbiAqIEBkZXNjcmlwdGlvblxuICogUmV0dXJucyB0aGUgc3RhdGUgYXMgc2hhcmVkLCByZXBsYXllZCBhbmQgZGlzdGluY3QgYE9ic2VydmFibGU8VD5gLiBUaGlzIHdheSB5b3UgZG9uJ3QgaGF2ZSB0byB0aGluayBhYm91dCBsYXRlXG4gKiBzdWJzY3JpYmVycywgbXVsdGlwbGUgc3Vic2NyaWJlcnMgb3IgbXVsdGlwbGUgZW1pc3Npb25zIG9mIHRoZSBzYW1lIHZhbHVlLlxuICpcbiAqIEBleGFtcGxlXG4gKiBjb25zdCBzdGF0ZSQgPSBzdGF0ZS5waXBlKHNlbGVjdCgpKTtcbiAqIHN0YXRlJC5zdWJzY3JpYmUoc3RhdGUgPT4gZG9TdHVmZihzdGF0ZSkpO1xuICpcbiAqIEByZXR1cm5zIE9ic2VydmFibGU8VD5cbiAqL1xuXG5leHBvcnQgZnVuY3Rpb24gc2VsZWN0PFQ+KCk6IE1vbm9UeXBlT3BlcmF0b3JGdW5jdGlvbjxUPjtcblxuLyoqXG4gKiBAZGVzY3JpcHRpb25cbiAqIFJldHVybnMgdGhlIHN0YXRlIGFzIGNhY2hlZCBhbmQgZGlzdGluY3QgYE9ic2VydmFibGU8QT5gLiBBY2NlcHRzIGFyYml0cmFyeVxuICogW3J4anMgb3BlcmF0b3JzXShodHRwczovL3J4anMtZGV2LmZpcmViYXNlYXBwLmNvbS9ndWlkZS9vcGVyYXRvcnMpIHRvIGVucmljaCB0aGUgc2VsZWN0aW9uIHdpdGggcmVhY3RpdmUgY29tcG9zaXRpb24uXG4gKlxuICogQGV4YW1wbGVcbiAqIGNvbnN0IHByb2ZpbGVQaWN0dXJlJCA9IHN0YXRlLnBpcGUoXG4gKiAgIHNlbGVjdChcbiAqICAgIG1hcChzdGF0ZSA9PiBzdGF0ZS5wcm9maWxlUGljdHVyZSksXG4gKiAgICBzd2l0Y2hNYXAocHJvZmlsZVBpY3R1cmUgPT4gbWFwSW1hZ2VBc3luYyhwcm9maWxlUGljdHVyZSkpXG4gKiAgIClcbiAqICk7XG4gKiBAcGFyYW0gIHsgT3BlcmF0b3JGdW5jdGlvbjxULCBBPiB9IG9wXG4gKiBAcmV0dXJucyBPYnNlcnZhYmxlPEE+XG4gKlxuICogQGRvY3NQYWdlIHNlbGVjdFxuICogQGRvY3NDYXRlZ29yeSBvcGVyYXRvcnNcbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIHNlbGVjdDxULCBBPihcbiAgb3A6IE9wZXJhdG9yRnVuY3Rpb248VCwgQT4sXG4pOiBPcGVyYXRvckZ1bmN0aW9uPFQsIEE+O1xuLyoqXG4gKiBAaW50ZXJuYWxcbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIHNlbGVjdDxULCBBLCBCPihcbiAgb3AxOiBPcGVyYXRvckZ1bmN0aW9uPFQsIEE+LFxuICBvcDI6IE9wZXJhdG9yRnVuY3Rpb248QSwgQj4sXG4pOiBPcGVyYXRvckZ1bmN0aW9uPFQsIEI+O1xuLyoqXG4gKiBAaW50ZXJuYWxcbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIHNlbGVjdDxULCBBLCBCLCBDPihcbiAgb3AxOiBPcGVyYXRvckZ1bmN0aW9uPFQsIEE+LFxuICBvcDI6IE9wZXJhdG9yRnVuY3Rpb248QSwgQj4sXG4gIG9wMzogT3BlcmF0b3JGdW5jdGlvbjxCLCBDPixcbik6IE9wZXJhdG9yRnVuY3Rpb248VCwgQz47XG4vKipcbiAqIEBpbnRlcm5hbFxuICovXG5leHBvcnQgZnVuY3Rpb24gc2VsZWN0PFQsIEEsIEIsIEMsIEQ+KFxuICBvcDE6IE9wZXJhdG9yRnVuY3Rpb248VCwgQT4sXG4gIG9wMjogT3BlcmF0b3JGdW5jdGlvbjxBLCBCPixcbiAgb3AzOiBPcGVyYXRvckZ1bmN0aW9uPEIsIEM+LFxuICBvcDQ6IE9wZXJhdG9yRnVuY3Rpb248QywgRD4sXG4pOiBPcGVyYXRvckZ1bmN0aW9uPFQsIEQ+O1xuLyoqXG4gKiBAaW50ZXJuYWxcbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIHNlbGVjdDxULCBBLCBCLCBDLCBELCBFPihcbiAgb3AxOiBPcGVyYXRvckZ1bmN0aW9uPFQsIEE+LFxuICBvcDI6IE9wZXJhdG9yRnVuY3Rpb248QSwgQj4sXG4gIG9wMzogT3BlcmF0b3JGdW5jdGlvbjxCLCBDPixcbiAgb3A0OiBPcGVyYXRvckZ1bmN0aW9uPEMsIEQ+LFxuICBvcDU6IE9wZXJhdG9yRnVuY3Rpb248RCwgRT4sXG4pOiBPcGVyYXRvckZ1bmN0aW9uPFQsIEU+O1xuXG4vKipcbiAqIEBkZXNjcmlwdGlvblxuICogVHJhbnNmb3JtIGEgc2xpY2Ugb2YgdGhlIHN0YXRlIGJ5IHByb3ZpZGluZyBrZXlzIGFuZCBtYXAgZnVuY3Rpb24uXG4gKiBSZXR1cm5zIHJlc3VsdCBvZiBhcHBseWluZyBmdW5jdGlvbiB0byBzdGF0ZSBzbGljZSBhcyBjYWNoZWQgYW5kIGRpc3RpbmN0IGBPYnNlcnZhYmxlPFI+YC5cbiAqXG4gKiBAZXhhbXBsZVxuICogLy8gUHJvamVjdCBzdGF0ZSBzbGljZVxuICogY29uc3QgdGV4dCQgPSBzdGF0ZSQucGlwZShcbiAqICAgc2VsZWN0KFxuICogICAgIFsncXVlcnknLCAncmVzdWx0cyddLFxuICogICAgICh7IHF1ZXJ5LCByZXN1bHRzIH0pID0+IGAke3Jlc3VsdHMubGVuZ3RofSByZXN1bHRzIGZvdW5kIGZvciBcIiR7cXVlcnl9XCJgXG4gKiAgIClcbiAqICk7XG4gKlxuICogQHJldHVybiBPYnNlcnZhYmxlPFI+XG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBzZWxlY3Q8VCBleHRlbmRzIG9iamVjdCwgSyBleHRlbmRzIGtleW9mIFQsIFI+KFxuICBrZXlzOiBLW10sXG4gIGZuPzogKHNsaWNlOiBQaWNrU2xpY2U8VCwgSz4pID0+IFIsXG4gIGtleUNvbXBhcmVNYXA/OiBLZXlDb21wYXJlTWFwPFBpY2s8VCwgSz4+LFxuKTogT3BlcmF0b3JGdW5jdGlvbjxULCBSPjtcblxuLyoqXG4gKiBAZGVzY3JpcHRpb25cbiAqIFRyYW5zZm9ybSBhIHNpbmdsZSBwcm9wZXJ0eSBvZiB0aGUgc3RhdGUgYnkgcHJvdmlkaW5nIGEga2V5IGFuZCBtYXAgZnVuY3Rpb24uXG4gKiBSZXR1cm5zIHJlc3VsdCBvZiBhcHBseWluZyBmdW5jdGlvbiB0byBzdGF0ZSBwcm9wZXJ0eSBhcyBjYWNoZWQgYW5kIGRpc3RpbmN0IGBPYnNlcnZhYmxlPFRbUl0+YC5cbiAqXG4gKiBAZXhhbXBsZVxuICogLy8gUHJvamVjdCBzdGF0ZSBiYXNlZCBvbiBzaW5nbGUgcHJvcGVydHlcbiAqIGNvbnN0IGZvbyQgPSBzdGF0ZSQucGlwZShzZWxlY3QoJ2JhcicsIGJhciA9PiBgYmFyIGVxdWFscyAke2Jhcn1gKSk7XG4gKlxuICogQHJldHVybiBPYnNlcnZhYmxlPFI+XG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBzZWxlY3Q8VCwgSyBleHRlbmRzIGtleW9mIFQsIFI+KFxuICBrOiBLLFxuICBmbjogKHZhbDogVFtLXSkgPT4gUixcbik6IE9wZXJhdG9yRnVuY3Rpb248VCwgUj47XG5cbi8qKlxuICogQGRlc2NyaXB0aW9uXG4gKiBBY2Nlc3MgYSBzaW5nbGUgcHJvcGVydHkgb2YgdGhlIHN0YXRlIGJ5IHByb3ZpZGluZyBrZXlzLlxuICogUmV0dXJucyBhIHNpbmdsZSBwcm9wZXJ0eSBvZiB0aGUgc3RhdGUgYXMgY2FjaGVkIGFuZCBkaXN0aW5jdCBgT2JzZXJ2YWJsZTxUW0sxXT5gLlxuICpcbiAqIEBleGFtcGxlXG4gKiAvLyBBY2Nlc3MgYSBzaW5nbGUgcHJvcGVydHlcbiAqIGNvbnN0IGJhciQgPSBzdGF0ZSQucGlwZShzZWxlY3QoJ2JhcicpKTtcbiAqXG4gKiAvLyBBY2Nlc3MgYSBuZXN0ZWQgcHJvcGVydHlcbiAqIGNvbnN0IGZvbyQgPSBzdGF0ZSQucGlwZShzZWxlY3QoJ2JhcicsICdmb28nKSk7XG4gKlxuICogQHJldHVybiBPYnNlcnZhYmxlPFRbSzFdPlxuICovXG5leHBvcnQgZnVuY3Rpb24gc2VsZWN0PFQsIEsxIGV4dGVuZHMga2V5b2YgVD4oXG4gIGsxOiBLMSxcbik6IE9wZXJhdG9yRnVuY3Rpb248VCwgVFtLMV0+O1xuLyoqXG4gKiBAaW50ZXJuYWxcbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIHNlbGVjdDxULCBLMSBleHRlbmRzIGtleW9mIFQsIEsyIGV4dGVuZHMga2V5b2YgVFtLMV0+KFxuICBrMTogSzEsXG4gIGsyOiBLMixcbik6IE9wZXJhdG9yRnVuY3Rpb248VCwgVFtLMV1bSzJdPjtcbi8qKlxuICogQGludGVybmFsXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBzZWxlY3Q8XG4gIFQsXG4gIEsxIGV4dGVuZHMga2V5b2YgVCxcbiAgSzIgZXh0ZW5kcyBrZXlvZiBUW0sxXSxcbiAgSzMgZXh0ZW5kcyBrZXlvZiBUW0sxXVtLMl0sXG4+KGsxOiBLMSwgazI6IEsyLCBrMzogSzMpOiBPcGVyYXRvckZ1bmN0aW9uPFQsIFRbSzFdW0syXVtLM10+O1xuLyoqXG4gKiBAaW50ZXJuYWxcbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIHNlbGVjdDxcbiAgVCxcbiAgSzEgZXh0ZW5kcyBrZXlvZiBULFxuICBLMiBleHRlbmRzIGtleW9mIFRbSzFdLFxuICBLMyBleHRlbmRzIGtleW9mIFRbSzFdW0syXSxcbiAgSzQgZXh0ZW5kcyBrZXlvZiBUW0sxXVtLMl1bSzNdLFxuPihrMTogSzEsIGsyOiBLMiwgazM6IEszLCBrNDogSzQpOiBPcGVyYXRvckZ1bmN0aW9uPFQsIFRbSzFdW0syXVtLM11bSzRdPjtcbi8qKlxuICogQGludGVybmFsXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBzZWxlY3Q8XG4gIFQsXG4gIEsxIGV4dGVuZHMga2V5b2YgVCxcbiAgSzIgZXh0ZW5kcyBrZXlvZiBUW0sxXSxcbiAgSzMgZXh0ZW5kcyBrZXlvZiBUW0sxXVtLMl0sXG4gIEs0IGV4dGVuZHMga2V5b2YgVFtLMV1bSzJdW0szXSxcbiAgSzUgZXh0ZW5kcyBrZXlvZiBUW0sxXVtLMl1bSzNdW0s0XSxcbj4oXG4gIGsxOiBLMSxcbiAgazI6IEsyLFxuICBrMzogSzMsXG4gIGs0OiBLNCxcbiAgazU6IEs1LFxuKTogT3BlcmF0b3JGdW5jdGlvbjxULCBUW0sxXVtLMl1bSzNdW0s0XVtLNV0+O1xuLyoqXG4gKiBAaW50ZXJuYWxcbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIHNlbGVjdDxcbiAgVCxcbiAgSzEgZXh0ZW5kcyBrZXlvZiBULFxuICBLMiBleHRlbmRzIGtleW9mIFRbSzFdLFxuICBLMyBleHRlbmRzIGtleW9mIFRbSzFdW0syXSxcbiAgSzQgZXh0ZW5kcyBrZXlvZiBUW0sxXVtLMl1bSzNdLFxuICBLNSBleHRlbmRzIGtleW9mIFRbSzFdW0syXVtLM11bSzRdLFxuICBLNiBleHRlbmRzIGtleW9mIFRbSzFdW0syXVtLM11bSzRdW0s1XSxcbj4oXG4gIGsxOiBLMSxcbiAgazI6IEsyLFxuICBrMzogSzMsXG4gIGs0OiBLNCxcbiAgazU6IEs1LFxuICBrNjogSzYsXG4pOiBPcGVyYXRvckZ1bmN0aW9uPFQsIFRbSzFdW0syXVtLM11bSzRdW0s1XVtLNl0+O1xuXG4vKipcbiAqIEBpbnRlcm5hbFxuICovXG5leHBvcnQgZnVuY3Rpb24gc2VsZWN0PFQgZXh0ZW5kcyBSZWNvcmQ8c3RyaW5nLCB1bmtub3duPj4oXG4gIC4uLm9wT3JNYXBGbjpcbiAgICB8IE9wZXJhdG9yRnVuY3Rpb248VCwgdW5rbm93bj5bXVxuICAgIHwgc3RyaW5nW11cbiAgICB8IFtrOiBzdHJpbmcsIGZuOiAodmFsOiB1bmtub3duKSA9PiB1bmtub3duXVxuICAgIHwgW1xuICAgICAgICBrZXlzOiBzdHJpbmdbXSxcbiAgICAgICAgZm4/OiAoc2xpY2U6IHVua25vd24pID0+IHVua25vd24sXG4gICAgICAgIGtleUNvbXBhcmVNYXA/OiBLZXlDb21wYXJlTWFwPFQ+LFxuICAgICAgXVxuKTogT3BlcmF0b3JGdW5jdGlvbjxULCB1bmtub3duPiB7XG4gIHJldHVybiAoc3RhdGUkOiBPYnNlcnZhYmxlPFQ+KSA9PiB7XG4gICAgaWYgKCFvcE9yTWFwRm4gfHwgb3BPck1hcEZuLmxlbmd0aCA9PT0gMCkge1xuICAgICAgcmV0dXJuIHN0YXRlJC5waXBlKHN0YXRlZnVsKCkpO1xuICAgIH0gZWxzZSBpZiAoaXNTdHJpbmdBbmRGdW5jdGlvblR1cGxlR3VhcmQob3BPck1hcEZuKSkge1xuICAgICAgcmV0dXJuIHN0YXRlJC5waXBlKHN0YXRlZnVsKG1hcCgocykgPT4gb3BPck1hcEZuWzFdKHNbb3BPck1hcEZuWzBdXSkpKSk7XG4gICAgfSBlbHNlIGlmIChpc1N0cmluZ0FycmF5RnVuY3Rpb25BbmRPcHRpb25hbE9iamVjdFR1cGxlR3VhcmQob3BPck1hcEZuKSkge1xuICAgICAgY29uc3Qgc2VsZWN0ZWRTdGF0ZSQ6IE9ic2VydmFibGU8UGlja1NsaWNlPFQgJiBvYmplY3QsIGtleW9mIFQ+PiA9XG4gICAgICAgIHN0YXRlJC5waXBlKFxuICAgICAgICAgIHNlbGVjdFNsaWNlPFQgJiBvYmplY3QsIGtleW9mIFQ+KFxuICAgICAgICAgICAgb3BPck1hcEZuWzBdIGFzIChrZXlvZiBUKVtdLFxuICAgICAgICAgICAgb3BPck1hcEZuWzJdIGFzIEtleUNvbXBhcmVNYXA8eyBbUCBpbiBrZXlvZiBUXTogKFQgJiBvYmplY3QpW1BdIH0+LFxuICAgICAgICAgICksXG4gICAgICAgICk7XG4gICAgICByZXR1cm4gdHlwZW9mIG9wT3JNYXBGblsxXSA9PT0gJ3VuZGVmaW5lZCdcbiAgICAgICAgPyBzZWxlY3RlZFN0YXRlJFxuICAgICAgICA6IHNlbGVjdGVkU3RhdGUkLnBpcGUoc3RhdGVmdWwobWFwKG9wT3JNYXBGblsxXSkpKTtcbiAgICB9IGVsc2UgaWYgKGlzU3RyaW5nQXJyYXlHdWFyZChvcE9yTWFwRm4pKSB7XG4gICAgICByZXR1cm4gc3RhdGUkLnBpcGUoXG4gICAgICAgIHN0YXRlZnVsKFxuICAgICAgICAgIG1hcCgoc3RhdGUpID0+IG9wT3JNYXBGbi5yZWR1Y2UoKGFjYywga2V5KSA9PiBhY2M/LltrZXldLCBzdGF0ZSkpLFxuICAgICAgICApLFxuICAgICAgKTtcbiAgICB9IGVsc2UgaWYgKGlzT3BlcmF0ZUZuQXJyYXlHdWFyZChvcE9yTWFwRm4pKSB7XG4gICAgICByZXR1cm4gc3RhdGUkLnBpcGUoc3RhdGVmdWwocGlwZUZyb21BcnJheShvcE9yTWFwRm4pKSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignd3JvbmcgcGFyYW1zIHBhc3NlZCB0byBzZWxlY3QnKTtcbiAgICB9XG4gIH07XG59XG4iXX0=